import{b as e}from"./prompts-CKcm-rRX.js";import{a as t}from"./urls-DUfIfy6Z.js";class r extends Error{constructor(e,t,r){super(t),this.code=e,this.details=r,this.name="AppError"}}class o{buildPrompt(t,r){const{page:o,context:n,options:s}=t;return r?r.replace(/\{title\}/g,o.title).replace(/\{url\}/g,o.url).replace(/\{description\}/g,o.description||"无").replace(/\{content\}/g,o.content?.substring(0,500)||"无").replace(/\{existingTags\}/g,n.existingTags.slice(0,100).join(", ")).replace(/\{recentBookmarks\}/g,n.recentBookmarks.slice(0,10).map(e=>`- ${e.title} [${e.tags.join(", ")}]`).join("\n")).replace(/\{maxTags\}/g,s.maxTags.toString()).replace(/\{preferExisting\}/g,s.preferExisting?"优先":"可以"):e(t)}handleError(e,t){if(e instanceof r)return e;if(e instanceof TypeError||e&&"object"==typeof e&&"name"in e&&"NetworkError"===e.name)return new r("NETWORK_ERROR",`Network error when calling ${t}`,{originalError:e});if(e&&"object"==typeof e&&"status"in e){const o=e;if(401===o.status||403===o.status)return new r("API_KEY_INVALID",`Invalid API key for ${t}`,{status:o.status});if(429===o.status)return new r("RATE_LIMIT_ERROR",`Rate limit exceeded for ${t}`,{status:o.status})}const o=e&&"object"==typeof e&&"message"in e?String(e.message):"Unknown error";return new r("AI_SERVICE_ERROR",`AI service error (${t}): ${o}`,{originalError:e})}parseResponse(e){try{const t=e.match(/\{[\s\S]*\}/),r=t?t[0]:e,o=JSON.parse(r);if(!o.suggestedTags||!Array.isArray(o.suggestedTags))throw new Error("Invalid response format: suggestedTags not found");return{suggestedTags:o.suggestedTags.map(e=>{if(!e||"object"!=typeof e)return{name:"",isNew:!0,confidence:.5};const t=e;return{name:"string"==typeof t.name?t.name:"",isNew:"boolean"!=typeof t.isNew||t.isNew,confidence:"number"==typeof t.confidence?t.confidence:.5}}),reasoning:o.reasoning,translatedTitle:o.translatedTitle,translatedDescription:o.translatedDescription}}catch(t){throw new r("AI_SERVICE_ERROR","Failed to parse AI response",{content:e,error:t})}}}const n="你是一个智能书签标签推荐助手。优先使用已有标签,只有在必要时才建议新标签。返回格式必须是JSON。",s=e=>{if(!e||"object"!=typeof e)return;const t=e,r=t.choices;if(!Array.isArray(r)||0===r.length)return;const o=r[0];if(!o||"object"!=typeof o)return;const n=o.message;if(!n||"object"!=typeof n)return;const s=n,a=s.content;if("string"==typeof a)return a.trim();if(Array.isArray(a)){const e=a.map(e=>{if(!e)return"";if("string"==typeof e)return e;if("object"==typeof e){const t=e;if("string"==typeof t.text)return t.text;if("string"==typeof t.content)return t.content;if("string"==typeof t.value)return t.value;if(t.text&&"object"==typeof t.text){const e=t.text;if("string"==typeof e.value)return e.value}}return""}).filter(Boolean).join("\n").trim();if(e)return e}if("string"==typeof s.text)return s.text.trim();if("string"==typeof t.output_text)return t.output_text.trim();if(t.output&&"object"==typeof t.output){const e=t.output;if("string"==typeof e.text)return e.text.trim()}},a=(e,t)=>{const r=e.trim();if(!r)return t;if(r.includes(t))return r;return`${r.replace(/\/$/,"")}${t.startsWith("/")?t:`/${t}`}`},i=(e,t,r)=>{const{apiKey:o,apiUrl:s,model:i,prompt:p,temperature:l,maxTokens:c}=t;let u=s?.trim()||e;u=u.replace(/\/$/,"");const d=a(u,"/chat/completions"),m={"Content-Type":"application/json"};o&&(m.Authorization=`Bearer ${o}`);const f={model:i,messages:[{role:"system",content:n},{role:"user",content:p}],temperature:"number"==typeof l?l:.7,max_tokens:c??r?.defaultMaxTokens??500};return r?.includeJsonResponseFormat&&(f.response_format={type:"json_object"}),r?.additionalBody&&Object.assign(f,r.additionalBody),{url:d,headers:m,body:f,maxTokens:f.max_tokens}},p={openai:{defaultBaseUrl:t.OPENAI,buildRequest:e=>i(t.OPENAI,e,{includeJsonResponseFormat:!0,defaultMaxTokens:500}),extractContent:s},claude:{defaultBaseUrl:t.CLAUDE,buildRequest:e=>{const r=e.apiUrl?.trim()||t.CLAUDE,o=a(r,"/messages"),s={"Content-Type":"application/json","x-api-key":e.apiKey,"anthropic-version":"2023-06-01"},i={model:e.model,system:n,max_tokens:e.maxTokens??1024,temperature:"number"==typeof e.temperature?e.temperature:.7,messages:[{role:"user",content:[{type:"text",text:e.prompt}]}]};return{url:o,headers:s,body:i,maxTokens:i.max_tokens}},extractContent:e=>{const t=e?.content;return Array.isArray(t)&&"text"===t[0]?.type&&"string"==typeof t[0]?.text?t[0].text.trim():"string"==typeof e?.output_text?e.output_text.trim():void 0}},deepseek:{defaultBaseUrl:t.DEEPSEEK,buildRequest:e=>i(t.DEEPSEEK,e,{includeJsonResponseFormat:!0,defaultMaxTokens:500}),extractContent:s},zhipu:{defaultBaseUrl:t.ZHIPU,buildRequest:e=>i(t.ZHIPU,e,{defaultMaxTokens:500}),extractContent:s},modelscope:{defaultBaseUrl:t.MODELSCOPE,buildRequest:e=>i(t.MODELSCOPE,e,{defaultMaxTokens:500,additionalBody:{result_format:"message"}}),extractContent:s},siliconflow:{defaultBaseUrl:t.SILICONFLOW,buildRequest:e=>i(t.SILICONFLOW,e,{defaultMaxTokens:500,additionalBody:{stream:!1}}),extractContent:s},iflow:{defaultBaseUrl:t.IFLOW,buildRequest:e=>i(t.IFLOW,e,{defaultMaxTokens:1e3}),extractContent:s},custom:{defaultBaseUrl:t.OPENAI,buildRequest:e=>i(e.apiUrl?.trim()||t.OPENAI,e,{defaultMaxTokens:500}),extractContent:s}};async function l(e){const t=p[e.provider];if(!t)throw new Error(`Unsupported AI provider: ${e.provider}`);const{url:r,headers:o,body:n}=t.buildRequest(e),s=await fetch(r,{method:"POST",headers:o,body:JSON.stringify(n)});if(!s.ok){let e;try{e=await s.text()}catch(l){e=l.message||"Unknown error"}throw new Error(`AI API 请求失败 (${s.status}): ${e.substring(0,200)}`)}const a=await s.json(),i=t.extractContent(a);if(!i)throw new Error(`AI 响应格式错误: ${JSON.stringify(a).substring(0,200)}`);return{content:i,raw:a}}class c extends o{name="openai";models=["gpt-4o","gpt-4o-mini","gpt-4-turbo","gpt-3.5-turbo"];async generateTags(e,t,r="gpt-4o",o,n){try{const s=this.buildPrompt(e,n),{content:a}=await l({provider:"openai",apiKey:t,apiUrl:o,model:r,prompt:s,maxTokens:500,temperature:.7});return this.parseResponse(a)}catch(s){throw this.handleError(s,"OpenAI")}}}class u extends o{name="claude";models=["claude-3-5-sonnet-20241022","claude-3-5-haiku-20241022","claude-3-opus-20240229"];async generateTags(e,t,r="claude-3-5-sonnet-20241022",o,n){try{const s=this.buildPrompt(e,n),{content:a}=await l({provider:"claude",apiKey:t,apiUrl:o,model:r,prompt:s,maxTokens:1024,temperature:.7});return this.parseResponse(a)}catch(s){throw this.handleError(s,"Claude")}}}class d extends o{name="deepseek";models=["deepseek-chat","deepseek-reasoner"];async generateTags(e,t,r="deepseek-chat",o,n){try{const s=this.buildPrompt(e,n),{content:a}=await l({provider:"deepseek",apiKey:t,apiUrl:o,model:r,prompt:s,maxTokens:500,temperature:.7});return this.parseResponse(a)}catch(s){throw this.handleError(s,"DeepSeek")}}}class m extends o{name="zhipu";models=["glm-4-plus","glm-4-flash","glm-4-air","glm-4"];async generateTags(e,t,r="glm-4-flash",o,n){try{const s=this.buildPrompt(e,n),{content:a}=await l({provider:"zhipu",apiKey:t,apiUrl:o,model:r,prompt:s,maxTokens:500,temperature:.7});return this.parseResponse(a)}catch(s){throw this.handleError(s,"ZhipuAI")}}}class f extends o{name="modelscope";models=["qwen-plus","qwen-turbo","qwen-max","qwen2.5-72b-instruct"];async generateTags(e,t,r="qwen-turbo",o,n){try{const s=this.buildPrompt(e,n),{content:a}=await l({provider:"modelscope",apiKey:t,apiUrl:o,model:r,prompt:s,maxTokens:500,temperature:.7});return this.parseResponse(a)}catch(s){throw this.handleError(s,"ModelScope")}}}class g extends o{name="siliconflow";models=["deepseek-ai/DeepSeek-V3","Qwen/Qwen2.5-7B-Instruct","Qwen/Qwen2.5-72B-Instruct","THUDM/glm-4-9b-chat","meta-llama/Meta-Llama-3.1-8B-Instruct"];async generateTags(e,t,r="Qwen/Qwen2.5-7B-Instruct",o,n){try{const s=this.buildPrompt(e,n),{content:a}=await l({provider:"siliconflow",apiKey:t,apiUrl:o,model:r,prompt:s,maxTokens:500,temperature:.7});return this.parseResponse(a)}catch(s){throw this.handleError(s,"SiliconFlow")}}}class h extends o{name="iflow";models=["TBStars2-200B-A13B","TBStars2-70B-A7B"];async generateTags(e,t,r="TBStars2-200B-A13B",o,n){try{const s=this.buildPrompt(e,n),{content:a}=await l({provider:"iflow",apiKey:t,apiUrl:o,model:r,prompt:s,maxTokens:1e3,temperature:.7});return this.parseResponse(a)}catch(s){throw this.handleError(s,"iFlow")}}}class y extends o{name="custom";models=["custom-model"];async generateTags(e,t,r="gpt-4o",o,n){try{if(!o)throw new Error("自定义 AI 需要配置 API 地址");const s=this.buildPrompt(e,n),{content:a}=await l({provider:"custom",apiKey:t,apiUrl:o,model:r,prompt:s,maxTokens:500,temperature:.7});return this.parseResponse(a)}catch(s){throw this.handleError(s,"Custom")}}}const w=new Map([["openai",new c],["claude",new u],["deepseek",new d],["zhipu",new m],["modelscope",new f],["siliconflow",new g],["iflow",new h],["custom",new y]]);function x(e){const t=w.get(e);if(!t)throw new Error(`Unknown AI provider: ${e}`);return t}const b=Object.freeze(Object.defineProperty({__proto__:null,AIProvider:o,ClaudeProvider:u,CustomProvider:y,DeepSeekProvider:d,IFlowProvider:h,ModelScopeProvider:f,OpenAIProvider:c,SiliconFlowProvider:g,ZhipuProvider:m,getAIProvider:x},Symbol.toStringTag,{value:"Module"}));export{r as A,l as c,x as g,b as i};
