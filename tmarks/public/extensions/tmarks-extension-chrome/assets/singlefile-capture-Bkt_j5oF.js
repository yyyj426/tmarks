const t={inlineCSS:!0,inlineImages:!0,inlineFonts:!1,removeScripts:!0,removeHiddenElements:!1,maxImageSize:5242880,timeout:3e4};async function e(e={}){const r={...t,...e};try{const t=document.cloneNode(!0);r.inlineCSS&&await async function(t,e){const o=Array.from(t.querySelectorAll('link[rel="stylesheet"]')),r=Date.now();for(const i of o){if(Date.now()-r>e)break;try{const e=i.href;if(!e||e.startsWith("data:"))continue;const o=await fetch(e);if(!o.ok)continue;const r=await o.text(),a=await n(r,e),c=t.createElement("style");c.setAttribute("data-original-href",e),c.textContent=a,i.replaceWith(c)}catch(c){}}const a=Array.from(t.querySelectorAll("style"));for(const i of a)i.textContent&&(i.textContent=await n(i.textContent,document.baseURI))}(t,r.timeout),r.inlineImages&&await async function(t,e,n){const r=Array.from(t.querySelectorAll("img[src]")),a=Date.now();for(const i of r){if(Date.now()-a>n)break;try{const t=i.src;if(!t)continue;if(t.startsWith("data:"))continue;const n=await fetch(t);if(!n.ok)continue;const r=await n.blob();if(r.size>e)continue;const a=await o(r);i.src=a,i.setAttribute("data-original-src",t)}catch(c){}}}(t,r.maxImageSize,r.timeout),r.inlineFonts&&await async function(t,e){const n=Array.from(t.querySelectorAll("style")),r=Date.now();for(const c of n){if(Date.now()-r>e)break;if(!c.textContent)continue;const t=/@font-face\s*{[^}]*}/g,n=Array.from(c.textContent.matchAll(t));for(const e of n){const t=e[0].match(/url\(['"]?([^'")\s]+)['"]?\)/);if(t&&t[1]){const e=t[1];if(e.startsWith("data:"))continue;try{const t=new URL(e,document.baseURI).href,n=await fetch(t);if(!n.ok)continue;const r=await n.blob(),a=await o(r);c.textContent=c.textContent.replace(e,a)}catch(a){}}}}}(t,r.timeout),r.removeScripts&&function(t){const e=Array.from(t.querySelectorAll("script"));e.forEach(t=>t.remove())}(t),r.removeHiddenElements&&function(t){const e=Array.from(t.querySelectorAll("*"));for(const n of e){const t=window.getComputedStyle(n);"none"!==t.display&&"hidden"!==t.visibility||n.remove()}}(t),function(t){const e=t.createElement("meta");e.setAttribute("name","tmarks-snapshot"),e.setAttribute("content",JSON.stringify({capturedAt:(new Date).toISOString(),originalUrl:document.location.href,title:document.title,userAgent:navigator.userAgent}));const n=t.querySelector("head");n&&n.appendChild(e)}(t);return t.documentElement.outerHTML}catch(a){throw a}}async function n(t,e){const n=Array.from(t.matchAll(/url\(['"]?([^'")\s]+)['"]?\)/g));let r=t;for(const c of n){const t=c[1];if(!t.startsWith("data:"))try{const n=new URL(t,e).href,a=await fetch(n);if(a.ok){const t=await a.blob();if(t.size<102400){const e=await o(t);r=r.replace(c[0],`url(${e})`);continue}}r=r.replace(c[0],`url(${n})`)}catch(a){}}return r}function o(t){return new Promise((e,n)=>{const o=new FileReader;o.onloadend=()=>e(o.result),o.onerror=n,o.readAsDataURL(t)})}export{e as capturePage};
