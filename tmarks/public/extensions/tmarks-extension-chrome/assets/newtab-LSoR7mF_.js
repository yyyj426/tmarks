import"./modulepreload-polyfill-YP0FEG5d.js";import{r as e,o as t,k as r,p as s,S as o,B as n,q as a,M as i,t as l,D as c,W as d,E as u,v as m,w as h,x as p,T as x,y as g,z as f,A as w,I as b,P as k,G as v,X as y,H as j,J as I,N,O as C,F as S,Q as B,U as F,e as D,V as E,Y as G,C as T,Z as z,_ as L,$ as A,a0 as M,a1 as R,a2 as $,a3 as P,a4 as O,a5 as _,a6 as U,a7 as W,a8 as H,a9 as K,aa as Y,ab as X,ac as q,ad as V,ae as J,af as Q,ag as Z,ah as ee,ai as te,aj as re,ak as se,al as oe,am as ne,an as ae,ao as ie,ap as le,aq as ce,ar as de,as as ue,at as me,au as he,av as pe,n as xe,R as ge}from"./react-vendor-1ZtHTM4k.js";import{D as fe,a as we,S as be,b as ke,F as ve,H as ye,c as je,U as Ie,G as Ne}from"./constants-LJ5_wtHo.js";import{S as Ce,g as Se}from"./urls-DUfIfy6Z.js";import{_ as Be}from"./preload-helper-BhLMWRjL.js";import{c as Fe}from"./index-3rMDm5L8.js";import{l as De}from"./vendor-BSnXPJO2.js";import{S as Ee,r as Ge,u as Te,s as ze,h as Le}from"./dnd-kit-BEjcDWqN.js";import{a as Ae}from"./newtabPrompts-Br339DSM.js";import"./dexie-BAhLzSXZ.js";const Me=()=>`${Date.now()}-${Math.random().toString(36).slice(2,9)}`,Re=()=>"undefined"!=typeof chrome&&!!chrome.bookmarks;function $e(e,t,r){let s=e;const o=new Set,n=[];let a=!1;for(;;){const e=new Map;for(const r of s)r.parentId&&e.set(r.parentId,(e.get(r.parentId)??0)+1);const t=new Set;for(const o of s){if("bookmarkFolder"!==o.type)continue;if(0!==(e.get(o.id)??0))continue;if(!("home"===(o.groupId??"home")&&null===(o.parentId??null))){if(o.browserBookmarkId){if(r.has(o.browserBookmarkId))continue;n.push(o.browserBookmarkId)}t.add(o.id)}}if(0===t.size)break;a=!0,t.forEach(e=>o.add(e)),s=s.filter(e=>!t.has(e.id))}if(!a)return{items:e,currentFolderId:t,changed:!1,removedBrowserBookmarkIds:[]};const i=new Map;s.forEach(e=>{const t=`${e.groupId??"home"}|${e.parentId??"root"}`;i.has(t)||i.set(t,[]),i.get(t).push(e)});const l=new Map;i.forEach(e=>{e.sort((e,t)=>e.position-t.position),e.forEach((e,t)=>{l.set(e.id,t)})});return{items:s.map(e=>{const t=l.get(e.id);return void 0!==t&&t!==e.position?{...e,position:t}:e}),currentFolderId:t&&o.has(t)?null:t,changed:!0,removedBrowserBookmarkIds:n}}let Pe=null;function Oe(e){Pe&&clearTimeout(Pe),Pe=setTimeout(()=>{!async function(e){try{const t=await Ce.getBookmarkSiteApiUrl(),r=await Ce.getBookmarkSiteApiKey();if(!r)return;const s=t?.endsWith("/api")?t:Se(t||void 0).API_BASE,o=e.gridItems.filter(e=>"shortcut"===e.type&&e.shortcut?.url).map(e=>({id:e.id,title:e.shortcut.title,url:e.shortcut.url,group_id:e.groupId,position:e.position}));(await fetch(`${s}/tab/newtab/sync`,{method:"POST",headers:{"Content-Type":"application/json","X-API-Key":r},body:JSON.stringify({groups:e.groups.map((e,t)=>({id:e.id,name:e.name,position:e.position??t})),shortcuts:o})})).ok}catch(t){}}(e)},2e3)}const _e={shortcut:{type:"shortcut",name:"快捷方式",icon:"Link",description:"网站快捷方式",sizeConfig:{type:"shortcut",defaultSize:"1x1",allowedSizes:["1x1"],minWidth:1,minHeight:1}},bookmarkFolder:{type:"bookmarkFolder",name:"文件夹",icon:"Folder",description:"用于组织书签与快捷方式",sizeConfig:{type:"bookmarkFolder",defaultSize:"1x1",allowedSizes:["1x1"],minWidth:1,minHeight:1}},weather:{type:"weather",name:"天气",icon:"Cloud",description:"显示当前天气和未来预报",sizeConfig:{type:"weather",defaultSize:"2x2",allowedSizes:["2x1","2x2","2x3"],minWidth:2,minHeight:1}},clock:{type:"clock",name:"时钟",icon:"Clock",description:"显示当前时间",sizeConfig:{type:"clock",defaultSize:"2x1",allowedSizes:["2x1","2x2"],minWidth:2,minHeight:1}},todo:{type:"todo",name:"待办事项",icon:"CheckSquare",description:"管理待办任务",sizeConfig:{type:"todo",defaultSize:"2x2",allowedSizes:["2x2","2x3","2x4"],minWidth:2,minHeight:2}},notes:{type:"notes",name:"备忘录",icon:"StickyNote",description:"快速记录笔记",sizeConfig:{type:"notes",defaultSize:"2x2",allowedSizes:["2x2","2x3","2x4"],minWidth:2,minHeight:2}},hotsearch:{type:"hotsearch",name:"热搜",icon:"TrendingUp",description:"显示热门搜索",sizeConfig:{type:"hotsearch",defaultSize:"2x3",allowedSizes:["2x2","2x3","2x4"],minWidth:2,minHeight:2}},poetry:{type:"poetry",name:"每日诗词",icon:"BookOpen",description:"显示每日诗词",sizeConfig:{type:"poetry",defaultSize:"2x1",allowedSizes:["2x1","2x2"],minWidth:2,minHeight:1}}};function Ue(e){const[t,r]=e.split("x").map(Number);return{cols:t,rows:r}}async function We(){try{const e=await Ce.getTMarksConfig();return e?.bookmarkApiUrl&&e?.bookmarkApiKey?Fe({baseUrl:e.bookmarkApiUrl,apiKey:e.bookmarkApiKey}):null}catch{return null}}function He(e,t,r){return{addGridItem:(s,o={})=>{const{shortcutGroups:n,gridItems:a,activeGroupId:i,currentFolderId:l,saveData:c}=t(),d=function(e){return _e[e]}(s),u=function(e){switch(e){case"weather":return{weather:{city:"北京",unit:"C",showForecast:!0,autoLocation:!1}};case"clock":return{clock:{format:"24h",showDate:!0,showSeconds:!1,showLunar:!1}};case"todo":return{todo:{showCompleted:!1}};case"notes":return{notes:{content:""}};case"hotsearch":return{hotsearch:{type:"baidu"}};case"poetry":return{poetry:{autoRefresh:!0}};default:return{}}}(s),m=o.groupId??i??"home",h=o.parentId??l??null,p=a.filter(e=>(e.groupId??"home")===m&&(e.parentId??null)===h),x=p.length>0?Math.max(...p.map(e=>e.position)):-1,g={id:Me(),type:s,size:o.size||d.sizeConfig.defaultSize,position:x+1,groupId:m,parentId:h??void 0,shortcut:o.shortcut,bookmarkFolder:o.bookmarkFolder,config:"shortcut"!==s?u:void 0,createdAt:Date.now()},f=[...a,g];e({gridItems:f}),c(),Oe({groups:n,gridItems:f});const{isApplyingBrowserBookmarks:w}=t();w||"shortcut"!==s&&"bookmarkFolder"!==s||(async()=>{try{const o=t(),n=await r({parentGridId:g.parentId??null,inferredGroupId:g.groupId??null});if(!n)return;if(o.setBrowserBookmarkWriteLockUntil(Date.now()+800),"bookmarkFolder"===s){const r=await chrome.bookmarks.create({parentId:n,title:g.bookmarkFolder?.title||"文件夹"});e({gridItems:t().gridItems.map(e=>e.id===g.id?{...e,browserBookmarkId:r.id}:e)}),o.saveData()}if("shortcut"===s&&g.shortcut?.url){const r=await chrome.bookmarks.create({parentId:n,title:g.shortcut.title,url:g.shortcut.url});e({gridItems:t().gridItems.map(e=>e.id===g.id?{...e,browserBookmarkId:r.id}:e)}),o.saveData();(async function(e){if("shortcut"!==e.type||!e.shortcut?.url)return{success:!1,error:"Not a shortcut item"};const t=await We();if(!t)return{success:!0};try{return{success:!0,tmarksBookmarkId:(await t.bookmarks.createBookmark({title:e.shortcut.title,url:e.shortcut.url,tags:[]})).data.bookmark.id}}catch(r){return{success:!1,error:r instanceof Error?r.message:"同步失败"}}})({...g,browserBookmarkId:r.id}).then(r=>{r.success&&r.tmarksBookmarkId&&(e({gridItems:t().gridItems.map(e=>e.id===g.id?{...e,tmarksBookmarkId:r.tmarksBookmarkId}:e)}),o.saveData())}).catch(e=>{})}}catch(o){}})(),"shortcut"===s&&o.shortcut?.url&&(async()=>{try{const{downloadFavicon:e}=await Be(async()=>{const{downloadFavicon:e}=await Promise.resolve().then(()=>er);return{downloadFavicon:e}},void 0),r=await e(o.shortcut.url);if(r){const{updateGridItem:e}=t();e(g.id,{shortcut:{...o.shortcut,faviconBase64:r}})}}catch(e){}})()},updateGridItem:(r,s)=>{const{shortcutGroups:o,gridItems:n,saveData:a}=t(),i=n.map(e=>e.id===r?{...e,...s}:e);e({gridItems:i}),a(),Oe({groups:o,gridItems:i});const{isApplyingBrowserBookmarks:l}=t(),c=n.find(e=>e.id===r);!l&&c?.browserBookmarkId&&("bookmarkFolder"===c.type&&s.bookmarkFolder?.title&&(async()=>{try{t().setBrowserBookmarkWriteLockUntil(Date.now()+800),await chrome.bookmarks.update(c.browserBookmarkId,{title:s.bookmarkFolder.title})}catch(e){}})(),"shortcut"===c.type&&s.shortcut&&(async()=>{try{t().setBrowserBookmarkWriteLockUntil(Date.now()+800),await chrome.bookmarks.update(c.browserBookmarkId,{title:s.shortcut?.title,url:s.shortcut?.url})}catch(e){}})())},removeGridItem:r=>{const{shortcutGroups:s,gridItems:o,currentFolderId:n,saveData:a,browserBookmarksRootId:i}=t(),l=o.find(e=>e.id===r);if(!l)return;let c=new Set([r]);if("bookmarkFolder"===l.type){let e=!0;for(;e;){e=!1;for(const t of o){const r=t.parentId;r&&c.has(r)&&!c.has(t.id)&&(c.add(t.id),e=!0)}}}const d=o.filter(e=>!c.has(e.id)),u=l.groupId??"home",m=l.parentId??null,h=d.filter(e=>(e.groupId??"home")===u&&(e.parentId??null)===m).sort((e,t)=>e.position-t.position),p=new Map(h.map((e,t)=>[e.id,t])),x=$e(d.map(e=>{const t=p.get(e.id);return void 0===t?e:{...e,position:t}}),n&&c.has(n)?null:n,new Set([i].filter(Boolean)));e({gridItems:x.items,currentFolderId:x.currentFolderId}),a(),Oe({groups:s,gridItems:x.items});const{isApplyingBrowserBookmarks:g}=t();if(!g){const e=[];for(const t of o)c.has(t.id)&&t.browserBookmarkId&&e.push(t.browserBookmarkId);e.length>0&&(async()=>{try{t().setBrowserBookmarkWriteLockUntil(Date.now()+1200);for(const t of e)try{await chrome.bookmarks.removeTree(t)}catch{try{await chrome.bookmarks.remove(t)}catch{}}}catch(r){}})()}t().cleanupEmptyGroups()},removeGridFolder:(r,s)=>{const{shortcutGroups:o,gridItems:n,currentFolderId:a,saveData:i}=t(),l=n.find(e=>e.id===r);if(!l||"bookmarkFolder"!==l.type)return;if("all"===s)return void t().removeGridItem(r);const c=l.groupId??"home",d=l.parentId??null,u=new Set([r]);let m=!0;for(;m;){m=!1;for(const e of n)"bookmarkFolder"===e.type&&e.parentId&&u.has(e.parentId)&&!u.has(e.id)&&(u.add(e.id),m=!0)}const h=n.filter(e=>e.parentId&&u.has(e.parentId)).sort((e,t)=>e.position-t.position),p=n.filter(e=>!u.has(e.id)),x=p.filter(e=>(e.groupId??"home")===c&&(e.parentId??null)===d).sort((e,t)=>e.position-t.position),g=new Map(h.map((e,t)=>[e.id,{parentId:d??void 0,position:x.length+t}])),f=p.map(e=>{const t=g.get(e.id);return t?{...e,parentId:t.parentId,position:t.position}:e}),w=f.filter(e=>(e.groupId??"home")===c&&(e.parentId??null)===d).sort((e,t)=>e.position-t.position),b=new Map(w.map((e,t)=>[e.id,t])),k=$e(f.map(e=>{const t=b.get(e.id);return void 0===t?e:{...e,position:t}}),a&&u.has(a)?null:a,new Set);e({gridItems:k.items,currentFolderId:k.currentFolderId}),i(),Oe({groups:o,gridItems:k.items});const v=t();!v.isApplyingBrowserBookmarks&&k.removedBrowserBookmarkIds.length>0&&(async()=>{try{v.setBrowserBookmarkWriteLockUntil(Date.now()+1200);for(const e of k.removedBrowserBookmarkIds)try{await chrome.bookmarks.removeTree(e)}catch{try{await chrome.bookmarks.remove(e)}catch{}}}catch{}})(),t().cleanupEmptyGroups()},reorderGridItems:(r,s)=>{const{shortcutGroups:o,gridItems:n,saveData:a}=t(),i=[...n],[l]=i.splice(r,1);i.splice(s,0,l);const c=i.map((e,t)=>({...e,position:t}));e({gridItems:c}),a(),Oe({groups:o,gridItems:c})},getFilteredGridItems:()=>{const{gridItems:e,activeGroupId:r,currentFolderId:s}=t(),o=r??"home",n=s?e.find(e=>e.id===s):null;return s?!!n?.browserBookmarkId?e.filter(e=>{const t=(e.parentId??null)===(s??null);return!!e.browserBookmarkId&&t}).sort((e,t)=>e.position-t.position):e.filter(e=>{const t=(e.groupId??"home")===o,r=(e.parentId??null)===(s??null);return t&&r}).sort((e,t)=>e.position-t.position):e.filter(e=>{const t=(e.groupId??"home")===o,r=null===(e.parentId??null);return t&&r}).sort((e,t)=>e.position-t.position)}}}function Ke(e,t,r,s){return{setBrowserBookmarksRootId:t=>{e(e=>({browserBookmarksRootId:t,homeBrowserFolderId:t?e.homeBrowserFolderId:null}))},setHomeBrowserFolderId:t=>{e({homeBrowserFolderId:t})},setGroupBookmarkFolderId:(r,s)=>{const{shortcutGroups:o,gridItems:n,saveData:a}=t(),i=o.map(e=>e.id===r?{...e,bookmarkFolderId:s??void 0}:e);e({shortcutGroups:i}),a(),Oe({groups:i,gridItems:n})},setIsApplyingBrowserBookmarks:t=>{e({isApplyingBrowserBookmarks:t})},setBrowserBookmarkWriteLockUntil:t=>{e({browserBookmarkWriteLockUntil:t})},replaceBrowserBookmarkGridItems:(r,s)=>{const{gridItems:o,saveData:n}=t(),a=Array.from(new Set(r.map(e=>e.groupId??"home"))),i=new Set(s?.groupIds&&s.groupIds.length>0?s.groupIds:a),l=[...o.filter(e=>{if(!e.browserBookmarkId)return!0;if(0===i.size)return!1;const t=e.groupId??"home";return!i.has(t)}),...r.map(e=>({...e,parentId:e.parentId??null,groupId:e.groupId??"home"}))];e({gridItems:l}),n(),t().cleanupEmptyGroups()},upsertBrowserBookmarkNode:o=>{const{gridItems:n,saveData:a,browserBookmarksRootId:i}=t();if(!i)return;const l=`bb-${o.id}`,c=n.find(e=>e.id===l),d=o.parentId,u=r(d);let m;d&&(m=s(d)?null:d===i?void 0:`bb-${d}`);const h="number"==typeof o.index?o.index:c?.position??0,p={id:l,type:o.url?"shortcut":"bookmarkFolder",size:c?.size??"1x1",position:h,groupId:u,parentId:m,browserBookmarkId:o.id,shortcut:o.url?{url:o.url,title:o.title||o.url,favicon:c?.shortcut?.favicon,faviconBase64:c?.shortcut?.faviconBase64}:void 0,bookmarkFolder:o.url?void 0:{title:o.title||c?.bookmarkFolder?.title||"文件夹"},config:c?.config,createdAt:c?.createdAt??Date.now()},x=[...n.filter(e=>!e.browserBookmarkId),...n.filter(e=>e.browserBookmarkId&&e.id!==l),p];e({gridItems:x}),a()},removeBrowserBookmarkById:r=>{const{gridItems:s,currentFolderId:o,saveData:n,browserBookmarksRootId:a}=t(),i=`bb-${r}`,l=s.find(e=>e.id===i);if(!l)return;let c=new Set([i]);if("bookmarkFolder"===l.type){let e=!0;for(;e;){e=!1;for(const t of s){const r=t.parentId;r&&c.has(r)&&!c.has(t.id)&&(c.add(t.id),e=!0)}}}const d=[];for(const e of s)c.has(e.id)&&e.tmarksBookmarkId&&d.push(e.tmarksBookmarkId);const u=$e(s.filter(e=>!c.has(e.id)),o&&c.has(o)?null:o,new Set([a].filter(Boolean)));e({gridItems:u.items,currentFolderId:u.currentFolderId}),n(),d.length>0&&async function(e){if(0===e.length)return{success:!0};const t=await We();if(!t)return{success:!0};const r=[];for(const o of e)try{await t.bookmarks.trashBookmark(o)}catch(s){r.push(`${o}: ${s instanceof Error?s.message:"未知错误"}`)}return r.length>0?{success:!1,error:`部分书签删除失败: ${r.join(", ")}`}:{success:!0}}(d).catch(e=>{}),t().cleanupEmptyGroups()},applyBrowserBookmarkChildrenOrder:(r,s)=>{const{gridItems:o,saveData:n}=t(),a=new Map(s.map((e,t)=>[`bb-${e}`,t])),i=o.map(e=>{const t=a.get(e.id);return void 0!==t?{...e,position:t}:e});e({gridItems:i}),n()}}}function Ye(e,t,r){return{setCurrentFolderId:t=>{e({currentFolderId:t})},moveGridItemToFolder:(s,o)=>{const{shortcutGroups:n,gridItems:a,saveData:i,browserBookmarksRootId:l}=t(),c=a.find(e=>e.id===s);if(!c)return;const d=e=>{if(!e)return 0;const t=a.find(t=>t.id===e);return t?1+d(t.parentId??null):0},u=d(o),m=e=>{const t=a.filter(t=>t.parentId===e);return 0===t.length?0:1+Math.max(...t.map(e=>m(e.id)))};if(u+1+("bookmarkFolder"===c.type?m(c.id):0)>5)return;const h=o??null,p=!!c.browserBookmarkId,x=(()=>{if(p)return c.groupId??"home";const e=t().activeGroupId??"home",r=o?a.find(e=>e.id===o):null,s=c.parentId?a.find(e=>e.id===c.parentId):null;return r?.groupId??s?.groupId??c.groupId??e})(),g=a.filter(e=>e.id!==s&&((e.parentId??null)===h&&(p?!!e.browserBookmarkId:!e.browserBookmarkId&&(e.groupId??"home")===x))).sort((e,t)=>e.position-t.position).length,f=a.map(e=>e.id!==s?e:{...e,groupId:x,parentId:h??void 0,position:g}),w=new Set([l].filter(Boolean)),b=$e(f,t().currentFolderId,w);e({gridItems:b.items,currentFolderId:b.currentFolderId}),i(),Oe({groups:n,gridItems:b.items});const k=t();!k.isApplyingBrowserBookmarks&&b.removedBrowserBookmarkIds.length>0&&(async()=>{try{k.setBrowserBookmarkWriteLockUntil(Date.now()+1200);for(const e of b.removedBrowserBookmarkIds)try{await chrome.bookmarks.removeTree(e)}catch{try{await chrome.bookmarks.remove(e)}catch{}}}catch{}})(),p||"home"!==x||null!==h||t().mirrorHomeItemsToBrowser([s]),t().cleanupEmptyGroups();const v=t();!v.isApplyingBrowserBookmarks&&c.browserBookmarkId&&(async()=>{try{const e=await r({parentGridId:o,inferredGroupId:x});if(!e)return;v.setBrowserBookmarkWriteLockUntil(Date.now()+800),await chrome.bookmarks.move(c.browserBookmarkId,{parentId:e,index:g})}catch(e){}})()},reorderGridItemsInCurrentScope:(s,o)=>{const{shortcutGroups:n,gridItems:a,activeGroupId:i,currentFolderId:l,saveData:c}=t(),d=i??"home",u=a.filter(e=>(e.groupId??"home")===d&&(e.parentId??null)===(l??null)).sort((e,t)=>e.position-t.position),m=u.findIndex(e=>e.id===s),h=u.findIndex(e=>e.id===o);if(-1===m||-1===h||m===h)return;const p=[...u],[x]=p.splice(m,1);p.splice(h,0,x);const g=new Map(p.map((e,t)=>[e.id,t])),f=a.map(e=>{const t=g.get(e.id);return void 0===t?e:{...e,position:t}});e({gridItems:f}),c(),Oe({groups:n,gridItems:f});const w=t(),b=u[m];!w.isApplyingBrowserBookmarks&&b?.browserBookmarkId&&(async()=>{try{const e=await r({parentGridId:w.currentFolderId,inferredGroupId:d});if(!e)return;w.setBrowserBookmarkWriteLockUntil(Date.now()+800),await chrome.bookmarks.move(b.browserBookmarkId,{parentId:e,index:h})}catch(e){}})()},reorderGridItemsInFolderScope:(s,o,n)=>{const{shortcutGroups:a,gridItems:i,saveData:l}=t(),c=i.find(e=>e.id===s);if(!c)return;const d=c.groupId??"home",u=i.filter(e=>(e.groupId??"home")===d&&(e.parentId??null)===s).sort((e,t)=>e.position-t.position),m=u.findIndex(e=>e.id===o),h=u.findIndex(e=>e.id===n);if(-1===m||-1===h||m===h)return;const p=[...u],[x]=p.splice(m,1);p.splice(h,0,x);const g=new Map(p.map((e,t)=>[e.id,t])),f=i.map(e=>{const t=g.get(e.id);return void 0===t?e:{...e,position:t}});e({gridItems:f}),l(),Oe({groups:a,gridItems:f});const w=t(),b=u[m];!w.isApplyingBrowserBookmarks&&b?.browserBookmarkId&&(async()=>{try{const e=await r({parentGridId:s,inferredGroupId:w.gridItems.find(e=>e.id===s)?.groupId??null});if(!e)return;w.setBrowserBookmarkWriteLockUntil(Date.now()+800),await chrome.bookmarks.move(b.browserBookmarkId,{parentId:e,index:h})}catch(e){}})()},mergeFolders:(r,s)=>{const{shortcutGroups:o,gridItems:n,saveData:a,browserBookmarksRootId:i}=t(),l=n.find(e=>e.id===r&&"bookmarkFolder"===e.type),c=n.find(e=>e.id===s&&"bookmarkFolder"===e.type);if(!l||!c)return;if(r===s)return;const d=n.filter(e=>(e.parentId??null)===r).sort((e,t)=>e.position-t.position),u=n.filter(e=>(e.parentId??null)===s).sort((e,t)=>e.position-t.position).length;let m=n.map(e=>{if((e.parentId??null)===r){const t=u+d.findIndex(t=>t.id===e.id);return{...e,parentId:s,groupId:c.groupId??"home",position:t}}return e});m=m.filter(e=>e.id!==r);const h=m.filter(e=>(e.parentId??null)===s).sort((e,t)=>e.position-t.position),p=new Map(h.map((e,t)=>[e.id,t]));m=m.map(e=>{const t=p.get(e.id);return void 0!==t?{...e,position:t}:e});const x=new Set([i].filter(Boolean)),g=$e(m,t().currentFolderId,x);e({gridItems:g.items,currentFolderId:g.currentFolderId}),a(),Oe({groups:o,gridItems:g.items});const f=t();f.isApplyingBrowserBookmarks||(async()=>{try{if(c.browserBookmarkId){f.setBrowserBookmarkWriteLockUntil(Date.now()+2e3);for(let t=0;t<d.length;t++){const r=d[t];if(r.browserBookmarkId)try{await chrome.bookmarks.move(r.browserBookmarkId,{parentId:c.browserBookmarkId,index:u+t})}catch(e){}}}if(l.browserBookmarkId)try{await chrome.bookmarks.removeTree(l.browserBookmarkId)}catch{try{await chrome.bookmarks.remove(l.browserBookmarkId)}catch{}}if(g.removedBrowserBookmarkIds.length>0)for(const e of g.removedBrowserBookmarkIds)try{await chrome.bookmarks.removeTree(e)}catch{try{await chrome.bookmarks.remove(e)}catch{}}}catch(e){}})(),t().cleanupEmptyGroups()},createFolderFromShortcuts:(s,o,n)=>{const{shortcutGroups:a,gridItems:i,saveData:l}=t(),c=i.find(e=>e.id===s),d=i.find(e=>e.id===o);if(!c||!d)return null;if("shortcut"!==c.type||"shortcut"!==d.type)return null;if(s===o)return null;const u=d.groupId??"home",m=d.parentId??null,h=d.position,p=n||"新文件夹",x=Me(),g={id:x,type:"bookmarkFolder",size:"1x1",position:h,groupId:u,parentId:m??void 0,bookmarkFolder:{title:p},createdAt:Date.now()};let f=i.map(e=>e.id===s?{...e,parentId:x,groupId:u,position:0}:e.id===o?{...e,parentId:x,groupId:u,position:1}:e);f=[...f,g];const w=f.filter(e=>(e.groupId??"home")===u&&(e.parentId??null)===m&&e.id!==s&&e.id!==o).sort((e,t)=>e.position-t.position),b=new Map;w.forEach((e,t)=>{e.id===x?b.set(e.id,h):e.position>=h?b.set(e.id,t):b.set(e.id,e.position)});w.sort((e,t)=>(b.get(e.id)??e.position)-(b.get(t.id)??t.position)).forEach((e,t)=>{b.set(e.id,t)}),f=f.map(e=>{const t=b.get(e.id);return void 0!==t?{...e,position:t}:e}),e({gridItems:f}),l(),Oe({groups:a,gridItems:f});const k=t();return k.isApplyingBrowserBookmarks||(async()=>{try{const o=await r({parentGridId:m,inferredGroupId:u});if(o){k.setBrowserBookmarkWriteLockUntil(Date.now()+2e3);const r=await chrome.bookmarks.create({parentId:o,title:p,index:h});if(e({gridItems:t().gridItems.map(e=>e.id===x?{...e,browserBookmarkId:r.id}:e)}),k.saveData(),c.browserBookmarkId)try{await chrome.bookmarks.move(c.browserBookmarkId,{parentId:r.id,index:0})}catch(s){}if(d.browserBookmarkId)try{await chrome.bookmarks.move(d.browserBookmarkId,{parentId:r.id,index:1})}catch(s){}}}catch(s){}})(),x},cleanupEmptySecondLevelFolders:()=>{const{gridItems:r,currentFolderId:s,shortcutGroups:o,saveData:n}=t(),{items:a,currentFolderId:i,changed:l}=function(e,t){const r=new Map(e.map(e=>[e.id,e])),s=new Map;for(const l of e)l.parentId&&s.set(l.parentId,(s.get(l.parentId)??0)+1);const o=new Set;for(const l of e){if("bookmarkFolder"!==l.type||l.browserBookmarkId||!l.parentId)continue;const e=r.get(l.parentId);e&&null===(e.parentId??null)&&0===(s.get(l.id)??0)&&o.add(l.id)}if(0===o.size)return{items:e,currentFolderId:t,changed:!1};const n=e.filter(e=>!o.has(e.id)),a=new Map;n.forEach(e=>{const t=`${e.groupId??"home"}|${e.parentId??"root"}`;a.has(t)||a.set(t,[]),a.get(t).push(e)});const i=new Map;return a.forEach(e=>{e.sort((e,t)=>e.position-t.position),e.forEach((e,t)=>{i.set(e.id,t)})}),{items:n.map(e=>{const t=i.get(e.id);return void 0!==t&&t!==e.position?{...e,position:t}:e}),currentFolderId:t&&o.has(t)?null:t,changed:!0}}(r,s);l&&(e({gridItems:a,currentFolderId:i}),n(),Oe({groups:o,gridItems:a}),t().cleanupEmptyGroups())},cleanupAllEmptyFolders:()=>{const{gridItems:r,currentFolderId:s,shortcutGroups:o,saveData:n,browserBookmarksRootId:a}=t(),i=$e(r,s,new Set([a].filter(Boolean)));if(!i.changed)return;e({gridItems:i.items,currentFolderId:i.currentFolderId}),n(),Oe({groups:o,gridItems:i.items});const l=t();!l.isApplyingBrowserBookmarks&&i.removedBrowserBookmarkIds.length>0&&(async()=>{try{l.setBrowserBookmarkWriteLockUntil(Date.now()+1200);for(const e of i.removedBrowserBookmarkIds)try{await chrome.bookmarks.removeTree(e)}catch{try{await chrome.bookmarks.remove(e)}catch{}}}catch{}})(),t().cleanupEmptyGroups()},migrateToGridItems:()=>{}}}const Xe="TMarks",qe="NewTab Home",Ve="tmarks_root_bookmark_id",Je="tmarks_home_bookmark_id",Qe=new Set(["Bookmarks Bar","Bookmarks bar","Bookmarks Toolbar","书签栏","收藏夹栏","Favorites bar","收藏夹"]),Ze=new Set([qe]);function et(){return"undefined"!=typeof chrome&&!!chrome.bookmarks}function tt(e){return!e.url}async function rt(e){if(!et())return null;try{const t=await chrome.bookmarks.get(e);return t?.[0]??null}catch{return null}}async function st(e){if(!et())return[];try{return await chrome.bookmarks.getChildren(e)}catch{return[]}}async function ot(e){if(!et())return null;try{const t=await chrome.bookmarks.getSubTree(e);return t?.[0]??null}catch{return null}}async function nt(e){if(!et())return null;try{return await chrome.bookmarks.create(e)}catch(t){return null}}async function at(e){const t=await rt(e);return t&&!t.url?t:null}async function it(e){try{await chrome.storage.local.set({[Ve]:e})}catch(t){}}async function lt(e){try{await chrome.storage.local.set({[Je]:e})}catch(t){}}async function ct(){if(!et())return null;const e=await async function(){if(!et())return null;try{const e=(await chrome.bookmarks.getTree())[0],t=e.children?.find(e=>"1"===e.id&&!e.url);if(t)return t.id;const r=e.children?.find(e=>!e.url&&Qe.has(e.title));if(r)return r.id;const s=e.children?.find(e=>!e.url);return s?.id??null}catch{return null}}();if(!e)return null;const t=await async function(){try{const e=(await chrome.storage.local.get(Ve))[Ve];return"string"==typeof e?e:null}catch{return null}}();if(t){if(await at(t))return{id:t,wasRecreated:!1}}const r=(await st(e)).find(e=>!e.url&&e.title===Xe);if(r)return await it(r.id),{id:r.id,wasRecreated:!1};const s=await nt({parentId:e,title:Xe});if(!s)return null;await it(s.id);const o=null!==t;return{id:s.id,wasRecreated:o}}async function dt(e){if(!et()||!e)return null;const t=await async function(){try{const e=(await chrome.storage.local.get(Je))[Je];return"string"==typeof e?e:null}catch{return null}}();if(t){const r=await at(t);if(r){return r.parentId!==e&&await async function(e,t){if(!et())return null;try{return await chrome.bookmarks.move(e,t)}catch(r){return null}}(r.id,{parentId:e}),await lt(r.id),{id:r.id,wasRecreated:!1}}}const r=(await st(e)).find(e=>!e.url&&e.title===qe);if(r)return await lt(r.id),{id:r.id,wasRecreated:!1};const s=await nt({parentId:e,title:qe});return s?(await lt(s.id),{id:s.id,wasRecreated:null!==t}):null}function ut(e){return`bb-${e}`}function mt(){return"1x1"}function ht(e,t){const r=[];for(let s=0;s<e.length;s++){const o=e[s];if(tt(o)){const e={id:ut(o.id),type:"bookmarkFolder",size:mt(),position:s,groupId:t.groupId,parentId:t.parentGridId??void 0,browserBookmarkId:o.id,bookmarkFolder:{title:o.title},createdAt:Date.now()};r.push(e);const n=o.children||[];n.length>0&&r.push(...ht(n,{groupId:t.groupId,parentGridId:e.id}))}else r.push({id:ut(o.id),type:"shortcut",size:"1x1",position:s,groupId:t.groupId,parentId:t.parentGridId??void 0,browserBookmarkId:o.id,shortcut:{url:o.url||"",title:o.title||o.url||""},createdAt:Date.now()})}return r}function pt(){const{isLoading:t,ensureGroupBookmarkFolderId:r,removeGroup:s,setBrowserBookmarksRootId:o,setHomeBrowserFolderId:n,setIsApplyingBrowserBookmarks:a,replaceBrowserBookmarkGridItems:i,upsertBrowserBookmarkNode:l,removeBrowserBookmarkById:c,applyBrowserBookmarkChildrenOrder:d}=gt(),u=e.useRef(!1);e.useEffect(()=>{if(t)return;if(!et())return;let e=!1;const m=e=>{const t=gt.getState(),r=t.browserBookmarksRootId,s=t.homeBrowserFolderId;return!(!r||!e)&&(e===r||e===s||(!!t.shortcutGroups.some(t=>t.bookmarkFolderId===e)||t.gridItems.some(t=>t.browserBookmarkId===e&&"bookmarkFolder"===t.type)))},h=async e=>{try{const t=(await st(e)).map(e=>e.id);a(!0),d(e,t)}finally{a(!1)}},p=()=>{gt.getState().shortcutGroups.filter(e=>"home"!==e.id).forEach(e=>s(e.id,{skipBrowserBookmarkDeletion:!0})),(()=>{const e=gt.getState(),t=e.gridItems.filter(e=>!e.browserBookmarkId),r=e.currentFolderId&&t.some(t=>t.id===e.currentFolderId)?e.currentFolderId:null;gt.setState({gridItems:t,currentFolderId:r}),e.saveData(),gt.getState().cleanupEmptyGroups()})(),o(null),n(null)},x=async()=>{if(!u.current){u.current=!0;try{const t=await ct();if(!t||e)return;const{id:s,wasRecreated:l}=t;l&&p(),o(s);const c=await dt(s);c&&n(c.id);const d=gt.getState();await async function(e,t,r,s){const o={created:[],linked:[],skipped:[]};try{const n=(await st(e)).filter(tt);for(const e of n){if(Ze.has(e.title)){o.skipped.push(e.title);continue}const n=s();if(n.find(t=>t.bookmarkFolderId===e.id)){o.skipped.push(e.title);continue}const a=n.find(t=>t.name===e.title);a?a.bookmarkFolderId?o.skipped.push(e.title):(r(a.id,e.id),o.linked.push(e.title)):(t(e.title,"Folder",{bookmarkFolderId:e.id,skipBookmarkFolderCreation:!0}),o.created.push(e.title))}}catch(n){}return o}(s,d.addGroup,d.setGroupBookmarkFolderId,()=>gt.getState().shortcutGroups),l&&window.dispatchEvent(new CustomEvent("tmarks-folder-recreated",{detail:{message:"TMarks 书签文件夹已重建"}}));const u=["home",...gt.getState().shortcutGroups.filter(e=>"home"!==e.id).map(e=>e.id)],m=[],h=[];for(const e of u){let t=null;if(t="home"===e?c?.id??d.homeBrowserFolderId??await r(e):await r(e),!t)continue;h.push(e);const s=await ot(t);s&&m.push(...ht(s.children||[],{groupId:e,parentGridId:null}))}a(!0),i(m,{groupIds:h})}finally{a(!1),u.current=!1}}};x();const g=function(e){if(!et()||!chrome.bookmarks?.onCreated)return()=>{};const{onCreated:t,onRemoved:r,onChanged:s,onMoved:o,onChildrenReordered:n}=e;return t&&chrome.bookmarks.onCreated.addListener(t),r&&chrome.bookmarks.onRemoved.addListener(r),s&&chrome.bookmarks.onChanged.addListener(s),o&&chrome.bookmarks.onMoved.addListener(o),n&&chrome.bookmarks.onChildrenReordered.addListener(n),()=>{t&&chrome.bookmarks.onCreated.removeListener(t),r&&chrome.bookmarks.onRemoved.removeListener(r),s&&chrome.bookmarks.onChanged.removeListener(s),o&&chrome.bookmarks.onMoved.removeListener(o),n&&chrome.bookmarks.onChildrenReordered.removeListener(n)}}({onCreated:(e,t)=>{if(!(Date.now()<gt.getState().browserBookmarkWriteLockUntil)&&m(t.parentId)){a(!0);try{l({id:e,parentId:t.parentId,title:t.title,url:t.url,index:t.index})}finally{a(!1)}t.parentId&&h(t.parentId)}},onRemoved:(e,t)=>{if(Date.now()<gt.getState().browserBookmarkWriteLockUntil)return;const r=gt.getState();if(r.browserBookmarksRootId&&e===r.browserBookmarksRootId)return p(),void x();if(!m(t?.parentId))return;const o=r.shortcutGroups.find(t=>t.bookmarkFolderId===e);o&&"home"!==o.id&&s(o.id,{skipBrowserBookmarkDeletion:!0}),a(!0);try{c(e)}finally{a(!1)}t?.parentId&&h(t.parentId)},onChanged:async(e,t)=>{if(Date.now()<gt.getState().browserBookmarkWriteLockUntil)return;const r=await rt(e);if(r&&m(r.parentId)){a(!0);try{l({id:e,parentId:r.parentId,title:t.title??r.title,url:t.url??r.url,index:r.index})}finally{a(!1)}}},onMoved:async(e,t)=>{if(Date.now()<gt.getState().browserBookmarkWriteLockUntil)return;const r=m(t.parentId),s=m(t.oldParentId);if(!r&&!s)return;if(s&&!r){a(!0);try{c(e)}finally{a(!1)}return void(await h(t.oldParentId))}const o=await rt(e);if(o&&r){a(!0);try{l({id:e,parentId:t.parentId,title:o.title,url:o.url,index:t.index})}finally{a(!1)}}s&&await h(t.oldParentId),r&&await h(t.parentId)},onChildrenReordered:e=>{Date.now()<gt.getState().browserBookmarkWriteLockUntil||m(e)&&h(e)}});return()=>{e=!0,g()}},[t])}let xt=null;const gt=t((e,t)=>{const r=async()=>{const e=t();if(!e.browserBookmarksRootId)return null;let r=e.homeBrowserFolderId;if(r)return r;const s=await dt(e.browserBookmarksRootId);return s?(r=s.id,e.setHomeBrowserFolderId(r),r):null},s=async(e,s)=>{const o=t();if(!Re())return null;if(!o.browserBookmarksRootId)return null;if("home"===e)return r();const n=o.shortcutGroups.find(t=>t.id===e);if(!n)return null;const a=await(async e=>{if(!e)return null;try{const t=await chrome.bookmarks.get(e),r=t?.[0];if(r&&!r.url)return e}catch{}return null})(s?.bookmarkFolderIdOverride??n.bookmarkFolderId??void 0);if(a)return a;const i=o.browserBookmarksRootId;if(!i)return null;try{const t=(await chrome.bookmarks.getChildren(i)).find(e=>!e.url&&e.title===n.name);if(t)return o.setGroupBookmarkFolderId(e,t.id),t.id}catch{}if(s?.createIfMissing)try{o.setBrowserBookmarkWriteLockUntil(Date.now()+1200);const t=await chrome.bookmarks.create({parentId:i,title:n.name});if(t?.id)return o.setGroupBookmarkFolderId(e,t.id),t.id}catch(l){}return null},o=async e=>{const o=t();if(!o.browserBookmarksRootId)return null;if(e.parentGridId){const t=o.gridItems.find(t=>t.id===e.parentGridId);if(t?.browserBookmarkId)return t.browserBookmarkId}const n=e.inferredGroupId??o.activeGroupId??"home";if(null===(e.parentGridId??null))if("home"===n){const e=await r();if(e)return e}else{const e=await s(n);if(e)return e}if("home"===n){const e=await r();if(e)return e}else{const e=await s(n);if(e)return e}return await async function(e){return e?"0"!==e?e:xt||(xt=(async()=>{try{if(!Re())return null;const e=(await chrome.bookmarks.getTree())[0],t=e.children?.find(e=>"1"===e.id&&!e.url);if(t)return t.id;const r=new Set(["Bookmarks Bar","Bookmarks bar","Bookmarks Toolbar","书签栏","收藏夹栏","Favorites bar","收藏夹"]),s=e.children?.find(e=>!e.url&&r.has(e.title));if(s)return s.id;const o=e.children?.find(e=>!e.url);return o?.id||null}catch{return null}})(),xt):null}(o.browserBookmarksRootId)??o.browserBookmarksRootId},n=async s=>{const o=t();if(!Re())return;if(!o.browserBookmarksRootId)return;const n=o.gridItems.find(e=>e.id===s);if(!n)return;if(n.browserBookmarkId)return;if(!(e=>"home"===(e.groupId??"home")&&null===(e.parentId??null))(n))return;if("shortcut"===n.type&&!n.shortcut?.url)return;const a=await r();if(a){o.setBrowserBookmarkWriteLockUntil(Date.now()+1200);try{let r;if("bookmarkFolder"===n.type?r=await chrome.bookmarks.create({parentId:a,title:n.bookmarkFolder?.title||"文件夹"}):"shortcut"===n.type&&(r=await chrome.bookmarks.create({parentId:a,title:n.shortcut?.title||n.shortcut?.url||"快捷方式",url:n.shortcut?.url})),!r?.id)return;e({gridItems:t().gridItems.map(e=>e.id===n.id?{...e,browserBookmarkId:r.id}:e)}),o.saveData()}catch(i){}}},a=function(e,t){return{addShortcut:r=>{const{shortcuts:s,shortcutGroups:o,gridItems:n,saveData:a}=e(),i={...r,id:Me(),position:s.length,createdAt:Date.now(),clickCount:0},l=[...s,i];t({shortcuts:l}),a(),(async()=>{try{const{downloadFavicon:t}=await Be(async()=>{const{downloadFavicon:e}=await Promise.resolve().then(()=>er);return{downloadFavicon:e}},void 0),r=await t(i.url);if(r){const{updateShortcut:t}=e();t(i.id,{faviconBase64:r})}}catch(t){}})(),Oe({groups:o,gridItems:n})},updateShortcut:(r,s)=>{const{shortcuts:o,shortcutGroups:n,gridItems:a,saveData:i}=e(),l=o.map(e=>e.id===r?{...e,...s}:e);t({shortcuts:l}),i(),Oe({groups:n,gridItems:a})},removeShortcut:r=>{const{shortcuts:s,shortcutGroups:o,gridItems:n,saveData:a}=e(),i=s.filter(e=>e.id!==r).map((e,t)=>({...e,position:t}));t({shortcuts:i}),a(),Oe({groups:o,gridItems:n})},reorderShortcuts:(r,s)=>{const{shortcuts:o,shortcutGroups:n,gridItems:a,saveData:i}=e(),l=[...o],[c]=l.splice(r,1);l.splice(s,0,c);const d=l.map((e,t)=>({...e,position:t}));t({shortcuts:d}),i(),Oe({groups:n,gridItems:a})},incrementClickCount:r=>{const{shortcuts:s,saveData:o}=e();t({shortcuts:s.map(e=>e.id===r?{...e,clickCount:e.clickCount+1}:e)}),o()},getFilteredShortcuts:()=>{const{shortcuts:t,activeGroupId:r}=e(),s=r??"home";return t.filter(e=>e.groupId===s&&!e.folderId)}}}(t,e),i=function(e,t,r){return{setActiveGroup:r=>{const{saveData:s}=e();t({activeGroupId:r,currentFolderId:null}),s()},addGroup:(s,o,n)=>{const{shortcutGroups:a,gridItems:i,saveData:l}=e(),c={id:Me(),name:s,icon:o,position:a.length,bookmarkFolderId:n?.bookmarkFolderId??void 0},d=[...a,c];t({shortcutGroups:d}),l(),Oe({groups:d,gridItems:i}),n?.skipBookmarkFolderCreation||r(c.id,{createIfMissing:!n?.bookmarkFolderId,bookmarkFolderIdOverride:n?.bookmarkFolderId??void 0})},updateGroup:(r,s)=>{const{shortcutGroups:o,gridItems:n,saveData:a}=e(),i=o.map(e=>e.id===r?{...e,...s}:e);t({shortcutGroups:i}),a(),Oe({groups:i,gridItems:n})},removeGroup:(r,s)=>{const{shortcutGroups:o,shortcuts:n,activeGroupId:a,gridItems:i,saveData:l,setBrowserBookmarkWriteLockUntil:c}=e();if("home"===r)return;const d=o.find(e=>e.id===r);if(!d)return;const u=!!d.bookmarkFolderId,m=u?n.filter(e=>e.groupId!==r):n.map(e=>e.groupId===r?{...e,groupId:"home"}:e),h=u?i.filter(e=>e.groupId!==r):i.map(e=>e.groupId===r?{...e,groupId:"home",parentId:null}:e),p=o.filter(e=>e.id!==r).map((e,t)=>({...e,position:t}));t({shortcutGroups:p,shortcuts:m,gridItems:h,activeGroupId:a===r?"home":a,...a===r?{currentFolderId:null}:{}}),l(),Oe({groups:p,gridItems:h}),d.bookmarkFolderId&&!s?.skipBrowserBookmarkDeletion&&(async()=>{try{c(Date.now()+1200);try{await chrome.bookmarks.removeTree(d.bookmarkFolderId)}catch{try{await chrome.bookmarks.remove(d.bookmarkFolderId)}catch{}}}catch{}})()},setGroupBookmarkFolderId:(r,s)=>{const{shortcutGroups:o,gridItems:n,saveData:a}=e(),i=o.map(e=>e.id===r?{...e,bookmarkFolderId:s??void 0}:e);t({shortcutGroups:i}),a(),Oe({groups:i,gridItems:n})},cleanupEmptyGroups:()=>{const{shortcutGroups:r,activeGroupId:s,gridItems:o,saveData:n,setBrowserBookmarkWriteLockUntil:a}=e(),i=r.filter(e=>"home"!==e.id&&!o.some(t=>(t.groupId??"home")===e.id&&null===(t.parentId??null))).map(e=>e.id);if(0===i.length)return;const l=[];i.forEach(e=>{const t=r.find(t=>t.id===e);t?.bookmarkFolderId&&l.push(t.bookmarkFolderId)});const c=r.filter(e=>!i.includes(e.id)).map((e,t)=>({...e,position:t})),d=i.includes(s??"")?"home":s,u=i.includes(s??"");t({shortcutGroups:c,activeGroupId:d,...u?{currentFolderId:null}:{}}),n(),Oe({groups:c,gridItems:o}),l.length>0&&(async()=>{try{a(Date.now()+1200);for(const e of l)try{await chrome.bookmarks.removeTree(e)}catch{try{await chrome.bookmarks.remove(e)}catch{}}}catch{}})()}}}(t,e,s),l=function(e,t){return{addFolder:(r,s)=>{const{shortcutGroups:o,shortcutFolders:n,activeGroupId:a,gridItems:i,saveData:l}=e(),c={id:Me(),name:r,position:n.length,groupId:s??a??void 0,createdAt:Date.now()},d=[...n,c];return t({shortcutFolders:d}),l(),Oe({groups:o,gridItems:i}),c.id},updateFolder:(r,s)=>{const{shortcutGroups:o,shortcutFolders:n,gridItems:a,saveData:i}=e(),l=n.map(e=>e.id===r?{...e,...s}:e);t({shortcutFolders:l}),i(),Oe({groups:o,gridItems:a})},removeFolder:r=>{const{shortcuts:s,shortcutGroups:o,shortcutFolders:n,gridItems:a,saveData:i}=e(),l=s.map(e=>e.folderId===r?{...e,folderId:void 0}:e),c=n.filter(e=>e.id!==r);t({shortcutFolders:c,shortcuts:l}),i(),Oe({groups:o,gridItems:a})},getFolderShortcuts:t=>{const{shortcuts:r}=e();return r.filter(e=>e.folderId===t)},moveShortcutToFolder:(r,s)=>{const{shortcuts:o,shortcutGroups:n,gridItems:a,saveData:i}=e(),l=o.map(e=>e.id===r?{...e,folderId:s}:e);t({shortcuts:l}),i(),Oe({groups:n,gridItems:a})}}}(t,e),c=He(e,t,o),d=Ke(e,t,e=>{const r=t();if(!e)return"home";if(e===r.homeBrowserFolderId)return"home";const s=r.shortcutGroups.find(t=>t.bookmarkFolderId===e);if(s)return s.id;const o=r.gridItems.find(t=>t.browserBookmarkId===e&&"bookmarkFolder"===t.type);return o?.groupId??"home"},e=>{if(!e)return!1;const r=t();return e===r.homeBrowserFolderId||r.shortcutGroups.some(t=>t.bookmarkFolderId===e)}),u=Ye(e,t,o);return{shortcuts:[],shortcutGroups:we,shortcutFolders:[],activeGroupId:"home",settings:fe,isLoading:!0,gridItems:[],currentFolderId:null,browserBookmarksRootId:null,homeBrowserFolderId:null,isApplyingBrowserBookmarks:!1,browserBookmarkWriteLockUntil:0,loadData:async()=>{try{const r=(await chrome.storage.local.get(be))[be],s=r?.shortcutGroups?.length?r.shortcutGroups:we;let o=r?.activeGroupId;o&&s.some(e=>e.id===o)||(o=s[0]?.id||"home");const n={...fe,...r?.settings||{}};if(e({shortcuts:r?.shortcuts||[],shortcutGroups:s,shortcutFolders:r?.shortcutFolders||[],activeGroupId:o,settings:n,gridItems:r?.gridItems||[],currentFolderId:null,browserBookmarksRootId:null,homeBrowserFolderId:null,isApplyingBrowserBookmarks:!1,browserBookmarkWriteLockUntil:0,isLoading:!1}),!r){const{saveData:e}=t();e()}}catch(r){e({isLoading:!1})}},saveData:async()=>{const{shortcuts:e,shortcutGroups:r,shortcutFolders:s,activeGroupId:o,settings:n,gridItems:a}=t(),i={shortcuts:e,shortcutGroups:r,shortcutFolders:s,activeGroupId:o,settings:n,gridItems:a};try{await chrome.storage.local.set({[be]:i})}catch(l){}},updateSettings:r=>{const{shortcutGroups:s,settings:o,gridItems:n,saveData:a}=t(),i={...o,...r};e({settings:i}),a(),Oe({groups:s,gridItems:n})},...a,...i,ensureGroupBookmarkFolderId:s,...l,...c,...d,...u,mirrorHomeItemsToBrowser:e=>{for(const t of e)n(t)}}});function ft({format:t,showDate:s,showSeconds:o,showLunar:n=!1}){const[a,i]=e.useState(new Date);e.useEffect(()=>{const e=setInterval(()=>i(new Date),1e3);return()=>clearInterval(e)},[]);const l=e.useMemo(()=>{if(!n)return null;const e=De.Lunar.fromDate(a);let t="";try{const r=e.getFestivals?.()||[],s=e.getJieQi?.()||"";t=r[0]||s||""}catch{}return{date:`${e.getMonthInChinese()}月${e.getDayInChinese()}`,festival:t}},[a,n]);return r.jsxs("div",{className:"text-center text-white select-none",children:[r.jsx("div",{className:"text-7xl font-light tracking-wider text-shadow-lg",children:(()=>{let e=a.getHours();const r=a.getMinutes().toString().padStart(2,"0"),s=a.getSeconds().toString().padStart(2,"0");let n="";"12h"===t&&(n=e>=12?" PM":" AM",e=e%12||12);let i=`${e.toString().padStart(2,"0")}:${r}`;return o&&(i+=`:${s}`),"12h"===t&&(i+=n),i})()}),(s||n)&&r.jsxs("div",{className:"mt-2 text-lg text-white/90 text-shadow flex items-center justify-center gap-3",children:[s&&r.jsx("span",{children:a.toLocaleDateString("zh-CN",{weekday:"short",month:"numeric",day:"numeric"})}),s&&n&&r.jsx("span",{className:"text-white/50",children:"|"}),n&&l&&r.jsxs(r.Fragment,{children:[r.jsx("span",{children:l.date}),l.festival&&r.jsx("span",{className:"px-2 py-0.5 rounded-full bg-white/10 text-sm",children:l.festival})]})]})]})}const wt=(...e)=>{},bt=(...e)=>{},kt="tmarks_pinned_bookmarks";let vt=null,yt=null;async function jt(){const e=await Ce.getBookmarkSiteApiUrl(),t=await Ce.getBookmarkSiteApiKey();if(!t)throw new Error("API Key 未配置");let r;return r=e?e.endsWith("/api")?e:Se(e).API_BASE:Se().API_BASE,vt&&yt&&yt.apiKey===t&&yt.apiBaseUrl===r||(vt=Fe({apiKey:t,baseUrl:r}),yt={apiKey:t,apiBaseUrl:r}),vt}function It(){const[t,r]=e.useState({isSyncing:!1,lastSyncAt:null,error:null}),[s,o]=e.useState([]),n=e.useRef(null),a=e.useCallback(async()=>{try{const e=(await chrome.storage.local.get(kt))[kt];return e&&e.bookmarks?(wt("从缓存加载置顶书签:",e.bookmarks.length,"个"),e.bookmarks):null}catch(e){return null}},[]),i=e.useCallback(async e=>{try{const t={bookmarks:e,timestamp:Date.now()};await chrome.storage.local.set({[kt]:t}),wt("已缓存置顶书签")}catch(t){}},[]),l=e.useCallback(async(e=!1)=>{if(!e){const e=await a();if(e)return o(e),r({isSyncing:!1,lastSyncAt:Date.now(),error:null}),e}r(e=>({...e,isSyncing:!0,error:null}));try{const e=await jt(),t=await e.bookmarks.getPinnedBookmarks({page_size:20});if(bt("获取置顶书签响应:",{total:t.data?.bookmarks?.length,bookmarks:t.data?.bookmarks?.map(e=>({id:e.id,title:e.title,is_pinned:e.is_pinned}))}),t.data?.bookmarks){const e=t.data.bookmarks.filter(e=>!0===e.is_pinned);wt("过滤后置顶书签:",e.length);const r=e.map(e=>({id:e.id,url:e.url,title:e.title,favicon:e.favicon||void 0,is_pinned:!0}));o(r),await i(r)}return r({isSyncing:!1,lastSyncAt:Date.now(),error:null}),t.data?.bookmarks||[]}catch(t){const e=t instanceof Error?t.message:"同步失败";return r(t=>({...t,isSyncing:!1,error:e})),[]}},[a,i]),c=e.useCallback(async e=>{if(!e.trim())return[];try{const t=await jt(),r=await t.bookmarks.searchBookmarks(e,{page_size:10});return(r.data?.bookmarks||[]).map(e=>({id:e.id,url:e.url,title:e.title,favicon:e.favicon||void 0}))}catch{return[]}},[]),d=e.useCallback(async()=>{try{const e=await jt();return await e.bookmarks.getBookmarks({page_size:1}),!0}catch{return!1}},[]);e.useEffect(()=>{n.current=l},[l]),e.useEffect(()=>{const e=e=>{"REFRESH_PINNED_BOOKMARKS"===e.type&&n.current&&n.current(!0)};return chrome.runtime.onMessage.addListener(e),()=>{chrome.runtime.onMessage.removeListener(e)}},[]);const u=e.useCallback(async e=>{try{const t=e.map(e=>s.find(t=>t.id===e)).filter(e=>void 0!==e);o(t),await i(t);const r=await jt();await r.bookmarks.reorderPinnedBookmarks(e),wt("置顶书签顺序已更新并同步到后端")}catch(t){await l(!0)}},[s,i,l]),m=e.useCallback(async e=>{try{const t=await jt();await t.bookmarks.recordClick(e),bt("已记录书签点击:",e)}catch(t){}},[]),h=e.useCallback(async e=>{try{const t=await jt();await t.tags.incrementClick(e),bt("已记录标签点击:",e)}catch(t){}},[]);return{syncState:t,pinnedBookmarks:s,fetchPinnedBookmarks:l,searchBookmarks:c,checkApiConfigured:d,reorderPinnedBookmarks:u,recordBookmarkClick:m,recordTagClick:h}}function Nt({icon:e,name:t,size:s="md"}){const o="sm"===s?"w-4 h-4":"w-5 h-5";return r.jsx("img",{src:e,alt:t,className:`${o} object-contain`,onError:e=>{e.currentTarget.style.display="none";const t=e.currentTarget.parentElement;if(t&&!t.querySelector(".fallback-icon")){const e=document.createElement("span");e.className=`fallback-icon ${o} flex items-center justify-center`,e.innerHTML=`<svg class="${o} text-white/60" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/></svg>`,t.appendChild(e)}}})}function Ct({current:t,onChange:o}){const[n,a]=e.useState(!1),i=ke.find(e=>e.id===t)||ke[0];return r.jsxs("div",{className:"relative",children:[r.jsxs("button",{onClick:()=>a(!n),className:"flex items-center gap-1.5 px-2 py-1.5 rounded-xl bg-white/10 hover:bg-white/20 active:scale-95 transition-all focus:outline-none focus:ring-2 focus:ring-white/20",children:[r.jsx(Nt,{icon:i.icon,name:i.name}),r.jsx(s,{className:"w-3 h-3 text-white/60 transition-transform "+(n?"rotate-180":"")})]}),n&&r.jsxs(r.Fragment,{children:[r.jsx("div",{className:"fixed inset-0 z-40",onClick:()=>a(!1)}),r.jsx("div",{className:"absolute top-full left-0 mt-2 w-40 rounded-xl glass-dark overflow-hidden z-50 animate-scaleIn",children:ke.map(e=>r.jsxs("button",{onClick:()=>{o(e.id),a(!1)},className:"w-full flex items-center gap-3 px-3 py-2.5 text-left transition-colors "+(e.id===t?"bg-white/20":"hover:bg-white/10"),children:[r.jsx(Nt,{icon:e.icon,name:e.name}),r.jsx("span",{className:"text-sm text-white/80",children:e.name})]},e.id))})]})]})}function St(e,t){if(e)return e;try{const e=new URL(t).hostname;return`${ve}${e}&sz=64`}catch{return""}}function Bt({engine:t,enableSuggestions:s=!0,onEngineChange:a}){const[i,l]=e.useState(""),[c,d]=e.useState(!1),[u,m]=e.useState([]),[h,p]=e.useState(-1),[x,g]=e.useState(!1),f=e.useRef(null),w=e.useRef(),{shortcuts:b}=gt(),{searchBookmarks:k,recordBookmarkClick:v}=It(),y=ke.find(e=>e.id===t)||ke[0],j=e.useCallback(e=>{const t=e.toLowerCase();return b.filter(e=>e.title.toLowerCase().includes(t)||e.url.toLowerCase().includes(t)).slice(0,5).map(e=>({id:e.id,title:e.title,url:e.url,favicon:e.favicon,source:"shortcut"}))},[b]);e.useEffect(()=>{if(i.trim())return w.current&&clearTimeout(w.current),w.current=setTimeout(async()=>{if(x){const e=j(i),t=(await k(i)).map(e=>({id:e.id,title:e.title,url:e.url,favicon:e.favicon,source:"bookmark"})),r=[...e];t.forEach(e=>{r.some(t=>t.url===e.url)||r.push(e)}),m(r.slice(0,10))}else if(s){const e=j(i),t=(await k(i)).map(e=>({id:e.id,title:e.title,url:e.url,favicon:e.favicon,source:"bookmark"})),r=[...e];t.forEach(e=>{r.some(t=>t.url===e.url)||r.push(e)}),m(r.slice(0,8))}},200),()=>{w.current&&clearTimeout(w.current)};m([])},[i,j,k,x,s]);const I=e.useCallback(()=>{if(!i.trim())return;const e=y.url+encodeURIComponent(i.trim());window.location.href=e},[i,y]),N=e=>{"bookmark"===e.source&&v(e.id),window.location.href=e.url},C=(x||s)&&c&&u.length>0;return r.jsxs("div",{className:"relative",children:[r.jsxs("div",{className:`\n          flex items-center gap-3 px-4 py-3 rounded-full\n          glass transition-all duration-200\n          ${c?"ring-2 ring-white/30 bg-white/15":"hover:bg-white/15"}\n        `,children:[a?r.jsx(Ct,{current:t,onChange:a}):r.jsx(o,{className:"w-5 h-5 text-white/60 flex-shrink-0"}),r.jsx("input",{ref:f,type:"text",value:i,onChange:e=>{l(e.target.value),p(-1)},onKeyDown:e=>{"Enter"===e.key?h>=0&&u[h]?N(u[h]):x||I():"ArrowDown"===e.key?(e.preventDefault(),p(e=>Math.min(e+1,u.length-1))):"ArrowUp"===e.key?(e.preventDefault(),p(e=>Math.max(e-1,-1))):"Escape"===e.key&&(m([]),p(-1))},onFocus:()=>d(!0),onBlur:()=>setTimeout(()=>d(!1),150),placeholder:x?"搜索书签...":`在 ${y.name} 中搜索...`,className:"flex-1 bg-transparent text-white placeholder-white/50 outline-none text-base"}),r.jsx("button",{onClick:()=>g(!x),className:"p-2 rounded-full transition-all active:scale-90 "+(x?"bg-blue-500/30 text-blue-400":"text-white/40 hover:text-white/70 hover:bg-white/10"),title:x?"切换到搜索引擎":"切换到书签搜索",children:r.jsx(n,{className:"w-4 h-4"})})]}),C&&r.jsx("div",{className:"absolute top-full left-0 right-0 mt-2 rounded-xl glass-dark overflow-hidden animate-scaleIn z-[100]",children:u.map((e,t)=>r.jsxs("button",{onClick:()=>N(e),className:`\n                w-full flex items-center gap-3 px-4 py-3 text-left\n                transition-colors\n                ${t===h?"bg-white/20":"hover:bg-white/10"}\n              `,children:[r.jsx("img",{src:St(e.favicon,e.url),alt:"",className:"w-5 h-5 rounded",onError:e=>{e.target.style.display="none"}}),r.jsxs("div",{className:"flex-1 min-w-0",children:[r.jsx("div",{className:"text-sm text-white truncate",children:e.title}),r.jsx("div",{className:"text-xs text-white/50 truncate",children:e.url})]}),r.jsx("span",{className:"text-xs text-white/30",children:"shortcut"===e.source?"快捷方式":"书签"})]},e.id))})]})}const Ft=100,Dt=110,Et=120,Gt=1e3,Tt="newtab_weather",zt={sunny:m,cloudy:a,rainy:h,snowy:p,windy:d};function Lt(e){const t=e.toLowerCase();return t.includes("sun")||t.includes("clear")||t.includes("晴")?zt.sunny:t.includes("rain")||t.includes("雨")?zt.rainy:t.includes("snow")||t.includes("雪")?zt.snowy:t.includes("wind")||t.includes("风")?zt.windy:zt.cloudy}const At=e.memo(function({item:t,onUpdate:s,onRemove:o,isEditing:n}){const[m,h]=e.useState(null),[p,x]=e.useState(!1),[g,f]=e.useState(null),[w,b]=e.useState(!1),[k,v]=e.useState(""),{rows:y}=Ue(t.size),j=t.config?.weather?.city||"北京",I=t.config?.weather?.unit||"C",N=y>=2,C=async(e,t=!1)=>{if(!t)try{const t=(await chrome.storage.local.get(Tt))[Tt];if(t&&t.city===e&&Date.now()-t.data.updateTime<18e5)return void h(t.data)}catch{}x(!0),f(null);try{const t=await fetch(`https://api.vvhan.com/api/weather?city=${encodeURIComponent(e)}`);if(!t.ok)throw new Error("获取天气失败");const r=await t.json();if(!r.success)throw new Error(r.message||"获取天气失败");const s={city:r.data.city||e,temp:parseInt(r.data.tem)||0,condition:r.data.wea||"未知",icon:r.data.wea_img||"cloudy",humidity:parseInt(r.data.humidity)||0,windSpeed:parseInt(r.data.win_speed)||0,visibility:10,updateTime:Date.now(),forecast:N&&r.data.forecast?r.data.forecast.slice(0,3).map(e=>({date:e.date,tempMax:parseInt(e.tem_day)||0,tempMin:parseInt(e.tem_night)||0,condition:e.wea||"未知",icon:e.wea_img||"cloudy"})):void 0};h(s),chrome.storage.local.set({[Tt]:{city:e,data:s}})}catch(r){f(r instanceof Error?r.message:"获取天气失败")}finally{x(!1)}};e.useEffect(()=>{C(j)},[j]);const S=m?Lt(m.condition):a;return r.jsxs("div",{className:"group relative h-full p-3 rounded-xl glass-card flex flex-col",children:[r.jsxs("div",{className:"flex items-center justify-between mb-2",children:[r.jsxs("button",{onClick:()=>b(!w),className:"flex items-center gap-2 text-white/80 hover:text-white transition-colors",children:[r.jsx(i,{className:"w-4 h-4"}),r.jsx("span",{className:"text-sm font-medium",children:m?.city||j})]}),r.jsx("button",{onClick:()=>C(j,!0),disabled:p,className:"p-1 rounded-full hover:bg-white/10 transition-colors",children:r.jsx(l,{className:"w-3 h-3 text-white/50 "+(p?"animate-spin":"")})})]}),w&&r.jsx("div",{className:"mb-2",children:r.jsx("input",{type:"text",value:k,onChange:e=>v(e.target.value),onKeyDown:e=>"Enter"===e.key&&void(k.trim()&&s&&(s(t.id,{config:{...t.config,weather:{...t.config?.weather,city:k.trim()}}}),b(!1),v(""))),placeholder:"输入城市名称",className:"w-full bg-white/10 text-white text-xs rounded px-2 py-1 outline-none border border-white/20 focus:border-blue-500/50",autoFocus:!0})}),p&&!m?r.jsx("div",{className:"flex-1 flex items-center justify-center text-white/40 text-sm",children:"加载中..."}):g?r.jsx("div",{className:"flex-1 flex items-center justify-center text-red-400 text-sm",children:g}):m?r.jsxs("div",{className:"flex-1 flex flex-col",children:[r.jsxs("div",{className:"flex items-center gap-3 mb-3",children:[r.jsx(S,{className:"w-12 h-12 text-yellow-400"}),r.jsxs("div",{children:[r.jsxs("div",{className:"text-3xl font-bold text-white",children:[m.temp,"°",I]}),r.jsx("div",{className:"text-sm text-white/60",children:m.condition})]})]}),r.jsxs("div",{className:"grid grid-cols-3 gap-2 text-xs text-white/60 mb-3",children:[r.jsxs("div",{className:"flex items-center gap-1",children:[r.jsx(c,{className:"w-3 h-3"}),r.jsxs("span",{children:[m.humidity,"%"]})]}),r.jsxs("div",{className:"flex items-center gap-1",children:[r.jsx(d,{className:"w-3 h-3"}),r.jsxs("span",{children:[m.windSpeed,"km/h"]})]}),r.jsxs("div",{className:"flex items-center gap-1",children:[r.jsx(u,{className:"w-3 h-3"}),r.jsxs("span",{children:[m.visibility,"km"]})]})]}),N&&m.forecast&&m.forecast.length>0&&r.jsxs("div",{className:"flex-1 border-t border-white/10 pt-2",children:[r.jsx("div",{className:"text-xs text-white/60 mb-2",children:"未来预报"}),r.jsx("div",{className:"space-y-1",children:m.forecast.map((e,t)=>{const s=Lt(e.condition);return r.jsxs("div",{className:"flex items-center justify-between text-xs",children:[r.jsx("span",{className:"text-white/60",children:e.date}),r.jsxs("div",{className:"flex items-center gap-2",children:[r.jsx(s,{className:"w-3 h-3 text-white/60"}),r.jsxs("span",{className:"text-white/80",children:[e.tempMax,"° / ",e.tempMin,"°"]})]})]},t)})})]})]}):null]})}),Mt=e.memo(function({item:t,onRemove:s,isEditing:o}){const[n,a]=e.useState(new Date),{rows:i}=Ue(t.size),l=i>=2,c=t.config?.clock||{format:"24h",showDate:!0,showSeconds:!1,showLunar:!1};e.useEffect(()=>{const e=setInterval(()=>a(new Date),1e3);return()=>clearInterval(e)},[]);const d=e.useMemo(()=>{if(!c.showLunar)return null;try{const e=De.Lunar.fromDate(n),t=e.getMonthInChinese(),r=e.getDayInChinese(),s=e.getFestivals?.()||[],o=e.getJieQi?.()||null;return{date:`${t}月${r}`,festival:s.length>0?s[0]:o||null}}catch{return null}},[n.toDateString(),c.showLunar]);return r.jsxs("div",{className:"group relative h-full p-3 rounded-xl glass-card flex flex-col items-center justify-center",children:[r.jsx("div",{className:"text-white font-light tracking-wider "+(l?"text-5xl":"text-3xl"),children:(()=>{let e=n.getHours();const t=n.getMinutes().toString().padStart(2,"0"),r=n.getSeconds().toString().padStart(2,"0");let s="";"12h"===c.format&&(s=e>=12?" PM":" AM",e=e%12||12);let o=`${e.toString().padStart(2,"0")}:${t}`;return c.showSeconds&&(o+=`:${r}`),"12h"===c.format&&(o+=s),o})()}),c.showDate&&r.jsx("div",{className:"text-white/70 "+(l?"text-base mt-2":"text-sm mt-1"),children:`${n.getMonth()+1}月${n.getDate()}日 ${["周日","周一","周二","周三","周四","周五","周六"][n.getDay()]}`}),c.showLunar&&d&&r.jsxs("div",{className:"flex items-center gap-2 mt-1",children:[r.jsx("span",{className:"text-sm text-white/60",children:d.date}),d.festival&&r.jsx("span",{className:"px-2 py-0.5 rounded-full bg-white/10 text-xs text-white/70",children:d.festival})]})]})}),Rt={default:r.jsx(b,{className:"w-8 h-8"}),search:r.jsx(o,{className:"w-8 h-8"}),bookmark:r.jsx(w,{className:"w-8 h-8"}),todo:r.jsx(f,{className:"w-8 h-8"}),notes:r.jsx(g,{className:"w-8 h-8"}),hotsearch:r.jsx(x,{className:"w-8 h-8"})},$t={default:"暂无内容",search:"未找到结果",bookmark:"暂无书签",todo:"暂无待办事项",notes:"暂无笔记",hotsearch:"暂无数据"};function Pt({type:e="default",message:t,description:s}){return r.jsxs("div",{className:"flex flex-col items-center justify-center py-6 text-white/40",children:[r.jsx("div",{className:"mb-2 opacity-50",children:Rt[e]}),r.jsx("p",{className:"text-sm",children:t||$t[e]}),s&&r.jsx("p",{className:"text-xs text-white/30 mt-1",children:s})]})}const Ot="newtab_todos",_t=t((e,t)=>({todos:[],loadTodos:async()=>{try{const t=(await chrome.storage.local.get(Ot))[Ot];t&&e({todos:t})}catch(t){}},addTodo:r=>{const{todos:s}=t(),o=[{id:`${Date.now()}-${Math.random().toString(36).slice(2,9)}`,text:r,completed:!1,createdAt:Date.now()},...s];e({todos:o}),chrome.storage.local.set({[Ot]:o})},toggleTodo:r=>{const{todos:s}=t(),o=s.map(e=>e.id===r?{...e,completed:!e.completed}:e);e({todos:o}),chrome.storage.local.set({[Ot]:o})},removeTodo:r=>{const{todos:s}=t(),o=s.filter(e=>e.id!==r);e({todos:o}),chrome.storage.local.set({[Ot]:o})},clearCompleted:()=>{const{todos:r}=t(),s=r.filter(e=>!e.completed);e({todos:s}),chrome.storage.local.set({[Ot]:s})}}));_t.getState().loadTodos();const Ut=e.memo(function({item:t,onRemove:s,isEditing:o}){const{todos:n,addTodo:a,toggleTodo:i,removeTodo:l}=_t(),[c,d]=e.useState(""),[u,m]=e.useState(!1),{rows:h}=Ue(t.size),p=()=>{c.trim()&&(a(c.trim()),d(""))},x=n.filter(e=>!e.completed),g=n.filter(e=>e.completed),w=u?n:x,b=h<=2?4:h<=3?6:10;return r.jsxs("div",{className:"group relative h-full p-3 rounded-xl glass-card flex flex-col",children:[r.jsxs("div",{className:"flex items-center justify-between mb-2",children:[r.jsxs("div",{className:"flex items-center gap-2 text-white/80",children:[r.jsx(f,{className:"w-4 h-4"}),r.jsx("span",{className:"text-sm font-medium",children:"待办事项"}),x.length>0&&r.jsx("span",{className:"px-1.5 py-0.5 text-xs bg-white/20 rounded-full",children:x.length})]}),g.length>0&&r.jsx("button",{onClick:()=>m(!u),className:"text-xs text-white/50 hover:text-white/80 transition-colors",children:u?"隐藏":`${g.length} 完成`})]}),r.jsxs("div",{className:"flex gap-2 mb-2",children:[r.jsx("input",{type:"text",value:c,onChange:e=>d(e.target.value),onKeyDown:e=>{"Enter"===e.key&&p()},placeholder:"添加待办...",className:"flex-1 bg-white/10 text-white text-sm rounded-lg px-3 py-1.5 outline-none \r\n                     border border-white/10 focus:border-white/30 placeholder-white/40"}),r.jsx("button",{onClick:p,className:"p-1.5 rounded-xl bg-white/10 hover:bg-white/20 transition-colors focus:outline-none focus:ring-2 focus:ring-white/20",children:r.jsx(k,{className:"w-4 h-4 text-white/70"})})]}),r.jsxs("div",{className:"flex-1 space-y-1 overflow-y-auto",children:[0===w.length?r.jsx(Pt,{type:"todo"}):w.slice(0,b).map(e=>r.jsxs("div",{className:"flex items-center gap-2 p-1.5 rounded-lg hover:bg-white/10 group/item transition-colors "+(e.completed?"opacity-50":""),children:[r.jsx("button",{onClick:()=>i(e.id),className:"w-4 h-4 rounded-full border flex items-center justify-center transition-colors flex-shrink-0 "+(e.completed?"bg-green-500/50 border-green-500/50":"border-white/30 hover:border-white/50"),children:e.completed&&r.jsx(v,{className:"w-2.5 h-2.5 text-white"})}),r.jsx("span",{className:"flex-1 text-sm text-white/80 truncate "+(e.completed?"line-through":""),children:e.text}),r.jsx("button",{onClick:()=>l(e.id),className:"p-0.5 rounded opacity-0 group-hover/item:opacity-100 hover:bg-white/20 transition-all",children:r.jsx(y,{className:"w-3 h-3 text-white/50"})})]},e.id)),w.length>b&&r.jsxs("div",{className:"text-center text-white/40 text-xs py-1",children:["还有 ",w.length-b," 项..."]})]})]})}),Wt="newtab_notes",Ht=e.memo(function({item:t,onRemove:s,isEditing:o}){const[n,a]=e.useState(""),[i,l]=e.useState(!1),c=e.useRef(null),d=e.useRef();e.useEffect(()=>{chrome.storage.local.get(Wt).then(e=>{const t=e[Wt];t?.content&&a(t.content)})},[]);return r.jsxs("div",{className:"group relative h-full p-3 rounded-xl glass-card flex flex-col",children:[r.jsxs("div",{className:"flex items-center justify-between mb-2",children:[r.jsxs("div",{className:"flex items-center gap-2 text-white/80",children:[r.jsx(j,{className:"w-4 h-4"}),r.jsx("span",{className:"text-sm font-medium",children:"备忘录"})]}),i&&r.jsx("span",{className:"text-xs text-white/40",children:"保存中..."})]}),r.jsx("textarea",{ref:c,value:n,onChange:e=>{return t=e.target.value,a(t),l(!0),d.current&&clearTimeout(d.current),void(d.current=setTimeout(()=>{chrome.storage.local.set({[Wt]:{content:t,updatedAt:Date.now()}}),l(!1)},500));var t},placeholder:"记录一些想法...",className:"flex-1 w-full bg-white/10 text-white text-sm rounded-lg px-3 py-2 outline-none \r\n                   border border-white/10 focus:border-white/30 placeholder-white/40 resize-none"})]})}),Kt="newtab_hotsearch",Yt={baidu:"https://api.vvhan.com/api/hotlist/baiduRD",weibo:"https://api.vvhan.com/api/hotlist/wbHot",zhihu:"https://api.vvhan.com/api/hotlist/zhihuHot",bilibili:"https://api.vvhan.com/api/hotlist/bili"},Xt=e.memo(function({item:t,onUpdate:o,onRemove:n,isEditing:a}){const[i,c]=e.useState([]),[d,u]=e.useState(!1),[m,h]=e.useState(!1),{rows:p}=Ue(t.size),x=t.config?.hotsearch?.type||"baidu",g=ye.find(e=>e.id===x)||ye[0],f=p<=2?5:p<=3?10:15,w=async(e=!1)=>{if(!e)try{const e=(await chrome.storage.local.get(Kt))[Kt];if(e&&e.type===x&&Date.now()-e.timestamp<6e5)return void c(e.items)}catch{}u(!0);try{const e=await fetch(Yt[x]),t=await e.json();let r=[];t.success&&t.data&&(r=t.data.slice(0,15).map(e=>({title:e.title||e.name||e.desc,hot:e.hot||e.hotValue||e.index||"",url:e.url||e.link||"#"}))),c(r),chrome.storage.local.set({[Kt]:{type:x,items:r,timestamp:Date.now()}})}catch(t){}finally{u(!1)}};e.useEffect(()=>{w()},[x]);return r.jsxs("div",{className:"group relative h-full p-3 rounded-xl glass-card flex flex-col",children:[r.jsxs("div",{className:"flex items-center justify-between mb-2",children:[r.jsxs("div",{className:"flex items-center gap-2",children:[r.jsx(I,{className:"w-4 h-4 text-orange-400"}),r.jsxs("div",{className:"relative",children:[r.jsxs("button",{onClick:()=>h(!m),className:"text-sm font-medium text-white/80 hover:text-white flex items-center gap-1",children:[g.name,r.jsx(s,{className:"w-3 h-3 transition-transform "+(m?"rotate-180":"")})]}),m&&r.jsxs(r.Fragment,{children:[r.jsx("div",{className:"fixed inset-0 z-40",onClick:()=>h(!1)}),r.jsx("div",{className:"absolute top-full left-0 mt-1 w-24 rounded-lg glass-dark overflow-hidden z-50",children:ye.map(e=>r.jsx("button",{onClick:()=>{return r=e.id,o?.(t.id,{config:{...t.config,hotsearch:{type:r}}}),void h(!1);var r},className:"w-full px-3 py-1.5 text-left text-sm transition-colors "+(e.id===x?"bg-white/20 text-white":"text-white/70 hover:bg-white/10"),children:e.name},e.id))})]})]})]}),r.jsx("button",{onClick:()=>w(!0),disabled:d,className:"p-1 rounded-full hover:bg-white/10 transition-colors",children:r.jsx(l,{className:"w-3 h-3 text-white/50 "+(d?"animate-spin":"")})})]}),r.jsx("div",{className:"flex-1 space-y-0.5 overflow-y-auto",children:0===i.length?d?r.jsx("div",{className:"text-center text-white/40 text-sm py-4",children:"加载中..."}):r.jsx(Pt,{type:"hotsearch"}):i.slice(0,f).map((e,t)=>r.jsxs("a",{href:e.url,target:"_blank",rel:"noopener noreferrer",className:"flex items-center gap-2 p-1.5 rounded-lg hover:bg-white/10 transition-colors group/item",children:[r.jsx("span",{className:"w-4 h-4 flex items-center justify-center text-xs font-bold rounded flex-shrink-0 "+(t<3?"bg-orange-500/80 text-white":"bg-white/10 text-white/60"),children:t+1}),r.jsx("span",{className:"flex-1 text-sm text-white/80 truncate group-hover/item:text-white",children:e.title}),r.jsx(N,{className:"w-3 h-3 text-white/30 opacity-0 group-hover/item:opacity-100 flex-shrink-0"})]},t))})]})}),qt="newtab_poetry",Vt=e.memo(function({item:t,onRemove:s,isEditing:o}){const[n,a]=e.useState(null),{rows:i}=Ue(t.size),c=i>=2,d=()=>{const e=Math.floor(Math.random()*je.length),t=je[e];a(t);const r=(new Date).toDateString();chrome.storage.local.set({[qt]:{poetry:t,date:r}})};return e.useEffect(()=>{chrome.storage.local.get(qt).then(e=>{const t=e[qt],r=(new Date).toDateString();t&&t.date===r?a(t.poetry):d()})},[]),n?r.jsx("div",{className:"group relative h-full p-3 rounded-xl glass-card flex flex-col items-center justify-center",children:c?r.jsxs("div",{className:"flex flex-col items-center gap-2 text-center",children:[r.jsx(C,{className:"w-5 h-5 text-white/60"}),r.jsxs("p",{className:"text-base text-white/90 font-light tracking-wide",children:["「",n.content,"」"]}),r.jsxs("p",{className:"text-sm text-white/60",children:["—— ",n.author,"《",n.title,"》"]}),r.jsx("button",{onClick:d,className:"mt-2 p-1.5 rounded-full opacity-0 group-hover:opacity-100 hover:bg-white/10 transition-all",title:"换一首",children:r.jsx(l,{className:"w-3 h-3 text-white/50"})})]}):r.jsxs("div",{className:"flex items-center gap-2 w-full",children:[r.jsxs("div",{className:"flex-1 text-center",children:[r.jsxs("span",{className:"text-sm text-white/80 font-light tracking-wide",children:["「",n.content,"」"]}),r.jsxs("span",{className:"text-xs text-white/50 ml-2",children:["—— ",n.author]})]}),r.jsx("button",{onClick:d,className:"p-1 rounded-full opacity-0 group-hover:opacity-100 hover:bg-white/10 transition-all flex-shrink-0",title:"换一首",children:r.jsx(l,{className:"w-3 h-3 text-white/50"})})]})}):null});async function Jt(e,t=10){try{if(e.size<=1024*t)return await async function(e){return new Promise((t,r)=>{const s=new FileReader;s.onloadend=()=>t(s.result),s.onerror=r,s.readAsDataURL(e)})}(e);const r=new Image,s=URL.createObjectURL(e);await new Promise((e,t)=>{r.onload=e,r.onerror=t,r.src=s});const o=document.createElement("canvas"),n=o.getContext("2d");if(!n)return null;o.width=r.width,o.height=r.height,n.drawImage(r,0,0);let a=.8,i="";for(;a>.1;){i=o.toDataURL("image/jpeg",a);if(3*i.length/4/1024<=t)break;a-=.1}URL.revokeObjectURL(s);return 3*i.length/4/1024>1.5*t?null:i}catch(r){return null}}async function Qt(e,t=10){try{const r=`https://icon.ooo/${new URL(e).hostname}?size=32&v=${Date.now()}`,s=await fetch(r);if(!s.ok)return null;const o=await s.blob();if(o.size<100)return null;return await Jt(o,t)}catch(r){return null}}function Zt(e){if(e.faviconBase64)return e.faviconBase64;if(e.favicon&&(!e.favicon.includes("icon.ooo")||!e.favicon.includes("&sz=")))return e.favicon;try{const t=new URL(e.url),r="undefined"!=typeof navigator?navigator.userAgent.toLowerCase():"",s=!r.includes("firefox")&&"undefined"!=typeof globalThis&&void 0!==globalThis.chrome&&!!globalThis.chrome?.runtime?.id,o="undefined"!=typeof location?location.href:"",n=o.includes("/src/newtab/")||o.includes("/newtab/");if(s&&n)return`chrome://favicon2/?size=64&page_url=${encodeURIComponent(t.href)}`;return`https://icon.ooo/${t.hostname}?size=64&v=1`}catch{return""}}const er=Object.freeze(Object.defineProperty({__proto__:null,batchDownloadFavicons:async function(e,t){const r=new Map;let s=0;for(const o of e){if(o.faviconBase64){s++,t?.(s,e.length);continue}const n=await Qt(o.url);n&&r.set(o.id,n),s++,t?.(s,e.length),await new Promise(e=>setTimeout(e,100))}return r},downloadFavicon:Qt,getFaviconUrl:Zt},Symbol.toStringTag,{value:"Module"}));function tr({shortcut:t}){const s=Zt(t),[o,n]=e.useState(s),[a,i]=e.useState(!1),l=e.useRef(!1),c=e.useRef(!1),d=((t.title||t.url||"?").trim().charAt(0)||"?").toUpperCase(),u=e.useCallback(()=>{const e="undefined"!=typeof location?location.href:"",r=e.includes("/src/newtab/")||e.includes("/newtab/");if(!("undefined"!=typeof navigator?navigator.userAgent.toLowerCase():"").includes("firefox")&&"undefined"!=typeof globalThis&&void 0!==globalThis.chrome&&!!globalThis.chrome?.runtime?.id&&r&&!l.current){l.current=!0;try{const e=`chrome://favicon2/?size=64&page_url=${encodeURIComponent(t.url)}`;if(e!==o)return n(e),void i(!1)}catch{}}if(!c.current){c.current=!0;try{const e=`https://icon.ooo/${new URL(t.url).hostname}?size=64&v=1`;if(e!==o)return n(e),void i(!1)}catch{}}i(!0)},[o,t.url]);return e.useEffect(()=>{n(s),i(!1),l.current=s.startsWith("chrome://favicon2/"),c.current=s.includes("icon.ooo")},[s]),r.jsx("div",{className:"aspect-square rounded-[4px] overflow-hidden liquid-glass-mini flex items-center justify-center",children:!a&&o?r.jsx("img",{src:o,alt:"",className:"w-full h-full object-cover rounded-[4px]",onError:u}):r.jsx("span",{className:"text-[8px] font-bold text-white/80",children:d})})}const rr={shortcut:e.memo(function({item:t,onRemove:s,isEditing:o,isBatchMode:n,isSelected:a,onToggleSelect:i,shortcutStyle:l="icon"}){const c=t.shortcut;if(!c)return null;const d=(c.title||"").trim()||(c.url||"").trim(),u=e=>{if(!o)return n?(e.preventDefault(),e.stopPropagation(),void i?.(t.id)):void 0;e.preventDefault()},m=Zt(c),[h,p]=e.useState(m),[x,g]=e.useState(!1),[f,w]=e.useState(!0),b=e.useRef(null),k=e.useRef(!1),v=e.useRef(!1),y=e.useCallback(()=>w(!1),[]),j=e.useCallback(()=>{const e="undefined"!=typeof location?location.href:"",t=e.includes("/src/newtab/")||e.includes("/newtab/");if(!("undefined"!=typeof navigator?navigator.userAgent.toLowerCase():"").includes("firefox")&&"undefined"!=typeof globalThis&&void 0!==globalThis.chrome&&!!globalThis.chrome?.runtime?.id&&t&&!k.current){k.current=!0;try{const e=`chrome://favicon2/?size=64&page_url=${encodeURIComponent(c.url)}`;if(e!==h)return p(e),g(!1),void w(!0)}catch{}}if(!v.current){v.current=!0;try{const e=`https://icon.ooo/${new URL(c.url).hostname}?size=64&v=1`;if(e!==h)return p(e),g(!1),void w(!0)}catch{}}g(!0),w(!1)},[h,c.url]);e.useEffect(()=>{p(m),g(!1),w(!0),k.current=m.startsWith("chrome://favicon2/"),v.current=m.includes("icon.ooo")},[m]),e.useEffect(()=>{const e=b.current;if(!e)return;const t=t=>{const r=e.getBoundingClientRect(),s=(t.clientX-r.left)/r.width*100,o=(t.clientY-r.top)/r.height*100;e.style.setProperty("--mouse-x",`${s}%`),e.style.setProperty("--mouse-y",`${o}%`)};return e.addEventListener("mousemove",t),()=>e.removeEventListener("mousemove",t)},[]);const I=(d.charAt(0)||"?").toUpperCase(),N=o||n?"div":"a",C=o||n?{role:"link",tabIndex:0}:{href:c.url};if("card"===l)return r.jsxs(N,{...C,onClick:u,className:"group relative flex items-center gap-3 h-full p-3 rounded-xl glass-card transition-all duration-200 cursor-pointer hover:scale-[1.02] active:scale-[0.98]",children:[n&&r.jsx("div",{className:"absolute top-2 right-2 z-30",children:a?r.jsx("div",{className:"w-4 h-4 rounded-full bg-blue-500 flex items-center justify-center",children:r.jsx("svg",{className:"w-2.5 h-2.5 text-white",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:r.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:3,d:"M5 13l4 4L19 7"})})}):r.jsx("div",{className:"w-4 h-4 rounded-full border border-white/40 bg-black/20"})}),r.jsxs("div",{ref:b,className:"relative flex-shrink-0 rounded-lg overflow-hidden",style:{width:"40px",height:"40px"},children:[f&&!x&&h&&r.jsx("div",{className:"absolute inset-0 bg-white/10 animate-pulse rounded-lg"}),!x&&h?r.jsx("img",{src:h,alt:d,draggable:!1,onDragStart:e=>e.preventDefault(),className:"w-full h-full object-cover transition-opacity duration-200 "+(f?"opacity-0":"opacity-100"),onLoad:y,onError:j}):r.jsx("div",{className:"w-full h-full flex items-center justify-center bg-white/10 rounded-lg",children:r.jsx("span",{className:"text-sm font-medium text-white/80",children:I})})]}),r.jsx("span",{className:"flex-1 text-sm text-white truncate",title:d,children:d})]});return r.jsxs(N,{...C,onClick:u,className:"group relative flex flex-col items-center justify-start h-full pt-2 px-2 rounded-xl transition-all duration-200 cursor-pointer",children:[r.jsxs("div",{ref:b,className:"relative liquid-glass-icon rounded-[12px] overflow-hidden hover:scale-110 active:scale-95 transition-all duration-200",style:{width:"56px",height:"56px"},children:[r.jsx("div",{className:"glass-refraction"}),n&&r.jsx("div",{className:"absolute top-1 right-1 z-30",children:a?r.jsx("div",{className:"w-3.5 h-3.5 rounded-full bg-blue-500 flex items-center justify-center",children:r.jsx("svg",{className:"w-2 h-2 text-white",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:r.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:3,d:"M5 13l4 4L19 7"})})}):r.jsx("div",{className:"w-3.5 h-3.5 rounded-full border border-white/40 bg-black/20"})}),f&&!x&&h&&r.jsx("div",{className:"absolute inset-0 z-20 bg-white/10 animate-pulse rounded-[12px]"}),!x&&h?r.jsx("img",{src:h,alt:d,draggable:!1,onDragStart:e=>{e.preventDefault()},className:"w-full h-full object-cover relative z-10 transition-opacity duration-200 "+(f?"opacity-0":"opacity-100"),onLoad:y,onError:j}):r.jsx("div",{className:"w-full h-full flex items-center justify-center relative z-10",children:r.jsx("span",{className:"text-lg font-medium text-white/80",children:I})})]}),r.jsx("span",{className:"mt-1.5 text-xs text-white truncate max-w-full px-1 drop-shadow-[0_1px_2px_rgba(0,0,0,0.8)]",title:d,style:{textShadow:"0 1px 3px rgba(0,0,0,0.9), 0 0 8px rgba(0,0,0,0.5)"},children:d})]})}),bookmarkFolder:e.memo(function({item:t,onRemove:s,isEditing:o,onOpenFolder:n,isBatchMode:a,isSelected:i,onToggleSelect:l}){const{setCurrentFolderId:c,gridItems:d}=gt(),u=t.bookmarkFolder?.title||"文件夹",m=e.useRef(null),h=e.useMemo(()=>d.filter(e=>(e.parentId??null)===t.id&&"shortcut"===e.type&&!!e.shortcut?.url).sort((e,t)=>e.position-t.position).slice(0,9).map(e=>e.shortcut),[d,t.id]);e.useEffect(()=>{const e=m.current;if(!e)return;const t=t=>{const r=e.getBoundingClientRect(),s=(t.clientX-r.left)/r.width*100,o=(t.clientY-r.top)/r.height*100;e.style.setProperty("--mouse-x",`${s}%`),e.style.setProperty("--mouse-y",`${o}%`)};return e.addEventListener("mousemove",t),()=>e.removeEventListener("mousemove",t)},[]);return r.jsxs("button",{type:"button",onClick:e=>o?(e.preventDefault(),void e.stopPropagation()):a?(e.preventDefault(),e.stopPropagation(),void l?.(t.id)):(e.preventDefault(),void n?.(t.id)),onDoubleClick:e=>{e.preventDefault(),e.stopPropagation(),n?n(t.id):c(t.id)},className:"group relative flex flex-col items-center justify-start h-full pt-2 px-2 rounded-xl transition-all duration-200 cursor-pointer w-full","aria-label":u,children:[r.jsxs("div",{ref:m,className:"relative liquid-glass-folder rounded-[12px] overflow-hidden hover:scale-110 active:scale-95 transition-all duration-200",style:{width:"56px",height:"56px"},children:[r.jsx("div",{className:"glass-refraction"}),a&&r.jsx("div",{className:"absolute top-1 right-1 z-30",children:i?r.jsx("div",{className:"w-3.5 h-3.5 rounded-full bg-blue-500 flex items-center justify-center",children:r.jsx("svg",{className:"w-2 h-2 text-white",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:r.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:3,d:"M5 13l4 4L19 7"})})}):r.jsx("div",{className:"w-3.5 h-3.5 rounded-full border border-white/40 bg-black/20"})}),h.length>0?r.jsxs("div",{className:"w-full h-full grid grid-cols-3 gap-0.5 content-start relative z-10",children:[h.slice(0,9).map((e,s)=>r.jsx(tr,{shortcut:e},`${t.id}-thumb-${s}`)),Array.from({length:Math.max(0,9-h.length)}).map((e,t)=>r.jsx("div",{className:"aspect-square rounded-[4px] bg-white/5"},`empty-${t}`))]}):r.jsx("div",{className:"w-full h-full flex items-center justify-center relative z-10",children:r.jsx(S,{className:"w-6 h-6 text-white/60"})})]}),r.jsx("span",{className:"mt-1.5 text-xs text-white truncate max-w-full px-1 drop-shadow-[0_1px_2px_rgba(0,0,0,0.8)]",style:{textShadow:"0 1px 3px rgba(0,0,0,0.9), 0 0 8px rgba(0,0,0,0.5)"},children:u})]})}),weather:At,clock:Mt,todo:Ut,notes:Ht,hotsearch:Xt,poetry:Vt},sr=e.memo(function({item:e,onUpdate:t,onRemove:s,isEditing:o=!1,onOpenFolder:n,isBatchMode:a,isSelected:i,onToggleSelect:l,shortcutStyle:c}){const d=rr[e.type],{cols:u,rows:m}=Ue(e.size);return d?r.jsx("div",{className:"widget-container h-full",style:{gridColumn:`span ${u}`,gridRow:`span ${m}`},children:r.jsx(d,{item:e,onUpdate:t,onRemove:s,isEditing:o,onOpenFolder:n,isBatchMode:a,isSelected:i,onToggleSelect:l,shortcutStyle:c})}):r.jsxs("div",{className:"flex items-center justify-center h-full text-white/50",children:["未知组件类型: ",e.type]})}),or={"1x1":"小 (1×1)","2x1":"宽 (2×1)","1x2":"高 (1×2)","2x2":"中 (2×2)","2x3":"大 (2×3)","2x4":"超大 (2×4)"},nr=e.memo(function({item:t,isOpen:s,onClose:o,onUpdate:n,onRemove:a}){const[i,l]=e.useState(t.config||{}),c=_e[t.type];if(!s)return null;const d=(e,r)=>{const s={...i,[t.type]:{...i[t.type],...r}};l(s),n(t.id,{config:s})};return B.createPortal(r.jsxs(r.Fragment,{children:[r.jsx("div",{className:"fixed inset-0 z-[100] bg-black/50 backdrop-blur-sm animate-fadeIn",onClick:o}),r.jsx("div",{className:"fixed top-1/2 left-1/2 z-[110] w-[360px] max-w-[90vw] animate-modalScaleIn",children:r.jsxs("div",{className:"glass rounded-2xl p-5 border border-white/10",children:[r.jsxs("div",{className:"flex items-center justify-between mb-4",children:[r.jsxs("h3",{className:"text-base font-medium text-white",children:[c.name," 设置"]}),r.jsx("button",{onClick:o,className:"p-1.5 rounded-xl hover:bg-white/10 transition-colors focus:outline-none focus:ring-2 focus:ring-white/20",children:r.jsx(y,{className:"w-4 h-4 text-white/60"})})]}),r.jsxs("div",{className:"space-y-4",children:[c.sizeConfig.allowedSizes.length>1&&r.jsxs("div",{children:[r.jsxs("label",{className:"flex items-center gap-2 text-sm text-white/60 mb-2",children:[r.jsx(F,{className:"w-4 h-4"}),"组件尺寸"]}),r.jsx("div",{className:"grid grid-cols-3 gap-2",children:c.sizeConfig.allowedSizes.map(e=>{const{cols:s,rows:o}=Ue(e);return r.jsxs("button",{onClick:()=>(e=>{n(t.id,{size:e})})(e),className:"p-2 rounded-lg border transition-all "+(t.size===e?"bg-blue-500/30 border-blue-500/50 text-white":"bg-white/5 border-white/10 text-white/70 hover:bg-white/10"),children:[r.jsx("div",{className:"flex justify-center mb-1",children:r.jsx("div",{className:"grid gap-0.5",style:{gridTemplateColumns:`repeat(${s}, 8px)`,gridTemplateRows:`repeat(${o}, 8px)`},children:Array.from({length:s*o}).map((s,o)=>r.jsx("div",{className:"rounded-sm "+(t.size===e?"bg-blue-400":"bg-white/40")},o))})}),r.jsx("span",{className:"text-xs",children:or[e]})]},e)})})]}),"clock"===t.type&&r.jsx(ar,{config:i.clock||{},onChange:e=>d(0,e)}),"weather"===t.type&&r.jsx(ir,{config:i.weather||{},onChange:e=>d(0,e)}),"todo"===t.type&&r.jsx(lr,{config:i.todo||{},onChange:e=>d(0,e)}),r.jsx("button",{onClick:()=>{a(t.id),o()},className:"w-full py-2 rounded-xl bg-red-500/20 text-red-400 hover:bg-red-500/30 transition-colors text-sm focus:outline-none focus:ring-2 focus:ring-red-500/30",children:"删除组件"})]})]})})]}),document.body)});function ar({config:e,onChange:t}){return r.jsxs("div",{className:"space-y-3",children:[r.jsx(cr,{label:"显示日期",checked:!1!==e.showDate,onChange:e=>t({showDate:e})}),r.jsx(cr,{label:"显示秒数",checked:!0===e.showSeconds,onChange:e=>t({showSeconds:e})}),r.jsx(cr,{label:"显示农历",checked:!0===e.showLunar,onChange:e=>t({showLunar:e})}),r.jsx(dr,{label:"时间格式",value:e.format||"24h",options:[{value:"24h",label:"24 小时制"},{value:"12h",label:"12 小时制"}],onChange:e=>t({format:e})})]})}function ir({config:e,onChange:t}){return r.jsx("div",{className:"space-y-3",children:r.jsx(dr,{label:"温度单位",value:e.unit||"C",options:[{value:"C",label:"摄氏度 (°C)"},{value:"F",label:"华氏度 (°F)"}],onChange:e=>t({unit:e})})})}function lr({config:e,onChange:t}){return r.jsx("div",{className:"space-y-3",children:r.jsx(cr,{label:"显示已完成",checked:!0===e.showCompleted,onChange:e=>t({showCompleted:e})})})}function cr({label:e,checked:t,onChange:s}){return r.jsxs("div",{className:"flex items-center justify-between",children:[r.jsx("span",{className:"text-sm text-white/80",children:e}),r.jsx("button",{onClick:()=>s(!t),className:"w-9 h-5 rounded-full transition-colors "+(t?"bg-blue-500":"bg-white/20"),children:r.jsx("div",{className:"w-3.5 h-3.5 rounded-full bg-white transition-transform mx-0.5 "+(t?"translate-x-4":"translate-x-0")})})]})}function dr({label:e,value:t,options:s,onChange:o}){return r.jsxs("div",{className:"flex items-center justify-between",children:[r.jsx("span",{className:"text-sm text-white/80",children:e}),r.jsx("select",{value:t,onChange:e=>o(e.target.value),className:"bg-white/10 text-white text-sm rounded-lg px-2 py-1 outline-none border border-white/10",children:s.map(e=>r.jsx("option",{value:e.value,className:"bg-gray-800",children:e.label},e.value))})]})}function ur({isOpen:t,title:s,message:o,actions:n,cancelText:a="取消",onCancel:i}){const[l,c]=e.useState(!1);if(e.useEffect(()=>{t?requestAnimationFrame(()=>c(!0)):c(!1)},[t]),e.useEffect(()=>{if(!t)return;const e=e=>{"Escape"===e.key&&i()};return window.addEventListener("keydown",e),()=>window.removeEventListener("keydown",e)},[t,i]),!t)return null;const d=()=>{c(!1),setTimeout(i,150)};return B.createPortal(r.jsx("div",{className:"fixed inset-0 flex items-end justify-center px-2 pb-24 transition-all duration-200 "+(l?"bg-black/60 backdrop-blur-sm opacity-100":"opacity-0"),style:{zIndex:Ft+10},onClick:d,children:r.jsxs("div",{role:"dialog","aria-label":s||"操作",className:"w-full max-w-[400px] transition-all duration-300 ease-out "+(l?"opacity-100 translate-y-0":"opacity-0 translate-y-4"),style:{zIndex:Dt+10},onClick:e=>e.stopPropagation(),children:[r.jsxs("div",{className:"backdrop-blur-xl rounded-[14px] overflow-hidden mb-2",style:{backgroundColor:"var(--ios-sheet-bg)"},children:[(s||o)&&r.jsxs(r.Fragment,{children:[r.jsxs("div",{className:"px-4 py-4 text-center",children:[s&&r.jsx("h3",{className:"text-[13px] font-semibold mb-0.5",style:{color:"var(--ios-text-muted)"},children:s}),o&&r.jsx("p",{className:"text-[13px] leading-relaxed",style:{color:"var(--ios-text-muted)"},children:o})]}),r.jsx("div",{className:"h-px",style:{backgroundColor:"var(--ios-divider)"}})]}),n.map((e,t)=>r.jsxs("div",{children:[r.jsx("button",{type:"button",onClick:()=>(e=>{c(!1),setTimeout(()=>e.onClick(),150)})(e),className:"w-full py-[18px] text-[20px] font-normal transition-colors",style:{color:"danger"===e.variant?"var(--ios-action-danger)":"var(--ios-action-primary)"},onMouseEnter:e=>e.currentTarget.style.backgroundColor="var(--ios-hover)",onMouseLeave:e=>e.currentTarget.style.backgroundColor="transparent",children:e.label}),t<n.length-1&&r.jsx("div",{className:"h-px",style:{backgroundColor:"var(--ios-divider)"}})]},t))]}),r.jsx("div",{className:"backdrop-blur-xl rounded-[14px] overflow-hidden",style:{backgroundColor:"var(--ios-sheet-bg)"},children:r.jsx("button",{type:"button",onClick:d,"aria-label":a,className:"w-full py-[18px] text-[20px] font-semibold transition-colors focus:outline-none",style:{color:"var(--ios-action-primary)"},onMouseEnter:e=>e.currentTarget.style.backgroundColor="var(--ios-hover)",onMouseLeave:e=>e.currentTarget.style.backgroundColor="transparent",children:a})})]})}),document.body)}function mr({isOpen:t,title:s,message:o,confirmText:n="确定",cancelText:a="取消",confirmVariant:i="default",onConfirm:l,onCancel:c}){const[d,u]=e.useState(!1);if(e.useEffect(()=>{t?requestAnimationFrame(()=>u(!0)):u(!1)},[t]),e.useEffect(()=>{if(!t)return;const e=e=>{"Escape"===e.key&&c()};return window.addEventListener("keydown",e),()=>window.removeEventListener("keydown",e)},[t,c]),!t)return null;const m=()=>{u(!1),setTimeout(c,150)};return B.createPortal(r.jsx("div",{className:"fixed inset-0 flex items-center justify-center p-4 transition-all duration-200 "+(d?"bg-black/60 backdrop-blur-md opacity-100":"opacity-0"),style:{zIndex:Ft+10},onClick:m,children:r.jsx("div",{role:"alertdialog","aria-labelledby":"confirm-title","aria-describedby":"confirm-message",className:"relative w-full max-w-[280px] rounded-[14px] overflow-hidden transition-all duration-200 ease-out "+(d?"opacity-100 scale-100":"opacity-0 scale-95"),style:{zIndex:Dt+10},onClick:e=>e.stopPropagation(),children:r.jsxs("div",{className:"backdrop-blur-xl",style:{backgroundColor:"var(--ios-sheet-bg)"},children:[r.jsxs("div",{className:"px-4 pt-5 pb-4 text-center",children:[r.jsx("h3",{id:"confirm-title",className:"text-[17px] font-semibold mb-1",style:{color:"var(--ios-text-primary)"},children:s}),r.jsx("p",{id:"confirm-message",className:"text-[13px] leading-relaxed",style:{color:"var(--ios-text-secondary)"},children:o})]}),r.jsx("div",{className:"h-px",style:{backgroundColor:"var(--ios-divider)"}}),r.jsxs("div",{className:"flex",children:[r.jsx("button",{type:"button",onClick:m,"aria-label":a,className:"flex-1 py-[11px] text-[17px] font-normal transition-colors focus:outline-none",style:{color:"var(--ios-action-primary)"},onMouseEnter:e=>e.currentTarget.style.backgroundColor="var(--ios-hover)",onMouseLeave:e=>e.currentTarget.style.backgroundColor="transparent",children:a}),r.jsx("div",{className:"w-px",style:{backgroundColor:"var(--ios-divider)"}}),r.jsx("button",{type:"button",onClick:()=>{u(!1),setTimeout(l,150)},"aria-label":n,className:"flex-1 py-[11px] text-[17px] font-semibold transition-colors focus:outline-none",style:{color:"danger"===i?"var(--ios-action-danger)":"var(--ios-action-primary)"},onMouseEnter:e=>e.currentTarget.style.backgroundColor="var(--ios-hover)",onMouseLeave:e=>e.currentTarget.style.backgroundColor="transparent",children:n})]})]})})}),document.body)}function hr({item:e,onOpenFolder:t,isBatchMode:s,isSelected:o,onToggleSelect:n}){const{attributes:a,listeners:i,setNodeRef:l,transform:c,transition:d,isDragging:u}=Te({id:e.id}),m={transform:T.Transform.toString(c),transition:d,opacity:u?.5:1};return r.jsx("div",{ref:l,style:m,...a,...i,onPointerUp:t=>{s&&n&&(u||(t.preventDefault(),t.stopPropagation(),n(e.id)))},className:"touch-none cursor-grab active:cursor-grabbing",children:r.jsx("div",{className:"h-[88px] w-[80px]",children:r.jsx(sr,{item:e,onOpenFolder:t,isEditing:!0,isBatchMode:s,isSelected:o,onToggleSelect:n})})})}function pr({folder:t,items:s,isOpen:o,onClose:n,onOpenFolder:a,isBatchMode:i,batchSelectedIds:l,onBatchSelectedIdsChange:c}){const{removeGridFolder:d,updateGridItem:u,browserBookmarksRootId:m,homeBrowserFolderId:h}=gt(),[p,x]=e.useState(!1),[g,f]=e.useState(t.bookmarkFolder?.title||"文件夹"),[w,b]=e.useState(!1),[k,v]=e.useState(!1),[j,I]=e.useState(!1),[N,C]=e.useState(t.parentId??null),S=e.useRef(null),F=e.useRef(null),T=!!t.browserBookmarkId,z=e.useMemo(()=>`folder-modal:${t.id}`,[t.id]),L=e.useMemo(()=>`folder-modal-outside:${t.id}`,[t.id]),A=e.useMemo(()=>`folder-modal-undock-parent:${t.id}:${N??"root"}`,[t.id,N]),{setNodeRef:M,isOver:R}=D({id:z}),{setNodeRef:$,isOver:P}=D({id:L}),{setNodeRef:O,isOver:_}=D({id:A,disabled:!1});if(e.useEffect(()=>{if(!o)return;requestAnimationFrame(()=>x(!0));const e=e=>{"Escape"===e.key&&n()};return window.addEventListener("keydown",e),()=>window.removeEventListener("keydown",e)},[o,n]),e.useEffect(()=>{o&&(f(t.bookmarkFolder?.title||"文件夹"),b(!1))},[t.bookmarkFolder?.title,o]),e.useEffect(()=>{C(t.parentId??null)},[t.parentId]),e.useEffect(()=>{o&&t.browserBookmarkId&&null===(t.parentId??null)&&"undefined"!=typeof chrome&&chrome.bookmarks&&(async()=>{try{const e=await chrome.bookmarks.get(t.browserBookmarkId),r=e?.[0],s=r?.parentId??null;if(!s)return;if(s===m||s===h)return void C(null);const o=gt.getState(),n=t.groupId&&"home"!==t.groupId?o.shortcutGroups.find(e=>e.id===t.groupId)?.bookmarkFolderId:void 0;if(n&&s===n)return void C(null);C(`bb-${s}`)}catch{}})()},[o,t.browserBookmarkId,t.parentId,t.groupId,m,h]),e.useEffect(()=>{w&&S.current&&(S.current.focus(),S.current.select())},[w]),e.useEffect(()=>{o||x(!1)},[o]),!o)return null;const U=N?"上一级":t.groupId&&"home"!==t.groupId?"分组":"首页",W=()=>{b(!1);const e=g.trim(),r=t.bookmarkFolder?.title||"文件夹";e&&e!==r?u(t.id,{bookmarkFolder:{...t.bookmarkFolder??{},title:e}}):f(r)},H=()=>{x(!1),setTimeout(n,200)};return B.createPortal(r.jsxs("div",{"data-folder-modal":"1",ref:$,className:`fixed inset-0 flex items-center justify-center p-4 transition-all duration-200 ${p?"bg-black/60 backdrop-blur-md opacity-100":"opacity-0"} ${P?"bg-black/70":""}`,style:{zIndex:Ft},onMouseDown:e=>{e.target===e.currentTarget&&H()},children:[r.jsxs("div",{role:"dialog","aria-label":g,className:"liquid-glass rounded-3xl w-full max-w-2xl shadow-2xl transition-all duration-200 ease-[cubic-bezier(0.33,1,0.68,1)] "+(p?"opacity-100 scale-100":"opacity-0 scale-95"),style:{zIndex:Dt},children:[r.jsxs("div",{className:"flex items-center justify-between px-6 py-4 border-b border-white/10",children:[r.jsx("div",{className:"flex items-center gap-2 flex-1 min-w-0",children:w?r.jsx("input",{ref:S,type:"text",value:g,onChange:e=>f(e.target.value),onBlur:W,onKeyDown:e=>{"Enter"===e.key&&W(),"Escape"===e.key&&(f(t.bookmarkFolder?.title||"文件夹"),b(!1))},className:"liquid-glass-mini border border-white/30 rounded-lg px-3 py-1.5 text-white text-lg font-medium focus:outline-none focus:ring-2 focus:ring-white/40 w-full max-w-[320px] transition-all"}):r.jsxs("button",{type:"button",onClick:()=>b(!0),className:"text-lg font-medium text-white truncate flex items-center gap-2 hover:text-blue-300 transition-colors",title:"点击重命名",children:[r.jsx("span",{className:"truncate",children:g}),r.jsx(E,{className:"w-4 h-4 opacity-60"})]})}),r.jsxs("div",{className:"flex items-center gap-2",children:[!T&&r.jsx("button",{type:"button",onClick:()=>{T||v(!0)},className:"p-2 rounded-full hover:bg-white/10 transition-colors text-red-400","aria-label":"删除文件夹",title:"删除文件夹",children:r.jsx(G,{className:"w-5 h-5"})}),r.jsx("button",{type:"button",onClick:H,className:"p-2 rounded-full hover:bg-white/10 transition-colors","aria-label":"关闭",children:r.jsx(y,{className:"w-5 h-5 text-white/70"})})]})]}),r.jsxs("div",{className:"px-6 py-5",children:[r.jsx("div",{ref:M,className:"rounded-2xl p-4 transition-colors "+(R?"bg-white/10":"bg-white/5"),children:r.jsx(Ee,{items:s.map(e=>e.id),strategy:Ge,children:r.jsx("div",{ref:F,onWheel:e=>{const t=e.currentTarget;if(t.scrollHeight<=t.clientHeight+1)return;e.preventDefault(),t.scrollBy({top:104*Math.sign(e.deltaY),behavior:"smooth"})},className:"overflow-y-auto pr-1",style:{height:"296px"},children:r.jsx("div",{className:"grid grid-cols-4 sm:grid-cols-5 gap-4 min-h-[140px]",children:0===s.length?r.jsx("div",{className:"col-span-full text-center py-10 text-white/50 text-sm",children:"文件夹为空"}):s.map(e=>r.jsx(hr,{item:e,onOpenFolder:a,isBatchMode:i,isSelected:l?.has(e.id),onToggleSelect:e=>{if(!c)return;const t=new Set(l??[]);t.has(e)?t.delete(e):t.add(e),c(t)}},e.id))})})})}),r.jsx("div",{className:"mt-4",children:r.jsxs("div",{ref:O,className:"rounded-2xl px-4 py-3 text-sm text-white/70 border border-dashed transition-colors "+(_?"bg-white/10 border-white/40":"bg-white/5 border-white/20"),title:t.parentId?"移到上一级文件夹":"移到首页",children:["移到上一级（",U,"）"]})})]})]}),r.jsx(ur,{isOpen:k,title:"删除文件夹",message:"选择删除方式",actions:[{label:"保留内容（移出文件夹）",onClick:()=>{v(!1),d(t.id,"keep"),x(!1),setTimeout(n,200)}},{label:"删除文件夹及全部内容",onClick:()=>{v(!1),I(!0)},variant:"danger"}],onCancel:()=>v(!1)}),r.jsx(mr,{isOpen:j,title:"确认删除",message:"确定删除文件夹及全部内容吗？此操作不可恢复。",confirmText:"删除",cancelText:"取消",confirmVariant:"danger",onConfirm:()=>{I(!1),d(t.id,"all"),x(!1),setTimeout(n,200)},onCancel:()=>I(!1)})]}),document.body)}function xr({item:e,onUpdate:t,onRemove:s,isEditing:o,onConfigClick:n,onOpenFolder:a,isBatchMode:i,isSelected:l,onToggleSelect:c,shortcutStyle:d}){const{cols:u,rows:m}=Ue(e.size),{attributes:h,listeners:p,setNodeRef:x,transform:g,transition:f,isDragging:w}=Te({id:e.id}),b={transform:T.Transform.toString(g),transition:f,gridColumn:`span ${u}`,gridRow:`span ${m}`,opacity:w?.5:1};return r.jsx("div",{ref:x,style:b,...h,...p,className:"touch-none cursor-grab active:cursor-grabbing",onDoubleClick:t=>{o&&"shortcut"!==e.type&&(t.preventDefault(),t.stopPropagation(),n?.(e))},children:r.jsx(sr,{item:e,onUpdate:t,onRemove:s,isEditing:o,onOpenFolder:a,isBatchMode:i,isSelected:l,onToggleSelect:c,shortcutStyle:d})})}const gr=e.memo(function({currentPage:e,totalPages:t,onPageChange:s}){return r.jsx("div",{className:"fixed bottom-28 left-1/2 -translate-x-1/2 flex justify-center items-center gap-3 py-2 px-4 rounded-full bg-black/20 backdrop-blur-sm",children:t<=1?r.jsx("div",{className:"w-3 h-3 rounded-full bg-white/50",style:{boxShadow:"0 1px 3px rgba(0,0,0,0.3)"}}):Array.from({length:t}).map((t,o)=>r.jsx("button",{onClick:()=>s(o),className:"rounded-full transition-all duration-300 "+(o===e?"w-8 h-3 bg-white":"w-3 h-3 bg-white/50 hover:bg-white/70"),style:{boxShadow:o===e?"0 0 12px rgba(255,255,255,0.8), 0 2px 4px rgba(0,0,0,0.3)":"0 1px 3px rgba(0,0,0,0.3)"},"aria-label":`切换到第 ${o+1} 页`},o))})}),fr=e.memo(function({isEditing:e,onToggle:t}){return r.jsx("div",{className:"fixed bottom-6 right-6 z-40",children:r.jsx("button",{onClick:t,className:"p-3 rounded-full shadow-lg transition-all "+(e?"bg-green-500 hover:bg-green-600 text-white":"glass hover:bg-white/20 text-white/70"),title:e?"完成编辑":"编辑布局",children:e?r.jsx(v,{className:"w-5 h-5"}):r.jsx(z,{className:"w-5 h-5"})})})}),wr=e.memo(function({filteredItems:e,batchSelectedIds:t,onBatchSelectedIdsChange:s}){const o=e.length>0&&e.every(e=>t.has(e.id));return r.jsx("div",{className:"fixed bottom-20 left-1/2 -translate-x-1/2 z-40 px-4 py-2 rounded-full glass text-sm text-white/80 animate-fadeIn",children:r.jsx("button",{onClick:()=>{const r=new Set(t);o?e.forEach(e=>r.delete(e.id)):e.forEach(e=>r.add(e.id)),s(r)},className:"px-3 py-1.5 rounded-full bg-white/10 hover:bg-white/20 transition-colors",children:o?"取消全选当前分组":"全选当前分组"})})}),br={6:"grid-cols-3 sm:grid-cols-4 md:grid-cols-5 lg:grid-cols-6",8:"grid-cols-4 sm:grid-cols-5 md:grid-cols-6 lg:grid-cols-8",10:"grid-cols-5 sm:grid-cols-6 md:grid-cols-8 lg:grid-cols-10"};function kr({columns:t,rows:s=4,isBatchMode:o,batchSelectedIds:n,onBatchSelectedIdsChange:a,isEditing:i=!1,onEditingChange:l}){const{gridItems:c,updateGridItem:d,removeGridItem:u,getFilteredGridItems:m,migrateToGridItems:h,currentFolderId:p,setCurrentFolderId:x,moveGridItemToFolder:g,mergeFolders:f,createFolderFromShortcuts:w,reorderGridItemsInCurrentScope:b,reorderGridItemsInFolderScope:k,settings:v}=gt(),[y,j]=e.useState(null),[I,N]=e.useState(null),[C,S]=e.useState(null),[F,D]=e.useState(null),[E,G]=e.useState(null),[T,z]=e.useState(null),{pushDndDebug:U}={pushDndDebug:e.useCallback(e=>{if("undefined"==typeof window)return;const t=window,r=t.__DND_DEBUG__??[];r.push(e),r.length>200&&r.splice(0,r.length-200),t.__DND_DEBUG__=r,t.__DND_DEBUG_LAST__=e},[])};!function(t,r){e.useEffect(()=>{if(!t)return;if("undefined"==typeof window)return;const e=()=>{r({type:"window.blur",id:t,ts:Date.now()})},s=()=>{r({type:"document.visibilitychange",id:t,state:document.visibilityState,ts:Date.now()})},o=e=>{r({type:"window.mouseup",id:t,button:e.button,buttons:e.buttons,clientX:e.clientX,clientY:e.clientY,ts:Date.now()})},n=e=>{r({type:"window.pointercancel",id:t,pointerType:e.pointerType,clientX:e.clientX,clientY:e.clientY,ts:Date.now()})},a=()=>{r({type:"window.contextmenu",id:t,ts:Date.now()})},i=e=>{"Escape"===e.key&&r({type:"window.keydown.esc",id:t,ts:Date.now()})};return window.addEventListener("blur",e),document.addEventListener("visibilitychange",s),window.addEventListener("mouseup",o,!0),window.addEventListener("pointercancel",n,!0),window.addEventListener("contextmenu",a,!0),window.addEventListener("keydown",i,!0),()=>{window.removeEventListener("blur",e),document.removeEventListener("visibilitychange",s),window.removeEventListener("mouseup",o,!0),window.removeEventListener("pointercancel",n,!0),window.removeEventListener("contextmenu",a,!0),window.removeEventListener("keydown",i,!0)}},[t,r])}(y,U),e.useEffect(()=>{h()},[h]);const W=m(),{currentPage:H,totalPages:K,paginatedItems:Y,setCurrentPage:X,goToNextPage:q,goToPrevPage:V,handleTouchStart:J,handleTouchMove:Q,handleTouchEnd:Z,handleWheel:ee}=function({items:t,columns:r,rows:s}){const[o,n]=e.useState(0),a=e.useRef(0),i=e.useRef(0),l=e.useRef(!1),c=e.useRef(),d=r*s,u=e.useMemo(()=>Math.max(1,Math.ceil(t.length/d)),[t.length,d]),m=e.useMemo(()=>{const e=o*d,r=e+d;return t.slice(e,r)},[t,o,d]);e.useMemo(()=>{o>=u&&u>0&&n(u-1)},[o,u]);const h=e.useCallback(()=>{n(e=>Math.min(e+1,u-1))},[u]),p=e.useCallback(()=>{n(e=>Math.max(e-1,0))},[]),x=e.useCallback(e=>{a.current=e.touches[0].clientX},[]),g=e.useCallback(e=>{i.current=e.touches[0].clientX},[]),f=e.useCallback(()=>{const e=a.current-i.current;e>50?h():e<-50&&p()},[h,p]),w=e.useCallback(e=>{if(l.current)return;const t=e.clientX,r=window.innerWidth;if(t>=.3*r&&t<=.7*r)Math.abs(e.deltaY)>30&&(l.current=!0,e.stopPropagation(),e.deltaY>0?h():p(),c.current&&clearTimeout(c.current),c.current=setTimeout(()=>{l.current=!1},300));else{const t=Math.abs(e.deltaX)>Math.abs(e.deltaY)?e.deltaX:e.shiftKey?e.deltaY:0;Math.abs(t)>30&&(l.current=!0,t>0?h():p(),c.current&&clearTimeout(c.current),c.current=setTimeout(()=>{l.current=!1},300))}},[h,p]);return{currentPage:o,totalPages:u,paginatedItems:m,setCurrentPage:n,goToNextPage:h,goToPrevPage:p,handleTouchStart:x,handleTouchMove:g,handleTouchEnd:f,handleWheel:w}}({items:W,columns:t,rows:s});e.useEffect(()=>{const e=e=>{e.target instanceof HTMLInputElement||e.target instanceof HTMLTextAreaElement||("ArrowLeft"===e.key?(e.preventDefault(),V()):"ArrowRight"===e.key&&(e.preventDefault(),q()))};return window.addEventListener("keydown",e),()=>window.removeEventListener("keydown",e)},[q,V]);const{handleDragStart:te,handleDragCancel:re,handleDragOver:se,handleDragEnd:oe}=function({gridItems:t,openFolderId:r,pushDndDebug:s,moveGridItemToFolder:o,reorderGridItemsInCurrentScope:n,reorderGridItemsInFolderScope:a,setFolderMergePrompt:i,setShortcutMergePrompt:l,setActiveId:c,setActiveItemSnapshot:d}){const u=e.useRef(null);return{handleDragStart:e.useCallback(e=>{const r=String(e.active.id);c(r);const o=t.find(e=>e.id===r)??null;d(o),u.current=null,s({type:"start",id:r,hasSnapshot:!!o,snapshotType:o?.type??null,ts:Date.now()})},[t,s,c,d]),handleDragCancel:e.useCallback(e=>{s({type:"cancel",id:String(e.active.id),lastOverId:u.current,ts:Date.now()}),c(null),d(null),u.current=null},[s,c,d]),handleDragOver:e.useCallback(e=>{const t=e.over?.id?String(e.over.id):null;u.current!==t&&(u.current=t,s({type:"over",id:String(e.active.id),overId:t,ts:Date.now()}))},[s]),handleDragEnd:e.useCallback(e=>{const{active:m,over:h}=e;if(s({type:"end",id:String(m.id),overId:h?.id?String(h.id):null,ts:Date.now()}),c(null),d(null),u.current=null,!h||m.id===h.id)return;const p=String(h.id);if(p.startsWith("folder-modal-undock-parent:")){const e=p.replace("folder-modal-undock-parent:",""),[r,s]=e.split(":"),n=s&&"root"!==s?s:null;if(!s){const e=t.find(e=>e.id===r);return void o(m.id,e?.parentId??null)}return void o(m.id,n)}if(r){const e=t.find(e=>e.id===String(m.id)),s=t.find(e=>e.id===String(h.id));if(e&&s&&(e.parentId??null)===r&&(s.parentId??null)===r)return void a(r,String(m.id),String(h.id))}const x=t.find(e=>e.id===h.id);if("bookmarkFolder"===x?.type){const e=t.find(e=>e.id===m.id);return"bookmarkFolder"===e?.type?void i({sourceId:String(m.id),targetId:x.id,sourceName:e.bookmarkFolder?.title||"文件夹",targetName:x.bookmarkFolder?.title||"文件夹"}):void o(m.id,x.id)}const g=t.find(e=>e.id===m.id);"shortcut"!==g?.type||"shortcut"!==x?.type?n(m.id,h.id):l({sourceId:String(m.id),targetId:String(h.id),sourceName:g.shortcut?.title||"快捷方式",targetName:x.shortcut?.title||"快捷方式"})},[t,r,s,o,n,a,i,l,c,d])}}({gridItems:c,openFolderId:F,pushDndDebug:U,moveGridItemToFolder:g,reorderGridItemsInCurrentScope:b,reorderGridItemsInFolderScope:k,setFolderMergePrompt:G,setShortcutMergePrompt:z,setActiveId:j,setActiveItemSnapshot:N}),ne=e.useMemo(()=>F?c.find(e=>e.id===F&&"bookmarkFolder"===e.type)??null:null,[c,F]),ae=e.useMemo(()=>ne?c.filter(e=>(e.parentId??null)===ne.id).sort((e,t)=>e.position-t.position):[],[c,ne]),ie=L(A(_,{activationConstraint:{distance:6}}),A(O,{activationConstraint:{delay:150,tolerance:5}}),A(P,{coordinateGetter:ze})),le=e.useCallback(()=>{E&&(f(E.sourceId,E.targetId),G(null))},[E,f]),ce=e.useCallback(()=>{T&&(w(T.sourceId,T.targetId),z(null))},[T,w]),de=e.useCallback(()=>{T&&(b(T.sourceId,T.targetId),z(null))},[T,b]),ue=e.useCallback(()=>{E&&(g(E.sourceId,E.targetId),G(null))},[E,g]),me=e.useCallback(e=>{D(e)},[]),he=e.useCallback(e=>{if(!a)return;const t=new Set(n??new Set);t.has(e)?t.delete(e):t.add(e),a(t)},[n,a]);e.useEffect(()=>{p&&(D(p),x(null))},[p,x]);const pe=I??(y?c.find(e=>e.id===y):null);return 0===W.length?r.jsx("div",{className:"flex flex-col items-center gap-3 text-white/50",children:r.jsx("span",{className:"text-sm",children:"当前分组没有内容"})}):r.jsxs(r.Fragment,{children:[r.jsxs(M,{sensors:ie,collisionDetection:R,onDragStart:te,onDragOver:se,onDragCancel:re,onDragEnd:oe,children:[r.jsx(Ee,{items:Y.map(e=>e.id),strategy:Ge,children:r.jsxs("div",{className:"relative",onTouchStart:J,onTouchMove:Q,onTouchEnd:Z,onWheel:ee,children:[r.jsx("div",{className:`grid ${br[t]} gap-4 auto-rows-[80px]`,children:Y.map(e=>r.jsx(xr,{item:e,onUpdate:d,onRemove:u,isEditing:i,onConfigClick:S,onOpenFolder:me,isBatchMode:o,isSelected:!!n?.has(e.id),onToggleSelect:he,shortcutStyle:v.shortcutStyle},e.id))}),r.jsx(gr,{currentPage:H,totalPages:K,onPageChange:X})]})}),"undefined"!=typeof document&&B.createPortal(r.jsx($,{zIndex:Gt,children:pe?r.jsx("div",{className:"opacity-80 pointer-events-none",children:r.jsx(sr,{item:pe,onOpenFolder:me,isEditing:!0,isBatchMode:o,isSelected:!!n?.has(pe.id),onToggleSelect:he,shortcutStyle:v.shortcutStyle})}):null}),document.body),ne&&r.jsx(pr,{folder:ne,items:ae,isOpen:!0,onClose:()=>D(null),onOpenFolder:me,isBatchMode:o,batchSelectedIds:n,onBatchSelectedIdsChange:a})]}),C&&r.jsx(nr,{item:C,isOpen:!!C,onClose:()=>S(null),onUpdate:d,onRemove:u}),r.jsx(fr,{isEditing:i,onToggle:()=>l?.(!i)}),o&&n&&a&&r.jsx(wr,{filteredItems:W,batchSelectedIds:n,onBatchSelectedIdsChange:a}),r.jsx(ur,{isOpen:!!E,title:"文件夹操作",message:`将「${E?.sourceName}」拖到了「${E?.targetName}」上`,actions:[{label:"合并文件夹",onClick:le},{label:"移入文件夹",onClick:ue}],onCancel:()=>G(null)}),r.jsx(ur,{isOpen:!!T,title:"创建文件夹",message:`将「${T?.sourceName}」拖到了「${T?.targetName}」上`,actions:[{label:"合并为文件夹",onClick:ce},{label:"仅调整顺序",onClick:de}],onCancel:()=>z(null)})]})}const vr="newtab_wallpaper_cache",yr="newtab_bing_info_cache";function jr({config:t,onRefresh:s}){const[o,n]=e.useState(null),[a,i]=e.useState(null),[c,d]=e.useState(!1),[u,m]=e.useState(!1);e.useEffect(()=>{"bing"===t.type?h():"unsplash"===t.type?p():"image"===t.type&&n(t.value)},[t.type,t.value,t.bingHistoryIndex]);const h=async(e=!1)=>{try{const r=t.bingHistoryIndex||0,s=`bing_${r}`;if(!e){const e=await x(s),t=await f(r);if(e&&t)return n(e),void i(t)}const o=`https://www.bing.com/HPImageArchive.aspx?format=js&idx=${r}&n=1&mkt=zh-CN`,a=await fetch(o),l=await a.json();if(l.images?.[0]){const t=l.images[0];let o=`https://www.bing.com${t.url}`;e&&(o+=`${o.includes("?")?"&":"?"}t=${Date.now()}`);const a={url:o,title:t.title||"",copyright:t.copyright||"",date:t.startdate||""};n(o),i(a),await g(s,o),await w(r,a)}}catch(r){}},p=async(e=!1)=>{try{if(!e){const e=await x("unsplash");if(e)return void n(e)}const t=`${Ie}?random=${Date.now()}`;n(t),await g("unsplash",t)}catch(t){}},x=async e=>{try{const t=(await chrome.storage.local.get(vr))[vr];if(t?.[e]){const r=Date.now()-t[e].timestamp;if(r<(e.startsWith("bing")?216e5:36e5))return t[e].url}}catch{}return null},g=async(e,t)=>{try{const r=(await chrome.storage.local.get(vr))[vr]||{};r[e]={url:t,timestamp:Date.now()},await chrome.storage.local.set({[vr]:r})}catch(r){}},f=async e=>{try{const t=(await chrome.storage.local.get(yr))[yr];if(t?.[e]){const r=Date.now()-t[e].timestamp;if(r<216e5)return t[e].info}}catch{}return null},w=async(e,t)=>{try{const r=(await chrome.storage.local.get(yr))[yr]||{};r[e]={info:t,timestamp:Date.now()},await chrome.storage.local.set({[yr]:r})}catch(r){}},b={filter:`blur(${t.blur}px) brightness(${t.brightness}%)`};if("color"===t.type)return r.jsx("div",{className:"absolute inset-0 z-0",style:{...b,backgroundColor:t.value}});const k="bing"===t.type||"unsplash"===t.type?o:t.value;return k?r.jsxs(r.Fragment,{children:[r.jsx("div",{className:"absolute inset-0 z-0 bg-cover bg-center bg-no-repeat",style:{...b,backgroundImage:`url(${k})`}}),("bing"===t.type||"unsplash"===t.type)&&r.jsxs("div",{className:"fixed bottom-6 right-24 z-50 flex items-center gap-2",children:["bing"===t.type&&t.showBingInfo&&a&&r.jsx("button",{onClick:()=>d(!c),className:"p-2 rounded-full glass-light hover:bg-white/20 transition-all group",title:"图片信息",children:r.jsx(U,{className:"w-4 h-4 text-white/80 group-hover:text-white"})}),r.jsx("button",{onClick:async()=>{if(!u){m(!0);try{"bing"===t.type?await h(!0):"unsplash"===t.type&&await p(!0),s?.()}catch(e){}finally{setTimeout(()=>m(!1),1e3)}}},disabled:u,className:"p-2 rounded-full glass-light hover:bg-white/20 transition-all group disabled:opacity-50",title:"刷新壁纸",children:r.jsx(l,{className:"w-4 h-4 text-white/80 group-hover:text-white "+(u?"animate-spin":"")})})]}),"bing"===t.type&&t.showBingInfo&&c&&a&&r.jsxs("div",{className:"fixed bottom-20 right-24 z-50 w-80 glass-modal-dark rounded-xl p-4 animate-fadeIn",children:[r.jsxs("div",{className:"flex items-start justify-between mb-3",children:[r.jsx("h3",{className:"text-sm font-medium text-white",children:"图片信息"}),r.jsx("button",{onClick:()=>d(!1),className:"p-1 rounded-full hover:bg-white/10 transition-colors",children:r.jsx(y,{className:"w-4 h-4 text-white/70"})})]}),r.jsxs("div",{className:"space-y-2 text-xs",children:[r.jsxs("div",{children:[r.jsx("div",{className:"text-white/50 mb-1",children:"标题"}),r.jsx("div",{className:"text-white/90",children:a.title})]}),r.jsxs("div",{children:[r.jsx("div",{className:"text-white/50 mb-1",children:"版权信息"}),r.jsx("div",{className:"text-white/90 leading-relaxed",children:a.copyright})]}),r.jsxs("div",{children:[r.jsx("div",{className:"text-white/50 mb-1",children:"日期"}),r.jsx("div",{className:"text-white/90",children:a.date.replace(/(\d{4})(\d{2})(\d{2})/,"$1-$2-$3")})]})]})]})]}):r.jsx("div",{className:"absolute inset-0 z-0",style:{backgroundColor:"var(--background)"}})}function Ir(e,t){if(t)return t;try{return`https://www.google.com/s2/favicons?domain=${new URL(e).hostname}&sz=64`}catch{return""}}function Nr({bookmark:e,isHovered:t,onHover:s,wasDragged:o,onRecordClick:n}){const{attributes:a,listeners:i,setNodeRef:l,transform:c,transition:d,isDragging:u}=Te({id:e.id}),m={transform:T.Transform.toString(c),transition:u?"none":d||"transform 0.2s",opacity:u?.5:1};return r.jsx("div",{ref:l,style:m,...a,...i,className:"relative cursor-grab active:cursor-grabbing",children:r.jsxs("a",{href:e.url,className:"relative block w-11 h-11 rounded-xl bg-white/10 hover:bg-white/20 active:scale-90 transition-all duration-200 overflow-hidden",style:{transform:t&&!u?"translateY(-8px) scale(1.15)":"translateY(0) scale(1)"},onMouseEnter:()=>s(e.id),onMouseLeave:()=>s(null),onClick:t=>{u||o?t.preventDefault():n(e.id)},children:[t&&!u&&r.jsx("div",{className:"absolute -top-10 left-1/2 -translate-x-1/2 px-3 py-1.5 rounded-lg bg-black/90 text-white text-xs whitespace-nowrap z-50 animate-fadeIn pointer-events-none",children:e.title}),r.jsx("img",{src:Ir(e.url,e.favicon),alt:e.title,className:"w-full h-full object-cover",onError:t=>{const r=t.currentTarget,s=`https://www.google.com/s2/favicons?domain=${new URL(e.url).hostname}&sz=64`;if(r.src.includes("google.com/s2/favicons")){r.style.display="none";const t=r.parentElement;if(t&&!t.querySelector(".fallback-letter")){const r=document.createElement("span");r.className="fallback-letter text-lg font-medium text-white/70",r.textContent=e.title.charAt(0).toUpperCase(),t.appendChild(r)}}else r.src=s}})]})})}function Cr(){const{syncState:t,pinnedBookmarks:s,fetchPinnedBookmarks:o,reorderPinnedBookmarks:n,recordBookmarkClick:a}=It(),[i,l]=e.useState(!1),[c,d]=e.useState(null),[u,m]=e.useState(!1),[h,p]=e.useState(!1),[x,g]=e.useState([]),[f,w]=e.useState(!1),b=e.useRef(!0),k=e.useRef(),v=L(A(W,{activationConstraint:{distance:8}}),A(P,{coordinateGetter:ze}));e.useEffect(()=>{g(s)},[s]),e.useEffect(()=>{o().finally(()=>{l(!0),b.current&&(b.current=!1,requestAnimationFrame(()=>{p(!0)}))})},[o]);return!i||t.error||0===x.length?null:r.jsx("div",{"data-dock-bar":"1",className:"fixed bottom-4 left-1/2 -translate-x-1/2 z-40 transition-opacity duration-300 "+(h?"opacity-100":"opacity-0"),children:r.jsx(M,{sensors:v,collisionDetection:R,onDragEnd:async e=>{const{active:t,over:r}=e;if(w(!0),k.current&&clearTimeout(k.current),k.current=setTimeout(()=>{w(!1)},200),!r||t.id===r.id)return;const s=x.findIndex(e=>e.id===t.id),o=x.findIndex(e=>e.id===r.id);if(-1!==s&&-1!==o){const e=[...x],[t]=e.splice(s,1);e.splice(o,0,t),g(e),await n(e.map(e=>e.id))}},children:r.jsx(Ee,{items:x.map(e=>e.id),strategy:Le,children:r.jsx("div",{className:"flex items-center gap-2 px-4 py-3 rounded-2xl glass-dark "+(u?"animate-pulse":""),onDoubleClick:async()=>{u||(m(!0),await o(!0),setTimeout(()=>m(!1),500))},title:"拖拽排序 | 双击同步最新",children:x.map(e=>r.jsx(Nr,{bookmark:e,isHovered:c===e.id,onHover:d,wasDragged:f,onRecordClick:a},e.id))})})})})}function Sr({userName:t}){const s=e.useMemo(()=>{const e=(new Date).getHours();return e>=5&&e<12?{text:"早上好",icon:"🌅"}:e>=12&&e<14?{text:"中午好",icon:"☀️"}:e>=14&&e<18?{text:"下午好",icon:"🌤️"}:e>=18&&e<22?{text:"晚上好",icon:"🌆"}:{text:"夜深了",icon:"🌙"}},[]);return r.jsx("div",{className:"text-center text-white select-none",children:r.jsxs("h2",{className:"text-2xl font-light text-shadow",children:[s.text,t&&r.jsx("span",{className:"ml-2",children:t})]})})}function Br(){const t=e.useMemo(()=>{const e=De.Lunar.fromDate(new Date);let t="";try{const r=e.getFestivals?.()||[],s=e.getJieQi?.()||"";t=r[0]||s||""}catch{}return{date:`${e.getMonthInChinese()}月${e.getDayInChinese()}`,year:`${e.getYearInGanZhi()}${e.getYearShengXiao()}年`,festival:t}},[]);return r.jsxs("div",{className:"text-center text-white/70 text-sm select-none",children:[r.jsxs("span",{children:[t.year," ",t.date]}),t.festival&&r.jsx("span",{className:"ml-2 px-2 py-0.5 rounded-full bg-white/10 text-xs",children:t.festival})]})}const Fr="newtab_poetry";function Dr(){const[t,s]=e.useState(null),o=()=>{const e=Math.floor(Math.random()*je.length),t=je[e];s(t);const r=(new Date).toDateString();chrome.storage.local.set({[Fr]:{poetry:t,date:r}})};return e.useEffect(()=>{chrome.storage.local.get(Fr).then(e=>{const t=e[Fr],r=(new Date).toDateString();t&&t.date===r?s(t.poetry):o()})},[]),t?r.jsxs("div",{className:"text-center text-white select-none group flex items-center justify-center gap-2",children:[r.jsxs("span",{className:"text-sm font-light tracking-wide text-shadow-sm",children:["「",t.content,"」"]}),r.jsxs("span",{className:"text-xs text-white/70 text-shadow-sm",children:["—— ",t.author,"《",t.title,"》"]}),r.jsx("button",{onClick:o,className:"p-1 rounded-full opacity-0 group-hover:opacity-100 hover:bg-white/10 transition-all inline-flex items-center",title:"换一首",children:r.jsx(l,{className:"w-3 h-3 text-white/50"})})]}):null}const Er={Home:oe,Briefcase:se,GraduationCap:re,Gamepad2:te,Wrench:ee,Code:Z,Music:Q,Film:J,ShoppingCart:V,Heart:q,Star:X,Bookmark:w,Folder:S,Globe:Y,Zap:K};function Gr(e){return Er[e]||S}function Tr({onOpenSettings:t}){const{shortcutGroups:s,activeGroupId:o,setActiveGroup:a,addGroup:i,removeGroup:l}=gt(),[c,d]=e.useState(!1),[u,m]=e.useState(""),[h,p]=e.useState("Folder"),[x,g]=e.useState(""),[f,w]=e.useState(null),[b,v]=e.useState(null);e.useEffect(()=>{(async()=>{const e=await Ce.getTMarksConfig();if(e?.bookmarkApiUrl){const t=e.bookmarkApiUrl.replace(/\/api\/?$/,"");g(t)}else g(Se().BASE_URL)})()},[]);const j=()=>{u.trim()&&(i(u.trim(),h),m(""),p("Folder"),d(!1))};return r.jsxs("div",{className:"fixed left-3 top-1/2 -translate-y-1/2 z-20 glass rounded-2xl p-2 animate-fadeIn flex flex-col gap-1",children:[s.map(e=>{const t="home"!==e.id,s=Gr(e.icon);return r.jsxs("div",{className:"relative",onMouseEnter:()=>w(e.id),onMouseLeave:()=>w(null),children:[r.jsx("button",{onClick:()=>a(e.id),"data-group-id":e.id,className:"w-11 h-11 rounded-xl flex items-center justify-center transition-all active:scale-90 "+(o===e.id?"bg-white/20 text-white":"text-white/50 hover:text-white/80 hover:bg-white/10"),title:e.name,children:r.jsx(s,{className:"w-4 h-4"})}),f===e.id&&r.jsxs("div",{className:"absolute left-full ml-2 px-2 py-1 rounded-lg bg-black/80 text-white text-xs whitespace-nowrap z-50 flex items-center gap-2",children:[e.name,t&&r.jsx(y,{className:"w-3 h-3 hover:text-red-400 cursor-pointer",onClick:t=>((e,t)=>{e.stopPropagation(),e.preventDefault(),v(t)})(t,e.id)})]})]},e.id)}),r.jsx("div",{className:"w-6 h-px bg-white/20 mx-auto my-1"}),r.jsxs("div",{className:"relative",children:[r.jsxs("button",{onClick:()=>d(!c),onMouseEnter:()=>w("add"),onMouseLeave:()=>w(null),className:"relative w-11 h-11 rounded-xl flex items-center justify-center text-white/50 hover:text-white/80 hover:bg-white/10 transition-all active:scale-90",title:"新建分组",children:[r.jsx(k,{className:"w-4 h-4"}),"add"===f&&!c&&r.jsx("div",{className:"absolute left-full ml-2 px-2 py-1 rounded-lg bg-black/80 text-white text-xs whitespace-nowrap z-50",children:"新建分组"})]}),c&&r.jsxs(r.Fragment,{children:[r.jsx("div",{className:"fixed inset-0 z-40",onClick:()=>d(!1)}),r.jsxs("div",{className:"absolute left-full top-0 ml-2 w-56 p-3 rounded-xl bg-gray-900/95 border border-white/10 shadow-2xl z-50 animate-scaleIn",children:[r.jsxs("div",{className:"flex items-center justify-between mb-2",children:[r.jsx("span",{className:"text-sm font-medium text-white",children:"新建分组"}),r.jsx("button",{onClick:()=>d(!1),className:"p-1 rounded hover:bg-white/10 transition-colors",children:r.jsx(y,{className:"w-3 h-3 text-white/60"})})]}),r.jsx("input",{type:"text",value:u,onChange:e=>m(e.target.value),placeholder:"分组名称",className:"w-full bg-white/10 text-white text-sm rounded-lg px-3 py-2 mb-3 outline-none border border-white/20 focus:border-blue-500/50 placeholder:text-white/40",autoFocus:!0,onKeyDown:e=>"Enter"===e.key&&j()}),r.jsx("div",{className:"grid grid-cols-5 gap-1.5 mb-3",children:Ne.map(e=>{const t=Gr(e);return r.jsx("button",{onClick:()=>p(e),className:"p-1.5 rounded-lg transition-all "+(h===e?"bg-blue-500/30 text-blue-400 ring-1 ring-blue-500/50":"text-white/50 hover:bg-white/10 hover:text-white/80"),children:r.jsx(t,{className:"w-4 h-4 mx-auto"})},e)})}),r.jsx("button",{onClick:j,disabled:!u.trim(),className:"w-full py-1.5 rounded-lg bg-blue-500/80 hover:bg-blue-500 text-white text-sm transition-colors disabled:opacity-40 disabled:cursor-not-allowed",children:"创建"})]})]})]}),x&&r.jsx("div",{className:"w-6 h-px bg-white/20 mx-auto my-1"}),x&&r.jsxs("button",{onClick:()=>window.open(x,"_blank"),onMouseEnter:()=>w("tmarks"),onMouseLeave:()=>w(null),className:"relative w-11 h-11 rounded-xl flex items-center justify-center text-white/50 hover:text-white/80 hover:bg-white/10 transition-all",title:"TMarks 书签",children:[r.jsx(n,{className:"w-4 h-4"}),"tmarks"===f&&r.jsx("div",{className:"absolute left-full ml-2 px-2 py-1 rounded-lg bg-black/80 text-white text-xs whitespace-nowrap z-50",children:"书签管理"})]}),r.jsx("div",{className:"w-6 h-px bg-white/20 mx-auto my-1"}),r.jsxs("button",{onClick:t,onMouseEnter:()=>w("settings"),onMouseLeave:()=>w(null),className:"relative w-11 h-11 rounded-xl flex items-center justify-center text-white/50 hover:text-white/80 hover:bg-white/10 transition-all",title:"设置",children:[r.jsx(H,{className:"w-4 h-4"}),"settings"===f&&r.jsx("div",{className:"absolute left-full ml-2 px-2 py-1 rounded-lg bg-black/80 text-white text-xs whitespace-nowrap z-50",children:"设置"})]}),r.jsx(mr,{isOpen:!!b,title:"删除分组",message:(()=>{const e=s.find(e=>e.id===b);return e?.bookmarkFolderId?"删除分组后，该分组的所有内容将被一并删除。确定删除？":"删除分组后，该分组的快捷方式将移到「首页」。确定删除？"})(),confirmText:"删除",cancelText:"取消",confirmVariant:"danger",onConfirm:()=>{b&&(l(b),v(null))},onCancel:()=>v(null)})]})}function zr({title:e,children:t}){return r.jsxs("div",{className:"bg-white/5 rounded-xl p-4",children:[r.jsx("h3",{className:"text-sm font-medium text-white/80 mb-4",children:e}),r.jsx("div",{className:"space-y-3",children:t})]})}function Lr({label:e,checked:t,onChange:s,disabled:o=!1}){return r.jsxs("div",{className:"flex items-center justify-between",children:[r.jsx("span",{className:"text-sm text-white/80",children:e}),r.jsx("button",{onClick:()=>{o||s(!t)},disabled:o,className:"w-10 h-6 rounded-full transition-colors "+(o?"bg-white/10 cursor-not-allowed":t?"bg-blue-500":"bg-white/20"),children:r.jsx("div",{className:"w-4 h-4 rounded-full bg-white transition-transform mx-1 "+(t?"translate-x-4":"translate-x-0")})})]})}function Ar({label:e,value:t,options:s,onChange:o}){return r.jsxs("div",{className:"flex items-center justify-between",children:[r.jsx("span",{className:"text-sm text-white/80",children:e}),r.jsx("select",{value:t,onChange:e=>o(e.target.value),className:"bg-white/10 text-white text-sm rounded-lg px-3 py-1.5 outline-none border border-white/10",children:s.map(e=>r.jsx("option",{value:e.value,className:"bg-gray-800",children:e.label},e.value))})]})}function Mr({label:e,value:t,onChange:s}){return r.jsxs("div",{className:"flex items-center justify-between",children:[r.jsx("span",{className:"text-sm text-white/80",children:e}),r.jsx("input",{type:"color",value:t,onChange:e=>s(e.target.value),className:"w-8 h-8 rounded cursor-pointer"})]})}function Rr({label:e,value:t,placeholder:s,onChange:o}){return r.jsxs("div",{className:"flex items-center justify-between gap-4",children:[r.jsx("span",{className:"text-sm text-white/80 flex-shrink-0",children:e}),r.jsx("input",{type:"text",value:t,placeholder:s,onChange:e=>o(e.target.value),className:"flex-1 bg-white/10 text-white text-sm rounded-lg px-3 py-1.5 outline-none border border-white/10"})]})}function $r({label:e,value:t,min:s,max:o,onChange:n}){return r.jsxs("div",{className:"flex items-center justify-between gap-4",children:[r.jsx("span",{className:"text-sm text-white/80",children:e}),r.jsxs("div",{className:"flex items-center gap-2",children:[r.jsx("input",{type:"range",value:t,min:s,max:o,onChange:e=>n(Number(e.target.value)),className:"w-24"}),r.jsx("span",{className:"text-xs text-white/60 w-8",children:t})]})]})}function Pr(){const{shortcuts:t,updateShortcut:s,gridItems:o,updateGridItem:n}=gt(),[a,i]=e.useState(!1),[l,c]=e.useState({current:0,total:0}),[d,u]=e.useState(null);e.useEffect(()=>{(async()=>{try{const e=await chrome.storage.local.getBytesInUse(),t=chrome.storage.local.QUOTA_BYTES||10485760;u({used:e,total:t})}catch(e){}})()},[a]);const m=t.length+o.filter(e=>"shortcut"===e.type).length,h=t.filter(e=>e.faviconBase64).length+o.filter(e=>"shortcut"===e.type&&e.shortcut?.faviconBase64).length,p=e=>e<1024?`${e} B`:e<1048576?`${(e/1024).toFixed(1)} KB`:`${(e/1024/1024).toFixed(2)} MB`;return r.jsxs("div",{className:"space-y-3",children:[r.jsxs("div",{className:"flex items-center justify-between",children:[r.jsxs("div",{className:"flex-1",children:[r.jsx("div",{className:"text-sm text-white/80",children:"下载并缓存所有图标"}),r.jsxs("div",{className:"text-xs text-white/50 mt-1",children:["已缓存 ",h," / ",m," 个图标"]}),d&&r.jsxs("div",{className:"text-xs text-white/40 mt-0.5",children:["存储占用: ",p(d.used)," / ",p(d.total),"(",(d.used/d.total*100).toFixed(1),"%)"]})]}),r.jsx("button",{onClick:async()=>{i(!0),c({current:0,total:0});try{const{batchDownloadFavicons:e}=await Be(async()=>{const{batchDownloadFavicons:e}=await Promise.resolve().then(()=>er);return{batchDownloadFavicons:e}},void 0);let r=0;if(t.length>0){const o=await e(t,(e,t)=>{c({current:e,total:t})});o.forEach((e,t)=>{s(t,{faviconBase64:e})}),r+=o.size}const a=o.filter(e=>"shortcut"===e.type&&e.shortcut);if(a.length>0){const s=await e(a.map(e=>({id:e.id,url:e.shortcut.url,favicon:e.shortcut.favicon,faviconBase64:e.shortcut.faviconBase64})),(e,r)=>{c({current:e+t.length,total:r+t.length})});s.forEach((e,t)=>{const r=o.find(e=>e.id===t);r?.shortcut&&n(t,{shortcut:{...r.shortcut,faviconBase64:e}})}),r+=s.size}alert(`成功缓存 ${r} 个图标`)}catch(e){alert("缓存图标失败，请重试")}finally{i(!1),c({current:0,total:0})}},disabled:a,className:"px-4 py-2 rounded-lg bg-blue-500 hover:bg-blue-600 disabled:bg-white/20 text-white text-sm transition-colors",children:a?"缓存中...":"立即缓存"})]}),a&&l.total>0&&r.jsxs("div",{className:"space-y-1",children:[r.jsx("div",{className:"w-full bg-white/10 rounded-full h-2 overflow-hidden",children:r.jsx("div",{className:"h-full bg-blue-500 transition-all duration-300",style:{width:l.current/l.total*100+"%"}})}),r.jsxs("div",{className:"text-xs text-white/50 text-center",children:[l.current," / ",l.total]})]}),r.jsx("div",{className:"text-xs text-white/40 leading-relaxed",children:"图标会自动压缩到 10KB 以内，离线时可正常显示"})]})}function Or(){const{settings:e,updateSettings:t}=gt();return r.jsxs("div",{className:"space-y-6",children:[r.jsxs(zr,{title:"个性化",children:[r.jsx(Lr,{label:"显示问候语",checked:e.showGreeting,onChange:e=>t({showGreeting:e})}),r.jsx(Rr,{label:"你的名字",value:e.userName,placeholder:"可选",onChange:e=>t({userName:e})})]}),r.jsxs(zr,{title:"时钟",children:[r.jsx(Lr,{label:"显示时钟",checked:e.showClock,onChange:e=>t({showClock:e})}),e.showClock&&r.jsxs(r.Fragment,{children:[r.jsx(Lr,{label:"显示日期",checked:e.showDate,onChange:e=>t({showDate:e})}),r.jsx(Lr,{label:"显示秒数",checked:e.showSeconds,onChange:e=>t({showSeconds:e})}),r.jsx(Lr,{label:"显示农历",checked:e.showLunar,onChange:e=>t({showLunar:e})}),r.jsx(Ar,{label:"时间格式",value:e.clockFormat,options:[{value:"24h",label:"24 小时制"},{value:"12h",label:"12 小时制"}],onChange:e=>t({clockFormat:e})})]})]}),r.jsx(zr,{title:"诗词",children:r.jsx(Lr,{label:"显示每日诗词",checked:e.showPoetry,onChange:e=>t({showPoetry:e})})}),r.jsxs(zr,{title:"搜索",children:[r.jsx(Lr,{label:"显示搜索框",checked:e.showSearch,onChange:e=>t({showSearch:e})}),r.jsx(Ar,{label:"搜索引擎",value:e.searchEngine,options:ke.map(e=>({value:e.id,label:e.name})),onChange:e=>t({searchEngine:e})})]}),r.jsx(zr,{title:"离线缓存",children:r.jsx(Pr,{})}),r.jsx(zr,{title:"使用说明",children:r.jsxs("div",{className:"text-sm text-white/70 leading-relaxed space-y-2",children:[r.jsx("div",{children:"1. 编辑模式下，双击文件夹可以进入文件夹。"}),r.jsx("div",{children:"2. 滚轮切换：左右两侧30%区域滚轮切换分组，中间40%区域滚轮切换图标翻页。"}),r.jsx("div",{children:"3. 单个分组图标过多时，可在图标区域滚动进行左右翻页。"})]})})]})}function _r(){const{settings:e,updateSettings:t}=gt();return r.jsxs("div",{className:"space-y-6",children:[r.jsxs(zr,{title:"快捷方式",children:[r.jsx(Lr,{label:"显示快捷方式",checked:e.showShortcuts,onChange:e=>t({showShortcuts:e})}),r.jsx(Ar,{label:"每行数量",value:String(e.shortcutColumns),options:[{value:"6",label:"6 个"},{value:"8",label:"8 个"},{value:"10",label:"10 个"}],onChange:e=>t({shortcutColumns:Number(e)})}),r.jsx(Ar,{label:"样式",value:e.shortcutStyle,options:[{value:"icon",label:"图标"},{value:"card",label:"卡片"}],onChange:e=>t({shortcutStyle:e})})]}),r.jsxs(zr,{title:"壁纸",children:[r.jsx(Ar,{label:"壁纸类型",value:e.wallpaper.type,options:[{value:"color",label:"纯色"},{value:"bing",label:"Bing 每日壁纸"},{value:"unsplash",label:"随机风景"},{value:"image",label:"自定义图片"}],onChange:r=>t({wallpaper:{...e.wallpaper,type:r}})}),"color"===e.wallpaper.type&&r.jsx(Mr,{label:"背景颜色",value:e.wallpaper.value,onChange:r=>t({wallpaper:{...e.wallpaper,value:r}})}),"bing"===e.wallpaper.type&&r.jsxs(r.Fragment,{children:[r.jsx(Ar,{label:"历史图片",value:String(e.wallpaper.bingHistoryIndex||0),options:[{value:"0",label:"今天"},{value:"1",label:"昨天"},{value:"2",label:"2 天前"},{value:"3",label:"3 天前"},{value:"4",label:"4 天前"},{value:"5",label:"5 天前"},{value:"6",label:"6 天前"},{value:"7",label:"7 天前"}],onChange:r=>t({wallpaper:{...e.wallpaper,bingHistoryIndex:Number(r)}})}),r.jsx(Lr,{label:"显示图片信息",checked:e.wallpaper.showBingInfo||!1,onChange:r=>t({wallpaper:{...e.wallpaper,showBingInfo:r}})})]}),"image"===e.wallpaper.type&&r.jsx(Rr,{label:"图片 URL",value:e.wallpaper.value,placeholder:"https://...",onChange:r=>t({wallpaper:{...e.wallpaper,value:r}})}),r.jsx($r,{label:"模糊",value:e.wallpaper.blur,min:0,max:20,onChange:r=>t({wallpaper:{...e.wallpaper,blur:r}})}),r.jsx($r,{label:"亮度",value:e.wallpaper.brightness,min:20,max:100,onChange:r=>t({wallpaper:{...e.wallpaper,brightness:r}})})]})]})}function Ur(){const{settings:t,updateSettings:s}=gt(),[o,n]=e.useState("");return e.useEffect(()=>{(async()=>{const e=await Ce.getTMarksConfig();if(e?.bookmarkApiUrl){const t=e.bookmarkApiUrl.replace(/\/api\/?$/,"");n(t)}else n(Se().BASE_URL)})()},[]),r.jsxs("div",{className:"space-y-6",children:[r.jsxs(zr,{title:"TMarks 同步",children:[r.jsx(Lr,{label:"显示置顶书签",checked:t.showPinnedBookmarks,onChange:e=>s({showPinnedBookmarks:e})}),r.jsx(Lr,{label:"搜索建议",checked:t.enableSearchSuggestions,onChange:e=>s({enableSearchSuggestions:e})}),o&&r.jsxs("a",{href:o,target:"_blank",rel:"noopener noreferrer",className:"flex items-center justify-between p-3 mt-2 rounded-lg bg-white/5 hover:bg-white/10 transition-colors",children:[r.jsx("span",{className:"text-sm text-white/70",children:"打开 TMarks 网站"}),r.jsx(N,{className:"w-4 h-4 text-white/50"})]}),r.jsx("div",{className:"text-xs text-white/40 mt-2",children:"在扩展设置中配置 API Key 以启用同步功能"})]}),r.jsxs(zr,{title:"自动刷新",children:[r.jsx(Lr,{label:"定时刷新置顶书签",checked:t.autoRefreshPinnedBookmarks,onChange:e=>s({autoRefreshPinnedBookmarks:e})}),t.autoRefreshPinnedBookmarks&&r.jsxs(r.Fragment,{children:[r.jsx(Ar,{label:"刷新时间",value:t.pinnedBookmarksRefreshTime,options:[{value:"morning",label:"早上 8:00"},{value:"evening",label:"晚上 22:00"}],onChange:e=>s({pinnedBookmarksRefreshTime:e})}),r.jsx("div",{className:"text-xs text-white/40 -mt-1 ml-1",children:"每天自动更新置顶书签缓存，保持数据最新"})]})]})]})}function Wr(){const{settings:t,updateSettings:s}=gt(),[o,n]=e.useState(!1),[a,i]=e.useState(null),[l,c]=e.useState(null),[d,u]=e.useState(!1),[m,h]=e.useState(null),[p,x]=e.useState([]),[g,f]=e.useState(!0);e.useEffect(()=>{if(!m)return;const e=e=>{if("AI_ORGANIZE_PROGRESS"!==String(e?.type??"").trim().toUpperCase())return;const t=e?.payload;t&&t.sessionId===m&&x(e=>{const r=[...e,t];return r.length>500?r.slice(r.length-500):r})};return chrome.runtime.onMessage.addListener(e),()=>{try{chrome.runtime.onMessage.removeListener(e)}catch{}}},[m]);const w=e.useCallback(()=>{x([])},[]),b=e.useCallback(()=>{u(!1),w()},[w]);return r.jsxs("div",{className:"space-y-6",children:[r.jsxs(zr,{title:"AI 整理",children:[r.jsx(Lr,{label:"启用 AI 整理",checked:t.enableWorkspaceAiOrganize??!0,onChange:e=>s({enableWorkspaceAiOrganize:e})}),r.jsx(Hr,{settings:t,updateSettings:s}),r.jsx(Kr,{settings:t,updateSettings:s}),r.jsx(Yr,{settings:t,updateSettings:s}),r.jsx(Xr,{settings:t,updateSettings:s}),r.jsx(qr,{settings:t,updateSettings:s}),r.jsx("button",{"data-ai-organize-btn":!0,onClick:async()=>{try{i(null),c(null);const e=`${Date.now()}-${Math.random().toString(16).slice(2)}`;h(e),x([{ts:Date.now(),level:"info",step:"ui",message:"已发起整理任务，等待后台进度..."}]),u(!0),n(!0);const r=await chrome.runtime.sendMessage({type:"AI_ORGANIZE_NEWTAB_WORKSPACE",payload:{sessionId:e,rules:t.workspaceAiOrganizeRules??"",maxBookmarks:t.workspaceAiOrganizeMaxBookmarks??300,enableHistoryHeat:t.enableHistoryHeat??!1,historyDays:t.historyDays??30,historyHeatTopN:t.historyHeatTopN??20,strictHierarchy:t.workspaceAiOrganizeStrictHierarchy??!1,allowNewFolders:!t.workspaceAiOrganizeStrictHierarchy&&(t.workspaceAiOrganizeAllowNewFolders??!0),preferOriginalPaths:t.workspaceAiOrganizePreferOriginalPaths??!0,verboseLogs:t.workspaceAiOrganizeVerboseLogs??!0,topLevelCount:t.workspaceAiOrganizeTopLevelCount??5,promptTemplate:t.enableWorkspaceAiOrganizeCustomPrompt?t.workspaceAiOrganizePrompt??"":void 0}});if(!r?.success)throw new Error(r?.error||"AI 整理失败");const s=r.data?.createdFolders??0,o=r.data?.createdBookmarks??0,a=r.data?.processed??r.data?.total??0,l=r.data?.truncated?"（已截断）":"";i(`整理完成：已处理 ${a} 个书签${l}，创建目录 ${s} 个，复制书签 ${o} 个`)}catch(e){c(e instanceof Error?e.message:"AI 整理失败")}finally{n(!1),h(null)}},disabled:o,className:"w-full px-4 py-2 rounded-lg bg-blue-500 hover:bg-blue-600 disabled:bg-white/20 text-white text-sm transition-colors",children:o?"整理中...":"开始 AI 整理工作区"}),r.jsx("button",{onClick:()=>u(!0),className:"w-full px-4 py-2 rounded-lg bg-white/10 hover:bg-white/15 text-white/80 text-sm transition-colors",children:"查看进度终端"}),a&&r.jsx("div",{className:"text-xs text-green-400",children:a}),l&&r.jsx("div",{className:"text-xs text-red-400",children:l}),r.jsx("div",{className:"text-xs text-white/40 leading-relaxed",children:"整理仅会在「TMarks」工作区内复制/重建目录结构，不会改动浏览器其它文件夹；如需备份，请在运行前自行手动备份。"})]}),d&&r.jsx(Vr,{logs:p,sessionId:m,autoScroll:g,onAutoScrollChange:f,onClear:w,onClose:b})]})}function Hr({settings:e,updateSettings:t}){return r.jsxs("div",{className:"space-y-2",children:[r.jsx("div",{className:"text-sm text-white/80",children:"自定义规则（可选）"}),r.jsx("textarea",{value:e.workspaceAiOrganizeRules??"",onChange:e=>t({workspaceAiOrganizeRules:e.target.value}),rows:6,placeholder:"示例：\n工作: github.com, jira., notion.so\n学习: coursera.org, edx.org\n娱乐: bilibili.com, youtube.com\n工具: translate.google.com, regex101.com",className:"w-full bg-white/10 text-white text-sm rounded-lg px-3 py-2 outline-none border border-white/10 font-mono"}),r.jsx("div",{className:"text-xs text-white/50",children:"规则会作为最高优先级提示给 AI。标签不可用时会参考原目录路径。"})]})}function Kr({settings:e,updateSettings:t}){const s=e.enableWorkspaceAiOrganizeCustomPrompt??!1;return r.jsxs("div",{className:"space-y-2",children:[r.jsxs("div",{className:"flex items-center justify-between",children:[r.jsx("div",{className:"text-sm text-white/80",children:"高级：自定义提示词模板"}),r.jsx("button",{type:"button",onClick:()=>t({enableWorkspaceAiOrganizeCustomPrompt:!s}),className:"px-3 py-1 rounded-lg text-xs font-medium transition-colors "+(s?"bg-blue-500 text-white hover:bg-blue-600":"bg-white/10 text-white/70 hover:bg-white/15"),children:s?"已启用":"已禁用"})]}),s&&r.jsxs(r.Fragment,{children:[r.jsx("textarea",{value:e.workspaceAiOrganizePrompt??"",onChange:e=>t({workspaceAiOrganizePrompt:e.target.value}),rows:10,placeholder:"可用变量：{{rules}} {{domainSummariesJson}}",className:"w-full bg-white/10 text-white text-sm rounded-lg px-3 py-2 outline-none border border-white/10 font-mono"}),r.jsxs("div",{className:"flex gap-2",children:[r.jsx("button",{type:"button",onClick:()=>t({workspaceAiOrganizePrompt:Ae}),className:"text-xs px-2 py-1 rounded-md bg-blue-500 hover:bg-blue-600 text-white transition-colors",children:"使用默认模板"}),r.jsx("button",{type:"button",onClick:()=>t({workspaceAiOrganizePrompt:""}),className:"text-xs px-2 py-1 rounded-md bg-white/10 hover:bg-white/15 text-white/80 transition-colors",children:"清空"})]}),r.jsx("div",{className:"text-xs text-white/50",children:'建议保持"只输出 JSON"的强约束，否则容易解析失败。'})]})]})}function Yr({settings:e,updateSettings:t}){return r.jsxs(r.Fragment,{children:[r.jsxs("div",{className:"flex flex-col gap-4",children:[r.jsxs("div",{className:"flex items-center justify-between gap-4",children:[r.jsx("div",{className:"text-sm text-white/80",children:"域名数上限"}),r.jsx("input",{type:"number",min:50,max:2e3,value:e.workspaceAiOrganizeMaxBookmarks??300,onChange:e=>t({workspaceAiOrganizeMaxBookmarks:Number(e.target.value)}),className:"w-28 bg-white/10 text-white text-sm rounded-lg px-3 py-1.5 outline-none border border-white/10"})]}),r.jsxs("div",{className:"flex items-center justify-between gap-4",children:[r.jsx("div",{className:"text-sm text-white/80",children:"期望的一级分类数量"}),r.jsx("input",{type:"number",min:2,max:7,value:e.workspaceAiOrganizeTopLevelCount??5,onChange:e=>{const r=Number(e.target.value);if(Number.isNaN(r))return;const s=Math.max(2,Math.min(7,Math.round(r)));t({workspaceAiOrganizeTopLevelCount:s})},className:"w-28 bg-white/10 text-white text-sm rounded-lg px-3 py-1.5 outline-none border border-white/10"})]})]}),r.jsxs("div",{className:"text-xs text-white/50 -mt-1 space-y-1",children:[r.jsx("p",{children:'为避免 AI Prompt 过大，这里限制参与分类规划的"域名数量"（按书签数量排序取前 N 个域名）。整理仍会应用到工作区全部书签。'}),r.jsx("p",{children:'当域名超过该上限时，会按此上限拆分为多批发送；AI 会在日志中看到"已拆分多批，收到全部批次后才输出"。'}),r.jsx("p",{children:"一级分类数量推荐 2-7 个，AI 会尽量按照你设定的数量生成顶级目录，超出限制的分组会被合并。"})]})]})}function Xr({settings:e,updateSettings:t}){const s=e.enableHistoryHeat??!1;return r.jsxs(r.Fragment,{children:[r.jsx(Lr,{label:"读取浏览器历史热度",checked:s,onChange:e=>t({enableHistoryHeat:e})}),s&&r.jsxs(r.Fragment,{children:[r.jsxs("div",{className:"flex flex-col gap-3",children:[r.jsxs("div",{className:"flex items-center justify-between gap-4",children:[r.jsx("div",{className:"text-sm text-white/80",children:"历史统计天数"}),r.jsx("input",{type:"number",min:1,max:90,value:e.historyDays??30,onChange:e=>{const r=Number(e.target.value);Number.isNaN(r)||t({historyDays:r})},className:"w-28 bg-white/10 text-white text-sm rounded-lg px-3 py-1.5 outline-none border border-white/10"})]}),r.jsxs("div",{className:"flex items-center justify-between gap-4",children:[r.jsx("div",{className:"text-sm text-white/80",children:"历史热度优先 Top N"}),r.jsx("input",{type:"number",min:5,max:100,value:e.historyHeatTopN??20,onChange:e=>{const r=Number(e.target.value);Number.isNaN(r)||t({historyHeatTopN:r})},className:"w-28 bg-white/10 text-white text-sm rounded-lg px-3 py-1.5 outline-none border border-white/10"})]})]}),r.jsxs("div",{className:"text-xs text-white/50 -mt-1 space-y-1",children:[r.jsx("p",{children:"启用后会统计最近 N 天的浏览记录来评估域名热度，用于决定目录层级。"}),r.jsx("p",{children:"Top N 域名会在 Prompt 中单独高亮，AI 会优先把它们放在一级目录或首页推荐区域（默认 20，可根据需要调节，范围 5-100）。"})]})]})]})}function qr({settings:e,updateSettings:t}){return r.jsxs("div",{className:"space-y-3 pt-2",children:[r.jsx("div",{className:"text-sm text-white/80",children:"层级策略"}),r.jsxs("div",{className:"space-y-1",children:[r.jsx(Lr,{label:"严格沿用现有目录结构（仅合并/拆分/重命名）",checked:e.workspaceAiOrganizeStrictHierarchy??!1,onChange:e=>{t({workspaceAiOrganizeStrictHierarchy:e,...e?{workspaceAiOrganizeAllowNewFolders:!1}:{}})}}),r.jsx("div",{className:"text-xs text-white/50 ml-6 -mt-1",children:"开启后，AI 只能在原有目录层级基础上微调，不得新增新的一级目录。"})]}),r.jsxs("div",{className:"space-y-1",children:[r.jsx(Lr,{label:"允许新增目录（严格模式下自动失效）",checked:e.workspaceAiOrganizeAllowNewFolders??!0,onChange:e=>t({workspaceAiOrganizeAllowNewFolders:e}),disabled:e.workspaceAiOrganizeStrictHierarchy??!1}),r.jsx("div",{className:"text-xs text-white/50 ml-6 -mt-1",children:"关闭后，AI 只能把域名放入现有目录，不会创建新目录名称。"})]}),r.jsxs("div",{className:"space-y-1",children:[r.jsx(Lr,{label:"优先保留域名原有的目录路径",checked:e.workspaceAiOrganizePreferOriginalPaths??!0,onChange:e=>t({workspaceAiOrganizePreferOriginalPaths:e})}),r.jsx("div",{className:"text-xs text-white/50 ml-6 -mt-1",children:"开启后，AI 会尽量把域名放回其历史常用目录，仅在冲突或规则要求时才调整。"})]}),r.jsxs("div",{className:"space-y-1",children:[r.jsx(Lr,{label:"输出详细日志",checked:e.workspaceAiOrganizeVerboseLogs??!0,onChange:e=>t({workspaceAiOrganizeVerboseLogs:e})}),r.jsx("div",{className:"text-xs text-white/50 ml-6 -mt-1",children:"关闭后，仅保留关键步骤日志；开启则展示全部进度，便于排查问题。"})]})]})}function Vr({logs:e,sessionId:t,autoScroll:s,onAutoScrollChange:o,onClear:n,onClose:a}){return r.jsx("div",{className:"fixed inset-0 bg-black/70 flex items-center justify-center",style:{zIndex:Dt+1},onClick:a,children:r.jsxs("div",{className:"w-[900px] max-w-[95%] h-[460px] rounded-2xl bg-black/80 border border-white/10 overflow-hidden flex flex-col",onClick:e=>e.stopPropagation(),children:[r.jsxs("div",{className:"flex items-center justify-between px-4 py-3 border-b border-white/10",children:[r.jsx("div",{className:"text-sm font-medium text-white/90",children:"AI 整理终端"}),r.jsxs("div",{className:"flex items-center gap-3",children:[r.jsxs("label",{className:"flex items-center gap-2 text-xs text-white/70 select-none",children:[r.jsx("input",{type:"checkbox",checked:s,onChange:e=>o(e.target.checked),className:"accent-blue-500"}),"自动滚动"]}),r.jsx("button",{onClick:n,className:"text-xs px-2 py-1 rounded-md bg-white/10 hover:bg-white/15 text-white/80",children:"清空"}),r.jsx("button",{onClick:a,className:"p-2 rounded-full hover:bg-white/10 transition-colors",children:r.jsx(y,{className:"w-4 h-4 text-white/70"})})]})]}),r.jsx("div",{className:"flex-1 overflow-y-auto px-4 py-3 font-mono text-xs leading-relaxed",ref:e=>{e&&s&&setTimeout(()=>{try{e.scrollTop=e.scrollHeight}catch{}},0)},children:0===e.length?r.jsx("div",{className:"text-white/50",children:"暂无日志"}):r.jsx("div",{className:"space-y-2",children:e.map((e,t)=>{const s="number"==typeof e.ts?new Date(e.ts).toLocaleTimeString():"",o=String(e.level||"info"),n="error"===o?"text-red-300":"warn"===o?"text-yellow-300":"success"===o?"text-green-300":"text-white/80";return r.jsxs("div",{className:"whitespace-pre-wrap break-words",children:[r.jsxs("div",{className:n,children:["[",s,"] [",o,"] [",String(e.step||""),"] ",String(e.message||"")]}),void 0!==e.detail&&null!==e.detail&&r.jsx("div",{className:"text-white/50 mt-1",children:(()=>{try{return JSON.stringify(e.detail,null,2)}catch{return String(e.detail)}})()})]},t)})})}),r.jsxs("div",{className:"px-4 py-3 border-t border-white/10 flex items-center justify-between gap-3",children:[r.jsxs("div",{className:"text-xs text-white/50 truncate",children:["Session: ",t||"-"]}),r.jsx("button",{onClick:()=>{try{const t=e.map(e=>{const t=`[${"number"==typeof e.ts?new Date(e.ts).toISOString():""}] [${String(e.level||"")}] [${String(e.step||"")}] ${String(e.message||"")}`;if(void 0===e.detail||null===e.detail)return t;try{return`${t}\n${JSON.stringify(e.detail,null,2)}`}catch{return`${t}\n${String(e.detail)}`}}).join("\n");navigator.clipboard.writeText(t)}catch{}},className:"text-xs px-3 py-1.5 rounded-md bg-blue-500 hover:bg-blue-600 text-white",children:"复制日志"})]})]})})}const Jr=[{id:"general",label:"常规",icon:ne},{id:"appearance",label:"外观",icon:ae},{id:"sync",label:"同步",icon:a},{id:"ai",label:"AI 整理",icon:ie}];function Qr({onClose:t}){const[s,o]=e.useState("general");return B.createPortal(r.jsx("div",{className:"fixed inset-0 flex items-center justify-center bg-black/60 animate-fadeIn",style:{zIndex:Ft},onClick:t,children:r.jsxs("div",{className:"relative w-full max-w-4xl h-[600px] rounded-2xl glass-modal-dark flex flex-col overflow-hidden",style:{zIndex:Dt,animation:"modalScale 0.2s ease-out"},onClick:e=>e.stopPropagation(),children:[r.jsxs("div",{className:"flex items-center justify-between px-6 py-4 border-b border-white/10",children:[r.jsx("h2",{className:"text-lg font-medium text-white",children:"设置"}),r.jsx("button",{onClick:t,className:"p-2 rounded-full hover:bg-white/10 transition-colors",children:r.jsx(y,{className:"w-5 h-5 text-white/70"})})]}),r.jsxs("div",{className:"flex-1 flex overflow-hidden",children:[r.jsx("div",{className:"w-48 flex-shrink-0 border-r border-white/10 py-2",children:Jr.map(e=>{const t=e.icon;return r.jsxs("button",{onClick:()=>o(e.id),className:"w-full flex items-center gap-3 px-4 py-3 text-sm font-medium transition-colors relative "+(s===e.id?"text-white bg-white/10":"text-white/60 hover:text-white hover:bg-white/5"),children:[r.jsx(t,{className:"w-4 h-4"}),e.label,s===e.id&&r.jsx("div",{className:"absolute left-0 top-0 bottom-0 w-0.5 bg-blue-500"})]},e.id)})}),r.jsxs("div",{className:"flex-1 overflow-y-auto p-6",children:["general"===s&&r.jsx(Or,{}),"appearance"===s&&r.jsx(_r,{}),"sync"===s&&r.jsx(Ur,{}),"ai"===s&&r.jsx(Wr,{})]})]})]})}),document.body)}function Zr({isOpen:t,onClose:s,onAdd:o,groupName:n}){const[a,i]=e.useState(""),[l,c]=e.useState(""),[d,u]=e.useState("");if(!t)return null;const m=()=>{if(u(""),a.trim())try{const e=a.startsWith("http")?a:`https://${a}`;new URL(e);const t=new URL(e).hostname,r=l.trim()||t;o(e,r),i(""),c(""),s()}catch{u("无效的网址格式")}else u("请输入网址")},h=e=>{"Enter"===e.key?m():"Escape"===e.key&&s()};return B.createPortal(r.jsxs("div",{className:"fixed inset-0 flex items-center justify-center animate-fadeIn",style:{zIndex:Ft},children:[r.jsx("div",{className:"absolute inset-0 bg-black/60",onClick:s}),r.jsx("div",{className:"relative w-[400px] max-w-[90vw]",style:{zIndex:Dt,animation:"modalScale 0.2s ease-out"},children:r.jsxs("div",{className:"glass-modal rounded-2xl p-6",children:[r.jsxs("div",{className:"flex items-center justify-between mb-6",children:[r.jsxs("h3",{className:"text-lg font-medium text-white",children:["添加快捷方式",n&&r.jsxs("span",{className:"ml-2 text-sm text-white/50",children:["到 ",n]})]}),r.jsx("button",{onClick:s,className:"p-1.5 rounded-lg hover:bg-white/10 transition-colors",children:r.jsx(y,{className:"w-5 h-5 text-white/60"})})]}),r.jsxs("div",{className:"space-y-4",children:[r.jsxs("div",{children:[r.jsxs("label",{className:"flex items-center gap-2 text-sm text-white/60 mb-2",children:[r.jsx(le,{className:"w-4 h-4"}),"网址"]}),r.jsx("input",{type:"text",value:a,onChange:e=>i(e.target.value),onKeyDown:h,placeholder:"https://example.com",className:"w-full bg-white/10 text-white text-sm rounded-xl px-4 py-3 outline-none border border-white/20 focus:border-blue-500/50 placeholder:text-white/30 transition-colors",autoFocus:!0})]}),r.jsxs("div",{children:[r.jsxs("label",{className:"flex items-center gap-2 text-sm text-white/60 mb-2",children:[r.jsx(ce,{className:"w-4 h-4"}),"名称 ",r.jsx("span",{className:"text-white/30",children:"(可选)"})]}),r.jsx("input",{type:"text",value:l,onChange:e=>c(e.target.value),onKeyDown:h,placeholder:"自动获取域名",className:"w-full bg-white/10 text-white text-sm rounded-xl px-4 py-3 outline-none border border-white/20 focus:border-blue-500/50 placeholder:text-white/30 transition-colors"})]}),d&&r.jsx("p",{className:"text-sm text-red-400",children:d})]}),r.jsxs("div",{className:"flex gap-3 mt-6",children:[r.jsx("button",{onClick:s,className:"flex-1 py-2.5 rounded-xl bg-white/10 hover:bg-white/20 text-white/70 text-sm transition-colors",children:"取消"}),r.jsx("button",{onClick:m,className:"flex-1 py-2.5 rounded-xl bg-blue-500/80 hover:bg-blue-500 text-white text-sm transition-colors",children:"添加"})]})]})})]}),document.body)}function es({isOpen:t,onClose:s,onSave:o,initialName:n}){const[a,i]=e.useState("");if(e.useEffect(()=>{i(n||"")},[n,t]),!t)return null;return B.createPortal(r.jsx("div",{className:"fixed inset-0 flex items-center justify-center bg-black/60 animate-fadeIn",style:{zIndex:Ft},onClick:s,children:r.jsxs("div",{className:"relative w-80 rounded-2xl glass-modal-dark overflow-hidden",style:{zIndex:Dt,animation:"modalScale 0.2s ease-out"},onClick:e=>e.stopPropagation(),children:[r.jsxs("div",{className:"flex items-center justify-between px-4 py-3 border-b border-white/10",children:[r.jsxs("div",{className:"flex items-center gap-2",children:[r.jsx(S,{className:"w-5 h-5 text-white/70"}),r.jsx("h3",{className:"text-base font-medium text-white",children:"新建文件夹"})]}),r.jsx("button",{onClick:s,className:"p-1.5 rounded-lg hover:bg-white/10 transition-colors",children:r.jsx(y,{className:"w-4 h-4 text-white/60"})})]}),r.jsxs("form",{onSubmit:e=>{e.preventDefault(),a.trim()&&(o(a.trim()),i(""),s())},className:"p-4",children:[r.jsx("input",{type:"text",value:a,onChange:e=>i(e.target.value),placeholder:"文件夹名称",className:"w-full bg-white/10 text-white text-sm rounded-lg px-3 py-2.5 outline-none border border-white/10 focus:border-white/30 placeholder-white/40",autoFocus:!0}),r.jsxs("div",{className:"flex gap-2 mt-4",children:[r.jsx("button",{type:"button",onClick:s,className:"flex-1 py-2 rounded-lg bg-white/10 hover:bg-white/20 transition-colors text-white/70 text-sm",children:"取消"}),r.jsx("button",{type:"submit",disabled:!a.trim(),className:"flex-1 py-2 rounded-lg bg-blue-500 hover:bg-blue-600 disabled:opacity-50 disabled:cursor-not-allowed transition-colors text-white text-sm",children:"创建"})]})]})]})}),document.body)}function ts({isOpen:t,onClose:s,selectedIds:o,onSelectedIdsChange:n}){const{shortcutGroups:a,getFilteredGridItems:i,removeGridItem:l,updateGridItem:c,activeGroupId:d,currentFolderId:u,gridItems:m,cleanupAllEmptyFolders:h,cleanupEmptyGroups:p}=gt(),[x,g]=e.useState(""),[f,w]=e.useState(!1),b=e.useMemo(()=>i().sort((e,t)=>e.position-t.position),[i,d,u,m]);if(e.useEffect(()=>{t||g("")},[t]),!t)return null;const k=()=>{n(new Set),g(""),s()},v=b.length>0&&b.every(e=>o.has(e.id));return B.createPortal(r.jsxs(r.Fragment,{children:[r.jsx("div",{className:"fixed bottom-20 left-1/2 -translate-x-1/2",style:{zIndex:Et},children:r.jsxs("div",{className:"flex items-center justify-between gap-3 px-4 py-3 rounded-2xl glass-dark shadow-2xl w-[min(920px,calc(100vw-32px))]",style:{backdropFilter:"blur(16px) saturate(180%)",WebkitBackdropFilter:"blur(16px) saturate(180%)",border:"1px solid rgba(255,255,255,0.12)",boxShadow:"0 18px 42px rgba(0,0,0,0.42)"},children:[r.jsx("button",{onClick:()=>{if(b.length>0&&b.every(e=>o.has(e.id))){const e=new Set(o);b.forEach(t=>e.delete(t.id)),n(e)}else{const e=new Set(o);b.forEach(t=>e.add(t.id)),n(e)}},className:"px-3 py-1.5 rounded-full bg-white/10 hover:bg-white/20 transition-colors text-xs text-white/80",children:v?"取消全选":"全选"}),r.jsxs("span",{className:"flex items-center gap-1 text-xs text-white/70 min-w-[76px]",children:[r.jsx(de,{className:"w-3.5 h-3.5"}),"已选 ",o.size]}),r.jsx("div",{className:"h-5 w-px bg-white/15"}),r.jsxs("div",{className:"flex items-center gap-2 flex-shrink-0",children:[r.jsx("button",{onClick:k,className:"px-3 py-1.5 rounded-full bg-green-500/20 text-green-300 hover:bg-green-500/30 transition-colors text-xs",children:"完成"}),r.jsx("button",{onClick:k,className:"px-3 py-1.5 rounded-full bg-white/10 hover:bg-white/20 transition-colors text-xs text-white/80",children:"取消"}),r.jsx("button",{onClick:()=>{0!==o.size&&w(!0)},disabled:0===o.size,className:"px-3 py-1.5 rounded-full bg-red-500/20 text-red-300 hover:bg-red-500/30 transition-colors disabled:opacity-30 text-xs",children:"删除"})]}),r.jsx("div",{className:"h-5 w-px bg-white/15"}),r.jsxs("div",{className:"flex items-center gap-2 flex-1 justify-end min-w-0",children:[r.jsx(ue,{className:"w-4 h-4 text-white/70"}),r.jsxs("select",{value:x,onChange:e=>g(e.target.value),className:"bg-white/10 text-white text-xs rounded-xl px-3 py-2 outline-none border border-white/15 min-w-[140px] max-w-[280px]",children:[r.jsx("option",{value:"",children:"选择分组"}),a.map(e=>r.jsx("option",{value:e.id,className:"bg-slate-900 text-white",children:e.name},e.id))]}),r.jsx("button",{onClick:()=>{0!==o.size&&x&&(o.forEach(e=>{const t=m.find(t=>t.id===e);t&&(t.groupId!==x||t.parentId)&&c(e,{groupId:x,parentId:void 0})}),setTimeout(()=>{h(),p()},100),n(new Set),s())},disabled:!x||0===o.size,className:"px-4 py-2 rounded-xl bg-white text-slate-900 text-xs font-medium transition-colors disabled:opacity-40",children:"移动"})]})]})}),r.jsx(mr,{isOpen:f,title:"删除确认",message:`确定要删除选中的 ${o.size} 个快捷方式吗？此操作不可恢复。`,confirmText:"删除",cancelText:"取消",confirmVariant:"danger",onConfirm:()=>{o.forEach(e=>l(e)),n(new Set),w(!1)},onCancel:()=>w(!1)})]}),document.body)}const rs="tmarks_batch_edit_tip_dismissed";function ss({isOpen:t,onClose:s}){const[o,n]=e.useState(!1),[a,i]=e.useState(!1);e.useEffect(()=>{if(t){const e=localStorage.getItem(rs);i("true"!==e)}},[t]);const l=()=>{o&&localStorage.setItem(rs,"true"),s()};return t&&a?B.createPortal(r.jsx("div",{className:"fixed inset-0 flex items-center justify-center bg-black/50 backdrop-blur-sm animate-fadeIn",style:{zIndex:Ft},onClick:l,children:r.jsxs("div",{className:"relative w-[min(420px,calc(100vw-32px))] rounded-2xl glass-dark p-6 shadow-2xl",style:{backdropFilter:"blur(20px) saturate(180%)",WebkitBackdropFilter:"blur(20px) saturate(180%)",border:"1px solid rgba(255,255,255,0.15)"},onClick:e=>e.stopPropagation(),children:[r.jsx("button",{onClick:l,className:"absolute top-4 right-4 p-1.5 rounded-full hover:bg-white/10 transition-colors",children:r.jsx(y,{className:"w-4 h-4 text-white/60"})}),r.jsxs("div",{className:"flex items-center gap-3 mb-4",children:[r.jsx("div",{className:"p-2.5 rounded-xl bg-blue-500/20",children:r.jsx(me,{className:"w-5 h-5 text-blue-400"})}),r.jsx("h3",{className:"text-lg font-semibold text-white",children:"批量编辑模式"})]}),r.jsxs("div",{className:"space-y-3 text-sm text-white/80",children:[r.jsxs("div",{className:"flex items-start gap-3 p-3 rounded-xl bg-white/5",children:[r.jsx("span",{className:"flex-shrink-0 w-6 h-6 rounded-full bg-blue-500/30 text-blue-300 flex items-center justify-center text-xs font-medium",children:"1"}),r.jsxs("div",{children:[r.jsx("p",{className:"font-medium text-white/90",children:"单击"}),r.jsx("p",{className:"text-white/60 text-xs mt-0.5",children:"选择/取消选择项目"})]})]}),r.jsxs("div",{className:"flex items-start gap-3 p-3 rounded-xl bg-white/5",children:[r.jsx("span",{className:"flex-shrink-0 w-6 h-6 rounded-full bg-purple-500/30 text-purple-300 flex items-center justify-center text-xs font-medium",children:"2"}),r.jsxs("div",{children:[r.jsx("p",{className:"font-medium text-white/90",children:"双击文件夹"}),r.jsx("p",{className:"text-white/60 text-xs mt-0.5",children:"进入文件夹查看内容"})]})]}),r.jsxs("div",{className:"flex items-start gap-3 p-3 rounded-xl bg-white/5",children:[r.jsx("span",{className:"flex-shrink-0 w-6 h-6 rounded-full bg-amber-500/30 text-amber-300 flex items-center justify-center text-xs font-medium",children:"!"}),r.jsxs("div",{children:[r.jsx("p",{className:"font-medium text-white/90",children:"空文件夹自动删除"}),r.jsx("p",{className:"text-white/60 text-xs mt-0.5",children:"移出所有内容后，文件夹会自动删除（首页除外）"})]})]})]}),r.jsx("div",{className:"mt-5 pt-4 border-t border-white/10",children:r.jsxs("label",{className:"flex items-center gap-2 cursor-pointer select-none",children:[r.jsx("input",{type:"checkbox",checked:o,onChange:e=>n(e.target.checked),className:"w-4 h-4 rounded border-white/30 bg-white/10 text-blue-500 focus:ring-blue-500/50"}),r.jsx("span",{className:"text-xs text-white/60",children:"下次不再显示"})]})}),r.jsx("button",{onClick:l,className:"mt-4 w-full py-2.5 rounded-xl bg-white/10 hover:bg-white/20 text-white text-sm font-medium transition-colors",children:"知道了"})]})}),document.body):null}function os({x:t,y:s,items:o,onClose:n}){const a=e.useRef(null);return e.useEffect(()=>{const e=e=>{a.current&&!a.current.contains(e.target)&&n()},t=e=>{"Escape"===e.key&&n()};return document.addEventListener("mousedown",e),document.addEventListener("keydown",t),document.addEventListener("contextmenu",n),()=>{document.removeEventListener("mousedown",e),document.removeEventListener("keydown",t),document.removeEventListener("contextmenu",n)}},[n]),e.useEffect(()=>{if(a.current){const e=a.current.getBoundingClientRect(),r=t+e.width>window.innerWidth?window.innerWidth-e.width-10:t,o=s+e.height>window.innerHeight?window.innerHeight-e.height-10:s;a.current.style.left=`${r}px`,a.current.style.top=`${o}px`}},[t,s]),B.createPortal(r.jsx("div",{ref:a,className:"fixed z-[9999] min-w-[180px] rounded-2xl glass-dark border border-white/10 shadow-xl py-2 animate-fadeIn overflow-hidden",style:{left:t,top:s},children:o.map((e,t)=>r.jsxs("div",{children:[r.jsxs("button",{onClick:()=>{e.onClick(),n()},className:`\n              w-full flex items-center gap-3 px-4 py-2 text-sm transition-colors\n              ${e.danger?"text-red-400 hover:bg-red-500/20":"text-white/80 hover:bg-white/10"}\n            `,children:[r.jsx("span",{className:"w-4 h-4 flex-shrink-0",children:e.icon}),r.jsx("span",{children:e.label})]}),e.divider&&r.jsx("div",{className:"h-px bg-white/10 my-1"})]},t))}),document.body)}function ns(){const{settings:t,isLoading:s,loadData:o,updateSettings:n,shortcutGroups:a,activeGroupId:i,setActiveGroup:l,addGridItem:c}=gt(),[d,u]=e.useState(!1),[m,h]=e.useState(!1),[p,x]=e.useState(!1),[g,f]=e.useState(!1),[w,b]=e.useState(!1),[v,y]=e.useState(new Set),[j,I]=e.useState(null),[N,C]=e.useState(!1),S=e.useRef(),B=e.useRef(!1),F=e.useRef(null),D=e.useRef(null),E=e.useRef({shortcutGroups:a,activeGroupId:i,setActiveGroup:l});E.current={shortcutGroups:a,activeGroupId:i,setActiveGroup:l},pt(),e.useEffect(()=>{o()},[o]);const G=e.useCallback(e=>{const{shortcutGroups:t,activeGroupId:r,setActiveGroup:s}=E.current;if(B.current)return;const o=e.target.closest(".overflow-y-auto, .overflow-auto");if(o){const{scrollTop:t,scrollHeight:r,clientHeight:s}=o;if(r>s){if(e.deltaY<0&&t>0)return;if(e.deltaY>0&&t+s<r)return}}const n=e.clientX,a=window.innerWidth;if(n>=.3*a&&n<=.7*a)return;const i=t.map(e=>e.id);if(0===i.length)return;const l=i.indexOf(r||"");if(-1===l)return void s(i[0]);let c=l;e.deltaY>0?c=Math.min(l+1,i.length-1):e.deltaY<0&&(c=Math.max(l-1,0)),c!==l&&(e.preventDefault(),s(i[c]),B.current=!0,S.current&&clearTimeout(S.current),S.current=setTimeout(()=>{B.current=!1},300))},[]),T=e.useCallback(e=>{const t=e.target,r=t.closest('[role="dialog"]')||t.closest(".glass-modal")||t.closest(".glass-modal-dark"),s="INPUT"===t.tagName||"TEXTAREA"===t.tagName;r||s||(e.preventDefault(),I({x:e.clientX,y:e.clientY}))},[]),z=e.useCallback(()=>{F.current&&(window.clearTimeout(F.current),F.current=null),D.current=null},[]),L=e.useCallback(e=>{if(0!==e.button)return;const t=e.target,r=t.closest('[role="dialog"]')||t.closest(".glass-modal")||t.closest(".glass-modal-dark"),s=t.closest("button")||t.closest("a")||t.closest("input")||t.closest("textarea"),o=t.closest("[data-shortcut-item]");r||s||o||(z(),D.current={x:e.clientX,y:e.clientY},F.current=window.setTimeout(()=>{C(e=>!e),z()},2e3))},[z]),A=e.useCallback(e=>{if(!D.current)return;const t=e.clientX-D.current.x,r=e.clientY-D.current.y;Math.hypot(t,r)>10&&z()},[z]),M=e.useCallback(()=>{z()},[z]);e.useEffect(()=>{if(t.showShortcuts)return window.addEventListener("wheel",G,{passive:!1}),()=>{window.removeEventListener("wheel",G),S.current&&clearTimeout(S.current)}},[G,t.showShortcuts]),e.useEffect(()=>(window.addEventListener("contextmenu",T),()=>{window.removeEventListener("contextmenu",T)}),[T]);const R=e.useCallback(()=>{},[]);return s?r.jsx("div",{className:"w-full h-full flex items-center justify-center bg-[#1a1a2e]",children:r.jsx("div",{className:"w-8 h-8 border-2 border-white/30 border-t-white rounded-full animate-spin"})}):r.jsxs("div",{className:"relative w-full h-full overflow-hidden",onPointerDown:L,onPointerMove:A,onPointerUp:M,onPointerLeave:M,children:[r.jsx(jr,{config:t.wallpaper,onRefresh:R}),r.jsxs("div",{className:"relative z-10 w-full h-full flex flex-col items-center px-4 pt-[12vh] pb-8 overflow-y-auto",children:[t.showGreeting&&r.jsx("div",{className:"mb-1 animate-fadeIn",children:r.jsx(Sr,{userName:t.userName})}),t.showClock&&r.jsx("div",{className:"mb-3 animate-fadeIn",children:r.jsx(ft,{format:t.clockFormat,showDate:t.showDate,showSeconds:t.showSeconds,showLunar:t.showLunar})}),!t.showClock&&t.showLunar&&r.jsx("div",{className:"mb-3 animate-fadeIn",children:r.jsx(Br,{})}),t.showPoetry&&r.jsx("div",{className:"mb-6 animate-fadeIn",children:r.jsx(Dr,{})}),t.showSearch&&r.jsx("div",{className:"w-full max-w-2xl mb-6 animate-fadeIn px-4 relative z-50",children:r.jsx(Bt,{engine:t.searchEngine,enableSuggestions:t.enableSearchSuggestions,onEngineChange:e=>n({searchEngine:e})})}),t.showShortcuts&&r.jsx("div",{className:"w-full max-w-5xl animate-fadeIn px-4 shortcut-area",children:r.jsx("div",{className:"flex items-start gap-4",children:r.jsx(kr,{columns:t.shortcutColumns,isBatchMode:g,batchSelectedIds:v,onBatchSelectedIdsChange:y,isEditing:N,onEditingChange:C})})})]}),r.jsx(Tr,{onOpenSettings:()=>u(!0)}),t.showPinnedBookmarks&&r.jsx(Cr,{}),d&&r.jsx(Qr,{onClose:()=>u(!1)}),m&&r.jsx(Zr,{isOpen:m,onClose:()=>h(!1),onAdd:(e,t)=>{const r=new URL(e).hostname;c("shortcut",{groupId:i||void 0,shortcut:{url:e,title:t,favicon:`${ve}${r}&sz=64`}})},groupName:i?a.find(e=>e.id===i)?.name:void 0}),r.jsx(ts,{isOpen:g,onClose:()=>{f(!1),y(new Set)},selectedIds:v,onSelectedIdsChange:y}),r.jsx(ss,{isOpen:w,onClose:()=>b(!1)}),r.jsx(es,{isOpen:p,onClose:()=>x(!1),onSave:e=>c("bookmarkFolder",{groupId:i??void 0,bookmarkFolder:{title:e}})}),j&&r.jsx(os,{x:j.x,y:j.y,items:[{label:"添加快捷方式",icon:r.jsx(k,{className:"w-4 h-4"}),onClick:()=>h(!0)},{label:"添加文件夹",icon:r.jsx(he,{className:"w-4 h-4"}),onClick:()=>x(!0)},{label:"批量编辑",icon:r.jsx(pe,{className:"w-4 h-4"}),onClick:()=>{y(new Set),f(!0),b(!0)},divider:!0}],onClose:()=>I(null)})]})}const as=document.getElementById("root");as&&xe.createRoot(as).render(r.jsx(ge.StrictMode,{children:r.jsx(ns,{})}));
