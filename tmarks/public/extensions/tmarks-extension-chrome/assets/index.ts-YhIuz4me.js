import{_ as t}from"./preload-helper-BhLMWRjL.js";function e(t,e){if(!t||"string"!=typeof t)return"";try{if(!(t=t.trim()))return"";const n=new URL(t,e||window.location.href);return"http:"!==n.protocol&&"https:"!==n.protocol?"":n.href}catch(n){return""}}chrome.runtime.onMessage.addListener(t=>{"TMARKS_WEB_DATA_CHANGED"===t?.type&&window.dispatchEvent(new CustomEvent("tmarks:data-changed"))});const n=new class{extract(){const t=this.getAllThumbnails();return{title:this.getTitle(),url:window.location.href,description:this.getDescription(),content:this.getMainContent(),thumbnail:t[0]||"",thumbnails:t,favicon:this.getFavicon()}}getTitle(){return document.title||this.getMeta("og:title")||document.querySelector("h1")?.textContent?.trim()||"Untitled"}getDescription(){return this.getMeta("description")||this.getMeta("og:description")||this.getMeta("twitter:description")||""}getMainContent(){const t=document.querySelector("article")||document.querySelector("main")||document.querySelector('[role="main"]')||document.body;if(!t)return"";const e=t.cloneNode(!0);e.querySelectorAll("script, style, nav, header, footer, iframe, noscript").forEach(t=>t.remove());return(e.textContent||"").replace(/\s+/g," ").trim().substring(0,1e3)}getFavicon(){try{const t=Array.from(document.querySelectorAll('link[rel="apple-touch-icon"]'));if(t.length>0){let n,r=0;for(const e of t)if(e.href){const t=e.getAttribute("sizes");if(t){const o=parseInt(t.split("x")[0]);!isNaN(o)&&o>r&&(r=o,n=e)}else n||(n=e)}if(n&&n.href){const t=e(n.href);if(t)return t}}}catch(t){}try{const t=Array.from(document.querySelectorAll('link[rel*="icon"]'));if(t.length>0){let n,r=0;for(const e of t)if(e.href){const t=e.getAttribute("type")||"",o=e.getAttribute("sizes"),i=e.href.toLowerCase();if(t.includes("svg")||i.endsWith(".svg")){n=e;break}if(t.includes("png")||i.endsWith(".png"))if(o){const t=parseInt(o.split("x")[0]);!isNaN(t)&&t>r&&(r=t,n=e)}else n&&0!==r||(n=e);n||(n=e)}if(n&&n.href){const t=e(n.href);if(t)return t}}}catch(t){}try{return`chrome://favicon/size/64@2x/${window.location.origin}`}catch(t){}try{return new URL("/favicon.ico",window.location.origin).href}catch(t){}return""}getAllThumbnails(){const t=[];try{const n=document.querySelector('meta[property="og:image"]');if(n instanceof HTMLMetaElement&&n.content){const r=e(n.content);r&&!t.includes(r)&&t.push(r)}}catch(n){}try{const n=document.querySelector('meta[name="twitter:image"]');if(n instanceof HTMLMetaElement&&n.content){const r=e(n.content);r&&!t.includes(r)&&t.push(r)}}catch(n){}try{const n=[document.querySelector("main"),document.querySelector('[role="main"]'),document.querySelector("article"),document.body].filter(Boolean),o=[];for(const t of n){if(!t)continue;const n=t.querySelectorAll("img");for(const t of n)try{if(!t.src)continue;if(t.src.startsWith("data:")||t.src.startsWith("blob:"))continue;let n=t.naturalWidth,r=t.naturalHeight;if(0===n||0===r){const e=t.getAttribute("width"),o=t.getAttribute("height");if(e&&o){const t=parseInt(e),i=parseInt(o);isNaN(t)||isNaN(i)||(n=t,r=i)}0!==n&&0!==r||(n=t.width||t.offsetWidth||t.clientWidth,r=t.height||t.offsetHeight||t.clientHeight)}if(n>200&&r>200&&n<5e3&&r<5e3){const i=e(t.src);i&&!o.some(t=>t.url===i)&&o.push({url:i,area:n*r})}}catch(r){continue}}o.sort((t,e)=>e.area-t.area);const i=o.slice(0,5);for(const{url:e}of i)t.includes(e)||t.push(e)}catch(n){}return t}getMeta(t){const e=document.querySelector(`meta[name="${t}"]`)||document.querySelector(`meta[property="${t}"]`);return e?.getAttribute("content")||""}};window.__AITMARKS_CONTENT_SCRIPT_LOADED__||(window.__AITMARKS_CONTENT_SCRIPT_LOADED__=!0,chrome.runtime.onMessage.addListener((e,r,o)=>{if("PING"===e.type){try{o({success:!0,data:"pong"})}catch(i){}return!0}return"EXTRACT_PAGE_INFO"===e.type?((async()=>{try{"loading"===document.readyState&&await new Promise(t=>{"loading"===document.readyState?document.addEventListener("DOMContentLoaded",t,{once:!0}):t(null)});const t=n.extract();t.url||(t.url=window.location.href),t.title||(t.title=document.title||"Untitled"),o({success:!0,data:t})}catch(i){o({success:!0,data:{title:document.title||"Untitled",url:window.location.href,description:"",content:"",thumbnail:""}})}})(),!0):"CAPTURE_PAGE"===e.type?((async()=>{try{const{capturePage:n}=await t(async()=>{const{capturePage:t}=await import("./singlefile-capture-Bkt_j5oF.js");return{capturePage:t}},[]),r=await n(e.options||{}),i=new Blob([r]).size;o({success:!0,html:r,size:i})}catch(i){o({success:!1,error:i instanceof Error?i.message:"Unknown error"})}})(),!0):"CAPTURE_PAGE_V2"===e.type&&((async()=>{try{const{capturePageV2:n}=await t(async()=>{const{capturePageV2:t}=await import("./singlefile-capture-v2-DXdSZKa8.js");return{capturePageV2:t}},[]),r=await n(e.options||{}),i=await Promise.all(r.images.map(async t=>{const e=new FileReader,n=await new Promise((n,r)=>{e.onloadend=()=>n(e.result),e.onerror=r,e.readAsDataURL(t.blob)});return{hash:t.hash,data:n,type:t.blob.type,size:t.blob.size}}));o({success:!0,data:{html:r.html,images:i}})}catch(i){o({success:!1,error:i instanceof Error?i.message:"Unknown error"})}})(),!0)}));
