import{d as t}from"./index-NQ3jknxk.js";import{c as e}from"./index-3rMDm5L8.js";import{n as r,E as a}from"./urls-DUfIfy6Z.js";async function i(){return new Promise(t=>{chrome.tabs.query({currentWindow:!0},e=>{t(e)})})}async function s(t){return new Promise(e=>{chrome.tabs.remove(t,()=>{e()})})}function n(t){if(!t||"string"!=typeof t)return"";try{const e=new URL(t);return`${a.GOOGLE_FAVICON}?domain=${e.hostname}&sz=32`}catch(e){return""}}async function o(a,s,o){try{let l=(await i()).filter(t=>t.url&&!t.url.startsWith("chrome://")&&!t.url.startsWith("chrome-extension://"));if(s&&s.size>0&&(l=l.filter(t=>t.id&&s.has(t.id))),0===l.length)return{success:!1,error:"当前窗口没有可收纳的标签页"};const d=l.map(t=>({title:t.title||"Untitled",url:t.url,favicon:n(t.url)}));try{const i=e({baseUrl:r(a.apiUrl),apiKey:a.apiKey}),s=o?.mode||"new";if("existing"===s&&o?.targetId)return await i.tabGroups.addItemsToGroup(o.targetId,{items:d}),{success:!0,groupId:o.targetId,message:`成功添加 ${l.length} 个标签页到现有分组`};{const e={title:o?.title,parent_id:"folder"===s?o?.targetId:null,items:d},r=await u(e),a=await i.tabGroups.createTabGroup(e);await t.tabGroups.update(r,{remoteId:a.data.tab_group.id});const n="folder"===s?"到文件夹":"";return{success:!0,groupId:a.data.tab_group.id,message:`成功收纳 ${l.length} 个标签页${n}`}}}catch(c){const t=o?.mode||"new",e=c?.code||"",r=c?.status||0,a=c?.message||"",i="INVALID_API_KEY"===e||"MISSING_API_KEY"===e||"INSUFFICIENT_PERMISSIONS"===e||401===r||403===r||a.includes("认证")||a.includes("API Key");if(("NETWORK_ERROR"===e||0===r)&&!i&&(a.includes("Network")||a.includes("网络")||a.includes("connect"))&&"existing"!==t){const e={title:o?.title,parent_id:"folder"===t?o?.targetId:null,items:d};return{success:!0,groupId:(await u(e)).toString(),offline:!0,message:`网络不可用，已离线保存 ${l.length} 个标签页，将在网络恢复后自动同步`}}let s;return s=401===r||"INVALID_API_KEY"===e||"MISSING_API_KEY"===e?"认证失败：API Key 无效或已过期，请在设置中检查您的 TMarks API Key":403===r||"INSUFFICIENT_PERMISSIONS"===e?"权限不足：您的 API Key 没有保存收纳的权限":429===r||"RATE_LIMIT_EXCEEDED"===e?"请求过于频繁，请稍后再试":r>=500?"TMarks 服务器错误，请稍后再试":a||"保存收纳失败",{success:!1,error:s}}}catch(c){return{success:!1,error:c instanceof Error?c.message:"收纳标签页失败"}}}async function u(e){const r=Date.now(),a=e.title||(new Date).toLocaleString("zh-CN",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit",hour12:!1}).replace(/\//g,"-"),i=await t.tabGroups.add({title:a,createdAt:r}),s=e.items.map((t,e)=>({groupId:i,title:t.title,url:t.url,favicon:t.favicon,position:e,createdAt:r}));return await t.tabGroupItems.bulkAdd(s),i}async function c(a){try{const s=await t.tabGroups.filter(t=>!t.remoteId).toArray();if(0===s.length)return 0;const n=e({baseUrl:r(a.apiUrl),apiKey:a.apiKey});let o=0;for(const e of s)try{const r=await t.tabGroupItems.where("groupId").equals(e.id).sortBy("position");if(0===r.length)continue;const a=await n.tabGroups.createTabGroup({title:e.title,items:r.map(t=>({title:t.title,url:t.url,favicon:t.favicon}))});await t.tabGroups.update(e.id,{remoteId:a.data.tab_group.id}),o++}catch(i){}return o}catch(i){return 0}}export{s as a,o as c,i as g,c as s};
