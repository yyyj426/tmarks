const t={inlineCSS:!0,extractImages:!0,inlineFonts:!1,removeScripts:!0,removeHiddenElements:!1,maxImageSize:10485760,timeout:3e4};async function e(e={}){const n={...t,...e};try{const t=document.cloneNode(!0),e=[];if(n.inlineCSS&&await async function(t,e){const n=Array.from(t.querySelectorAll('link[rel="stylesheet"]')),o=Date.now();for(const a of n){if(Date.now()-o>e)break;try{const e=a.href;if(!e||e.startsWith("data:"))continue;const n=await fetch(e);if(!n.ok)continue;const o=await n.text(),s=await r(o,e),c=t.createElement("style");c.setAttribute("data-original-href",e),c.textContent=s,a.replaceWith(c)}catch(s){}}}(t,n.timeout),n.extractImages){const r=await async function(t,e,r){const n=Date.now(),o=[],s=new Map,a=async t=>{if(!t||t.startsWith("data:"))return null;if(s.has(t))return s.get(t);try{const e=await fetch(t);if(!e.ok)return null;const r=await e.blob(),n=await async function(t){const e=await t.arrayBuffer(),r=await crypto.subtle.digest("SHA-256",e);return Array.from(new Uint8Array(r)).map(t=>t.toString(16).padStart(2,"0")).join("").substring(0,16)}(r);return o.push({originalUrl:t,blob:r,hash:n,element:null}),s.set(t,n),n}catch(e){return null}},c=Array.from(t.querySelectorAll("img[src]"));for(const h of c){if(Date.now()-n>r)break;const t=h.src,e=await a(t);e&&(h.src=`/api/snapshot-images/${e}`,h.setAttribute("data-original-src",t))}const i=Array.from(t.querySelectorAll("img[srcset]"));for(const h of i){if(Date.now()-n>r)break;const t=h.srcset;if(!t)continue;const e=t.split(",").map(t=>t.trim()),o=[];for(const r of e){const[t,e]=r.split(/\s+/),n=await a(t);n?o.push(`/api/snapshot-images/${n} ${e||""}`.trim()):o.push(r)}o.length>0&&(h.srcset=o.join(", "))}const l=Array.from(t.querySelectorAll("picture source[srcset]"));for(const h of l){if(Date.now()-n>r)break;const t=h.srcset;if(!t)continue;const e=t.split(",").map(t=>t.trim()),o=[];for(const r of e){const[t,e]=r.split(/\s+/),n=await a(t);n?o.push(`/api/snapshot-images/${n} ${e||""}`.trim()):o.push(r)}o.length>0&&(h.srcset=o.join(", "))}const f=Array.from(t.querySelectorAll("video[poster]"));for(const h of f){if(Date.now()-n>r)break;const t=h.poster,e=await a(t);e&&(h.poster=`/api/snapshot-images/${e}`)}const u=Array.from(t.querySelectorAll('[style*="background"]'));for(const h of u){if(Date.now()-n>r)break;const t=h.style.cssText;if(!t)continue;const e=t.matchAll(/url\(['"]?([^'")\s]+)['"]?\)/g);let o=t;for(const r of e){const t=r[1];if(!t.startsWith("data:"))try{const e=new URL(t,document.baseURI).href,n=await a(e);n&&(o=o.replace(r[0],`url(/api/snapshot-images/${n})`))}catch(m){}}o!==t&&(h.style.cssText=o)}return o}(t,n.maxImageSize,n.timeout);e.push(...r)}n.inlineFonts&&await async function(){}(0,n.timeout),n.removeScripts&&function(t){const e=Array.from(t.querySelectorAll("script"));e.forEach(t=>t.remove())}(t),n.removeHiddenElements,function(t){const e=t.createElement("meta");e.setAttribute("name","tmarks-snapshot-v2"),e.setAttribute("content",JSON.stringify({capturedAt:(new Date).toISOString(),originalUrl:document.location.href,title:document.title,version:2}));const r=t.querySelector("head");r&&r.appendChild(e)}(t);return{html:t.documentElement.outerHTML,images:e}}catch(o){throw o}}async function r(t,e){const r=Array.from(t.matchAll(/url\(['"]?([^'")\s]+)['"]?\)/g));let n=t;for(const s of r){const t=s[1];if(!t.startsWith("data:"))try{const r=new URL(t,e).href;n=n.replace(s[0],`url(${r})`)}catch(o){}}return n}export{e as capturePageV2};
